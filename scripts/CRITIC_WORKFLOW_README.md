# Critic + Coding Expert Workflow\n\nAutomated code quality analysis and fix proposal system for DebVisor.\n\n## Overview\n\nThis system uses two agents working in sequence:\n\n1. **Critic Agent** (`critic_agent.py`): Detects code issues using multiple linters and analyzers\n1. **Coding Expert Agent** (`coding_expert_agent.py`): Reads issue reports and proposes fixes\n1. **Workflow Driver** (`critic_workflow.py`): Orchestrates both agents\n\n## How It Works\n\n### Phase 1: Critic Agent\n\nThe Critic Agent scans all code files and generates markdown reports.\n\n**Supported Extensions:** `.py`, `.sh`, `.js`, `.css`, `.html`, `.go`\n\n**Tools per Extension:**\n\n| Extension | Tools |\n|-----------|-------|\n| `.py` | flake8, mypy, bandit |\n| `.sh` | shellcheck, bandit |\n| `.js` | eslint |\n| `.css` | stylelint |\n| `.html` | htmlhint |\n| `.go` | golangci-lint |\n\n**Output Format:**\n\nFor each code file, a sibling `.md` file is created with issues:\n\n```text\nopt/ansible/__init__.py  →  opt/ansible/__init__.py.md\n\n```text\n\n**Report Structure:**\n\n```markdown\n# Code Issues Report: opt/ansible/__init__.py\nGenerated: 2025-12-13T10:30:45.123456\n\n## Issues Summary\nTotal: 5 issues found\n\n| Line | Column | Tool | Code | Severity | Message |\n|------|--------|------|------|----------|---------|\n| 42 | 0 | flake8 | E501 | WARNING | line too long (105 > 100 characters) |\n| 15 | 8 | mypy | name-defined | ERROR | Name 'x' is not defined |\n| ... |\n\n## Implementation Status\nItems marked below as fixed:\n\n```text\n\n### Phase 2: Coding Expert Agent\n\nReads all `.md` issue reports and generates detailed fix proposals.\n\n**Output:**\n\nEnhances the `.md` file with:\n\n```markdown\n## Fix Proposals\n\n### Issue at Line 42\n**Tool:** flake8 | **Code:** `E501` | **Severity:** WARNING\n**Message:** line too long (105 > 100 characters)\n**Context:**\n\n```python\ndef some_function():\n    very_long_line_that_exceeds_the_maximum_line_length_limit(arg1, arg2, arg3)\n\n```text\n\n**Proposal:**\n\n- Break line into multiple parts\n- Use backslash or implicit line continuation\n- Refactor to shorter variable/function names\n\n---\n\n## Implementation Progress\n\nTo mark an issue as fixed, add the issue code to the line below with a ✅ emoji:\n**Fixed Issues:** ✅ `E501`\n\n## Usage\n\n### Run Full Workflow\n\n```bash\npython3 scripts/critic_workflow.py\n\n```text\n\nThis runs:\n\n1. Critic Agent (detects issues)\n1. Coding Expert Agent (proposes fixes)\n\n### Run Individual Agents\n\n```bash\n\n## Just analyze code\n\npython3 scripts/critic_agent.py\n\n## Just generate proposals from existing reports\n\npython3 scripts/coding_expert_agent.py\n\n```text\n\n## Workflow\n\n1. Critic Agent scans all code files\n1. Creates/overwrites .md reports for each file with issues\n1. Coding Expert Agent reads .md files\n1. Adds fix proposals to .md files\n1. Developer reviews proposals\n1. Developer implements fixes in source files\n1. Developer marks fixed issues in .md files (✅ emoji + code)\n1. Re-run workflow to detect new issues\n\n## File Naming Convention\n\n### Issue Report Files\n\n```text\nsource.py              →  source.py.md\nscripts/tool.sh        →  scripts/tool.sh.md\nopt/web/app.js         →  opt/web/app.js.md\nopt/web/style.css      →  opt/web/style.css.md\n\n```text\n\n### Report Structure\n\nEach `.md` file contains:\n\n- **Header**: Source file name and generation timestamp\n- **Issues Summary**: Table of all issues (line, column, tool, code, severity, message)\n- **Implementation Status**: Section to track fixed issues\n- **Fix Proposals**: Detailed proposals for each unimplemented issue (added by Coding Expert)\n- **Implementation Progress**: Checklist of fixed items\n\n## Issue Codes\n\n### Flake8 (Python)\n\n- `E501`: Line too long\n- `E302`: Expected 2 blank lines\n- `W291`: Trailing whitespace\n- [Full list]([https://www.flake8.org](https://www.flake8.org)/)\n\n### Mypy (Python Type Checking)\n\n- `name-defined`: Name is not defined\n- `type-error`: Type mismatch\n- `return-value`: Return type mismatch\n- [Full list]([https://mypy.readthedocs.io](https://mypy.readthedocs.io)/)\n\n### Shellcheck (Shell)\n\n- `SC2086`: Double quote to prevent globbing\n- `SC2181`: Check exit code of command\n- `SC1091`: Not following source\n- [Full list]([https://www.shellcheck.net](https://www.shellcheck.net)/)\n\n### ESLint (JavaScript)\n\n- `no-unused-vars`: Variable declared but never used\n- `no-undef`: Variable not defined\n- `semi`: Missing semicolon\n- [Full list]([https://eslint.org](https://eslint.org)/)\n\n## Integration with context.md & changelog.md\n\nWhen implementing fixes:\n\n1. Update [context.md](../context.md) with any architectural changes\n1. Log implementation progress in [changelog.md](../changelog.md)\n\nExample changelog entry:\n\n```markdown\n\n### Code Quality Improvements (December 13, 2025)\n\n| Issue | File | Code | Fix |\n|-------|------|------|-----|\n| Line too long | opt/ansible/**init**.py | E501 | Refactored function call |\n| Type error | opt/services/api.py | name-defined | Added import statement |\n\n```text\n\n## Limitations\n\n- Tools must be installed in your environment (see installation below)\n- Some analyzers require specific project configurations (e.g., eslint needs .eslintrc)\n- Cross-platform support depends on tool availability\n\n## Installation\n\n### Python Tools\n\n```bash\npip install flake8 mypy bandit\n\n```text\n\n### Shell Tools\n\n```bash\n\n## Ubuntu/Debian\n\nsudo apt-get install shellcheck\n\n## macOS\n\nbrew install shellcheck\n\n```text\n\n### JavaScript Tools\n\n```bash\nnpm install -g eslint stylelint\n\n```text\n\n### Go Tools\n\n```bash\ngo install github.com/golangci/golangci-lint/cmd/golangci-lint@latest\n\n```text\n\n### HTML/CSS Tools\n\n```bash\nnpm install -g htmlhint\n\n```text\n\n## Example Workflow\n\n```bash\n\n## 1. Run full analysis\n\n$ python3 scripts/critic_workflow.py\n\n[Critic] Found 150 code files to analyze...\n[Critic] Analyzing opt/ansible/**init**.py...\n  -> 5 issues found, wrote to opt/ansible/**init**.py.md\n[Critic] Analyzing opt/services/api.py...\n  -> 8 issues found, wrote to opt/services/api.py.md\n...\n[Critic] Analysis complete!\n\n[Coding Expert] Found 45 issue reports.\n[Coding Expert] Processing opt/ansible/**init**.py.md...\n  -> Generated proposals for 5 issues\n  -> Report updated: opt/ansible/**init**.py.md\n[Coding Expert] Processing opt/services/api.py.md...\n  -> Generated proposals for 8 issues\n  -> Report updated: opt/services/api.py.md\n...\n[Coding Expert] Ready for implementation. Review proposals above.\n\n## 2. Review generated .md files in your editor\n\n## 3. Implement fixes in source files\n\n## 4. Mark issues as fixed in corresponding .md files\n\n## Add ✅ emoji and code to "Fixed Issues" section\n\n## 5. Re-run workflow\n\n$ python3 scripts/critic_workflow.py\n\n```text\n\n## Extending the System\n\n### Add a New File Type\n\nEdit `scripts/critic_agent.py`:\n\n1. Add extension to `SUPPORTED_EXTENSIONS`\n1. Add tools to `TOOLS` dict\n1. Implement `analyze_<ext>()` method\n1. Call it from `analyze_file()`\n\n### Add a Custom Tool\n\nImplement an `analyze_<tool>()` method following the pattern:\n\n```python\ndef analyze_mytool(self, file_path: Path) -> List[Dict[str, Any]]:\n    """Run mytool on file."""\n    issues = []\n    try:\n        result = subprocess.run(\n            ['mytool', str(file_path), '--format=json'],\n            capture_output=True, text=True, timeout=10\n        )\n        if result.stdout:\n            for issue in json.loads(result.stdout):\n                issues.append({\n                    'line': issue['line'],\n                    'col': issue['column'],\n                    'code': issue['code'],\n                    'message': issue['message'],\n                    'severity': 'warning',\n                    'tool': 'mytool'\n                })\n    except (subprocess.TimeoutExpired, FileNotFoundError, json.JSONDecodeError):\n        pass\n    return issues\n\n```text\n\n## Troubleshooting\n\n### "Tool not found"\n\nEnsure the linter is installed:\n\n```bash\nwhich flake8      # Python\nwhich shellcheck  # Shell\nwhich eslint      # JavaScript\n\n```text\n\n### No Issues Generated\n\nEither:\n\n1. Code quality is perfect ✅\n1. Tools aren't installed\n1. Tool is timing out (increase `timeout` parameter)\n\n### Performance Issues\n\nThe workflow can be slow on large repos. Optimize by:\n\n- Increasing subprocess timeouts\n- Running on specific directories\n- Running tools in parallel\n\n## Contributing\n\nWhen adding new analysis tools or rules:\n\n1. Update this README\n1. Add tests to `tests/test_critic_agent.py`\n1. Update [context.md](../context.md)\n1. Add entry to [changelog.md](../changelog.md)\n\n---\n\n**Last Updated:** December 13, 2025\n
