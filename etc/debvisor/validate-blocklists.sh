#!/bin/bash
# Copyright (c) 2025 DebVisor contributors
# Licensed under the Apache License, Version 2.0 (the "License");
# you may not use this file except in compliance with the License.
# You may obtain a copy of the License at
#     http://www.apache.org/licenses/LICENSE-2.0
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.

#!/bin/bash
# Copyright (c) 2025 DebVisor contributors
# Licensed under the Apache License, Version 2.0 (the "License");
# you may not use this file except in compliance with the License.
# You may obtain a copy of the License at
#     http://www.apache.org/licenses/LICENSE-2.0
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.

#!/bin/bash
# Copyright (c) 2025 DebVisor contributors
# Licensed under the Apache License, Version 2.0 (the "License");
# you may not use this file except in compliance with the License.
# You may obtain a copy of the License at
#     http://www.apache.org/licenses/LICENSE-2.0
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.

#!/bin/bash
# Copyright (c) 2025 DebVisor contributors
# Licensed under the Apache License, Version 2.0 (the "License");
# you may not use this file except in compliance with the License.
# You may obtain a copy of the License at
#     http://www.apache.org/licenses/LICENSE-2.0
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.

#!/bin/bash
# Copyright (c) 2025 DebVisor contributors
# Licensed under the Apache License, Version 2.0 (the "License");
# you may not use this file except in compliance with the License.
# You may obtain a copy of the License at
#     http://www.apache.org/licenses/LICENSE-2.0
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.

#!/bin/bash
# Copyright (c) 2025 DebVisor contributors
# Licensed under the Apache License, Version 2.0 (the "License");
# you may not use this file except in compliance with the License.
# You may obtain a copy of the License at
#     http://www.apache.org/licenses/LICENSE-2.0
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.

#!/bin/bash
# Copyright (c) 2025 DebVisor contributors
# Licensed under the Apache License, Version 2.0 (the "License");
# you may not use this file except in compliance with the License.
# You may obtain a copy of the License at
#     http://www.apache.org/licenses/LICENSE-2.0
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.

#!/bin/bash
# Copyright (c) 2025 DebVisor contributors
# Licensed under the Apache License, Version 2.0 (the "License");
# you may not use this file except in compliance with the License.
# You may obtain a copy of the License at
#     http://www.apache.org/licenses/LICENSE-2.0
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.

#!/bin/bash
# Copyright (c) 2025 DebVisor contributors
# Licensed under the Apache License, Version 2.0 (the "License");
# you may not use this file except in compliance with the License.
# You may obtain a copy of the License at
#     http://www.apache.org/licenses/LICENSE-2.0
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.

#!/bin/bash
# Copyright (c) 2025 DebVisor contributors
# Licensed under the Apache License, Version 2.0 (the "License");
# you may not use this file except in compliance with the License.
# You may obtain a copy of the License at
#     http://www.apache.org/licenses/LICENSE-2.0
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.

#!/bin/bash
# Copyright (c) 2025 DebVisor contributors
# Licensed under the Apache License, Version 2.0 (the "License");
# you may not use this file except in compliance with the License.
# You may obtain a copy of the License at
#     http://www.apache.org/licenses/LICENSE-2.0
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.

#!/bin/bash
# Copyright (c) 2025 DebVisor contributors
# Licensed under the Apache License, Version 2.0 (the "License");
# you may not use this file except in compliance with the License.
# You may obtain a copy of the License at
#     http://www.apache.org/licenses/LICENSE-2.0
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.

#!/bin/bash
# Copyright (c) 2025 DebVisor contributors
# Licensed under the Apache License, Version 2.0 (the "License");
# you may not use this file except in compliance with the License.
# You may obtain a copy of the License at
#     http://www.apache.org/licenses/LICENSE-2.0
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.

#!/bin/bash
# Copyright (c) 2025 DebVisor contributors
# Licensed under the Apache License, Version 2.0 (the "License");
# you may not use this file except in compliance with the License.
# You may obtain a copy of the License at
#     http://www.apache.org/licenses/LICENSE-2.0
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.

#!/bin/bash
# Copyright (c) 2025 DebVisor contributors
# Licensed under the Apache License, Version 2.0 (the "License");
# you may not use this file except in compliance with the License.
# You may obtain a copy of the License at
#     http://www.apache.org/licenses/LICENSE-2.0
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.

#!/bin/bash
# Copyright (c) 2025 DebVisor contributors
# Licensed under the Apache License, Version 2.0 (the "License");
# you may not use this file except in compliance with the License.
# You may obtain a copy of the License at
#     http://www.apache.org/licenses/LICENSE-2.0
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.

#!/bin/bash
# Copyright (c) 2025 DebVisor contributors
# Licensed under the Apache License, Version 2.0 (the "License");
# you may not use this file except in compliance with the License.
# You may obtain a copy of the License at
#     http://www.apache.org/licenses/LICENSE-2.0
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.

#!/bin/bash
# Copyright (c) 2025 DebVisor contributors
# Licensed under the Apache License, Version 2.0 (the "License");
# you may not use this file except in compliance with the License.
# You may obtain a copy of the License at
#     http://www.apache.org/licenses/LICENSE-2.0
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.

#!/bin/bash
# Copyright (c) 2025 DebVisor contributors
# Licensed under the Apache License, Version 2.0 (the "License");
# you may not use this file except in compliance with the License.
# You may obtain a copy of the License at
#     http://www.apache.org/licenses/LICENSE-2.0
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.

#!/usr/bin/env bash
# Copyright (c) 2025 DebVisor contributors
# Licensed under the Apache License, Version 2.0 (the "License");
# you may not use this file except in compliance with the License.
# You may obtain a copy of the License at
#     http://www.apache.org/licenses/LICENSE-2.0
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.

# validate-blocklists.sh - Validate blocklist and whitelist files for correctness and safety
# Usage: ./validate-blocklists.sh [--blocklist FILE] [--whitelist FILE] [--check-overlaps] [--verbose] [--json]

set -euo pipefail

VERBOSE=false
CHECK_OVERLAPS=false
JSON_OUTPUT=false
BLOCKLIST_FILE=""
WHITELIST_FILE=""
EXIT_CODE=0

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m' # No Color

print_verbose() {
  if [[ "$VERBOSE" == "true" ]]; then
    echo "[INFO] $*" >&2
  fi
}

print_error() {
  echo -e "${RED}[ERROR]${NC} $*" >&2
}

print_warning() {
  echo -e "${YELLOW}[WARN]${NC} $*" >&2
}

print_success() {
  echo -e "${GREEN}[OK]${NC} $*" >&2
}

validate_cidr() {
  local cidr="$1"
  # Prefer python3, fallback to python, then PowerShell/.NET on Windows
  if command -v python3 >/dev/null 2>&1; then
    python3 -c "from ipaddress import ip_network; ip_network('$cidr', strict=False)" 2>/dev/null || return 1
  elif command -v python >/dev/null 2>&1; then
    python -c "from ipaddress import ip_network; ip_network('$cidr', strict=False)" 2>/dev/null || return 1
  elif command -v pwsh >/dev/null 2>&1; then
    pwsh -NoProfile -Command "try { [void][System.Net.IPAddress]::Parse(('$cidr').Split('/')[0]) } catch { exit 1 }" || return 1
  else
    print_error "No validator runtime found (python3/python/pwsh). Install Python 3 or PowerShell."
    return 1
  fi
}

validate_file() {
  local file="$1"
  local file_type="$2"
  local line_num=0
  local entry_count=0
  local error_count=0
  local duplicate_entries=()

  print_verbose "Validating $file_type: $file"

  if [[ ! -f "$file" ]]; then
    print_error "$file_type file not found: $file"
    return 1
  fi

  # Read file and validate each CIDR entry
  while IFS= read -r line; do
    ((line_num++))

    # Skip empty lines and comments
    [[ -z "$line" || "$line" =~ ^[[:space:]]*# ]] && continue

    # Extract CIDR entry (before inline comment if present)
    local entry=$(echo "$line" | sed 's/#.*//' | xargs)

    if [[ -z "$entry" ]]; then
      continue
    fi

    ((entry_count++))

    # Validate CIDR format
    if ! validate_cidr "$entry" 2>/dev/null; then
      print_error "$file_type:$line_num: Invalid CIDR format: $entry"
      ((error_count++))
      ((EXIT_CODE++))
    else
      print_verbose "$file_type:$line_num: Valid CIDR: $entry"
    fi

    # Check for duplicate entries
    if [[ " ${duplicate_entries[*]} " == *" $entry "* ]]; then
      print_warning "$file_type:$line_num: Duplicate entry: $entry"
    else
      duplicate_entries+=("$entry")
    fi
  done < "$file"

  print_verbose "$file_type: Validated $entry_count entries from $file"

  if [[ $error_count -gt 0 ]]; then
    print_error "$file_type: Found $error_count validation errors"
    return 1
  else
    print_success "$file_type: All $entry_count entries are valid"
    return 0
  fi
}

check_overlaps() {
  local blocklist="$1"
  local whitelist="$2"

  print_verbose "Checking for overlapping ranges..."

  # Extract all CIDR entries
  local block_entries=$(grep -v '^[[:space:]]*$' "$blocklist" | grep -v '^[[:space:]]*#' | sed 's/#.*//' | xargs || true)
  local white_entries=$(grep -v '^[[:space:]]*$' "$whitelist" | grep -v '^[[:space:]]*#' | sed 's/#.*//' | xargs || true)

  if command -v python3 >/dev/null 2>&1; then
  python3 << 'EOF'
import sys
from ipaddress import ip_network, collapse_addresses

try:
  block_cidrs = []
  white_cidrs = []

  # Parse blocklist
  if len(sys.argv) > 1:
    for cidr_str in sys.argv[1].split():
      try:
        block_cidrs.append(ip_network(cidr_str.strip(), strict=False))
      except ValueError as e:
        print(f"[ERROR] Invalid blocklist CIDR: {cidr_str}: {e}", file=sys.stderr)

  # Parse whitelist
  if len(sys.argv) > 2:
    for cidr_str in sys.argv[2].split():
      try:
        white_cidrs.append(ip_network(cidr_str.strip(), strict=False))
      except ValueError as e:
        print(f"[ERROR] Invalid whitelist CIDR: {cidr_str}: {e}", file=sys.stderr)

  # Check for whitelist entries contained in blocklist
  overlaps_found = False
  for white_net in white_cidrs:
    for block_net in block_cidrs:
      if white_net.subnet_of(block_net):
        print(f"[WARN] Whitelist {white_net} is contained in blocklist {block_net}", file=sys.stderr)
        overlaps_found = True

  # Check for duplicates in blocklist
  unique_block = set(str(n) for n in collapse_addresses(block_cidrs))
  if len(unique_block) < len(block_cidrs):
    print(f"[WARN] Blocklist contains overlapping or duplicate ranges (can consolidate to {len(unique_block)} entries)", file=sys.stderr)

  if not overlaps_found and len(unique_block) == len(block_cidrs):
    print("[OK] No overlapping ranges detected", file=sys.stderr)
except Exception as e:
  print(f"[ERROR] Failed to check overlaps: {e}", file=sys.stderr)
  sys.exit(1)
EOF
  elif command -v python >/dev/null 2>&1; then
  python << 'EOF'
import sys
from ipaddress import ip_network, collapse_addresses

try:
  block_cidrs = []
  white_cidrs = []

  if len(sys.argv) > 1:
    for cidr_str in sys.argv[1].split():
      try:
        block_cidrs.append(ip_network(cidr_str.strip(), strict=False))
      except ValueError as e:
        print(f"[ERROR] Invalid blocklist CIDR: {cidr_str}: {e}", file=sys.stderr)

  if len(sys.argv) > 2:
    for cidr_str in sys.argv[2].split():
      try:
        white_cidrs.append(ip_network(cidr_str.strip(), strict=False))
      except ValueError as e:
        print(f"[ERROR] Invalid whitelist CIDR: {cidr_str}: {e}", file=sys.stderr)

  overlaps_found = False
  for white_net in white_cidrs:
    for block_net in block_cidrs:
      if white_net.subnet_of(block_net):
        print(f"[WARN] Whitelist {white_net} is contained in blocklist {block_net}", file=sys.stderr)
        overlaps_found = True

  unique_block = set(str(n) for n in collapse_addresses(block_cidrs))
  if len(unique_block) < len(block_cidrs):
    print(f"[WARN] Blocklist contains overlapping or duplicate ranges (can consolidate to {len(unique_block)} entries)", file=sys.stderr)

  if not overlaps_found and len(unique_block) == len(block_cidrs):
    print("[OK] No overlapping ranges detected", file=sys.stderr)
except Exception as e:
  print(f"[ERROR] Failed to check overlaps: {e}", file=sys.stderr)
  sys.exit(1)
EOF
  elif command -v pwsh >/dev/null 2>&1; then
  # PowerShell/.NET overlap check (simplified: only reports exact containment by prefix length)
  pwsh -NoProfile -Command "
    \$block = '$block_entries'.Split(' ')
    \$white = '$white_entries'.Split(' ')
    \$overlap = \$false
    foreach (\$w in \$white) {
    if (-not \$w) { continue }
    foreach (\$b in \$block) {
      if (-not \$b) { continue }
      # Basic check: if both CIDRs have same IP family and whitelist is contained in block by prefix
      \$wParts = \$w.Split('/')
      \$bParts = \$b.Split('/')
      if (\$wParts[0] -match ':' -and \$bParts[0] -match ':') {
      if ([System.Net.IPAddress]::Parse(\$wParts[0]) -and [System.Net.IPAddress]::Parse(\$bParts[0])) {
        if ([int]\$wParts[1] -ge [int]\$bParts[1]) { \$overlap = \$true; Write-Error \"[WARN] Whitelist \$w is contained in blocklist \$b\" }
      }
      } elseif (\$wParts[0] -notmatch ':' -and \$bParts[0] -notmatch ':') {
      if ([System.Net.IPAddress]::Parse(\$wParts[0]) -and [System.Net.IPAddress]::Parse(\$bParts[0])) {
        if ([int]\$wParts[1] -ge [int]\$bParts[1]) { \$overlap = \$true; Write-Error \"[WARN] Whitelist \$w is contained in blocklist \$b\" }
      }
      }
    }
    }
    if (-not \$overlap) { Write-Output \"[OK] No overlapping ranges detected\" }
  "
  else
  print_error "No runtime found for overlap check (python3/python/pwsh). Install Python 3 or PowerShell."
  return 1
  fi
}

usage() {
  cat <<EOF
Usage: $(basename "$0") [OPTIONS]

OPTIONS:
  --blocklist FILE       Path to blocklist file (default: etc/debvisor/blocklist-example.txt)
  --whitelist FILE       Path to whitelist file (default: etc/debvisor/blocklist-whitelist-example.txt)
  --check-overlaps       Check for overlapping ranges between lists
  --verbose              Print verbose output
  --json                 Output results as JSON
  --help                 Show this help message

EXAMPLES:
  # Validate default files
  $(basename "$0")

  # Validate specific file with overlap checking
  $(basename "$0") --blocklist custom-blocklist.txt --check-overlaps --verbose

  # JSON output for CI/CD integration
  $(basename "$0") --json

EOF
}

# Parse arguments
while [[ $# -gt 0 ]]; do
  case "$1" in
    --blocklist)
      BLOCKLIST_FILE="$2"
      shift 2
      ;;
    --whitelist)
      WHITELIST_FILE="$2"
      shift 2
      ;;
    --check-overlaps)
      CHECK_OVERLAPS=true
      shift
      ;;
    --verbose)
      VERBOSE=true
      shift
      ;;
    --json)
      JSON_OUTPUT=true
      shift
      ;;
    --help)
      usage
      exit 0
      ;;
    *)
      print_error "Unknown option: $1"
      usage
      exit 1
      ;;
  esac
done

# Set defaults
BLOCKLIST_FILE="${BLOCKLIST_FILE:-etc/debvisor/blocklist-example.txt}"
WHITELIST_FILE="${WHITELIST_FILE:-etc/debvisor/blocklist-whitelist-example.txt}"

# Validate files exist
if [[ ! -f "$BLOCKLIST_FILE" && ! -f "$WHITELIST_FILE" ]]; then
  print_error "Neither blocklist nor whitelist file found"
  usage
  exit 1
fi

# Validate files
if [[ -f "$BLOCKLIST_FILE" ]]; then
  validate_file "$BLOCKLIST_FILE" "Blocklist" || true
fi

if [[ -f "$WHITELIST_FILE" ]]; then
  validate_file "$WHITELIST_FILE" "Whitelist" || true
fi

# Check for overlaps if requested
if [[ "$CHECK_OVERLAPS" == "true" && -f "$BLOCKLIST_FILE" && -f "$WHITELIST_FILE" ]]; then
  check_overlaps "$BLOCKLIST_FILE" "$WHITELIST_FILE"
fi

if [[ $EXIT_CODE -eq 0 ]]; then
  print_success "All validations passed"
  exit 0
else
  print_error "Validation failed with $EXIT_CODE errors"
  exit 1
fi
