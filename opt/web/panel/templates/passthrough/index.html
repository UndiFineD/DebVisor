<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Hardware Passthrough - DebVisor</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/main.css') }}">
    <style>
        .status-badge {
            display: inline-block;
            padding: 2px 8px;
            border-radius: 4px;
            font-size: 0.85em;
            font-weight: 500;
        }
        .status-ready { background: #10b981; color: white; }
        .status-not-ready { background: #ef4444; color: white; }
        .status-isolated { background: #3b82f6; color: white; }
        .status-shared { background: #f59e0b; color: white; }
        .status-vfio { background: #8b5cf6; color: white; }

        .device-card {
            background: var(--card-bg, #1e293b);
            border: 1px solid var(--border-color, #334155);
            border-radius: 8px;
            padding: 16px;
            margin-bottom: 12px;
        }
        .device-card:hover {
            border-color: var(--primary, #3b82f6);
        }

        .device-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
        }

        .device-address {
            font-family: monospace;
            font-size: 0.9em;
            color: var(--text-muted, #94a3b8);
        }

        .device-name {
            font-weight: 600;
            font-size: 1.1em;
        }

        .device-meta {
            display: flex;
            gap: 16px;
            font-size: 0.85em;
            color: var(--text-muted, #94a3b8);
        }

        .iommu-group {
            background: var(--card-bg, #1e293b);
            border: 1px solid var(--border-color, #334155);
            border-radius: 8px;
            margin-bottom: 16px;
            overflow: hidden;
        }

        .iommu-group-header {
            background: var(--header-bg, #0f172a);
            padding: 12px 16px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .iommu-group-devices {
            padding: 12px 16px;
        }

        .recommendation {
            padding: 12px 16px;
            border-radius: 6px;
            margin-bottom: 8px;
        }
        .recommendation.error {
            background: #fef2f2;
            border: 1px solid #fecaca;
            color: #991b1b;
        }
        .recommendation.warning {
            background: #fefce8;
            border: 1px solid #fef08a;
            color: #854d0e;
        }

        .btn {
            padding: 8px 16px;
            border-radius: 6px;
            border: none;
            cursor: pointer;
            font-size: 0.9em;
            transition: all 0.2s;
        }
        .btn-primary {
            background: var(--primary, #3b82f6);
            color: white;
        }
        .btn-primary:hover {
            background: #2563eb;
        }
        .btn-danger {
            background: #ef4444;
            color: white;
        }
        .btn-danger:hover {
            background: #dc2626;
        }
        .btn-sm {
            padding: 4px 12px;
            font-size: 0.8em;
        }

        .section-title {
            font-size: 1.25em;
            font-weight: 600;
            margin-bottom: 16px;
            padding-bottom: 8px;
            border-bottom: 1px solid var(--border-color, #334155);
        }

        .summary-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 16px;
            margin-bottom: 24px;
        }

        .summary-card {
            background: var(--card-bg, #1e293b);
            border: 1px solid var(--border-color, #334155);
            border-radius: 8px;
            padding: 16px;
            text-align: center;
        }
        .summary-card .value {
            font-size: 2em;
            font-weight: 700;
            color: var(--primary, #3b82f6);
        }
        .summary-card .label {
            font-size: 0.85em;
            color: var(--text-muted, #94a3b8);
            margin-top: 4px;
        }

        .tabs {
            display: flex;
            gap: 8px;
            margin-bottom: 24px;
            border-bottom: 1px solid var(--border-color, #334155);
        }
        .tab {
            padding: 12px 20px;
            cursor: pointer;
            border-bottom: 2px solid transparent;
            transition: all 0.2s;
        }
        .tab:hover {
            background: var(--card-bg, #1e293b);
        }
        .tab.active {
            border-bottom-color: var(--primary, #3b82f6);
            color: var(--primary, #3b82f6);
        }

        .tab-content {
            display: none;
        }
        .tab-content.active {
            display: block;
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: var(--text-muted, #94a3b8);
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>[U+1F50C] Hardware Passthrough</h1>
            <p>Manage PCI/GPU passthrough assignments for VMs</p>
        </header>

        <!-- Status Summary -->
        <div id="status-section">
            <div class="loading">Loading status...</div>
        </div>

        <!-- Recommendations -->
        <div id="recommendations-section"></div>

        <!-- Summary Cards -->
        <div id="summary-section" class="summary-grid"></div>

        <!-- Tabs -->
        <div class="tabs">
            <div class="tab active" data-tab="gpus">GPUs</div>
            <div class="tab" data-tab="devices">All Devices</div>
            <div class="tab" data-tab="groups">IOMMU Groups</div>
            <div class="tab" data-tab="profiles">Profiles</div>
        </div>

        <!-- Tab Contents -->
        <div id="gpus" class="tab-content active">
            <h2 class="section-title">GPU Devices</h2>
            <div id="gpu-list" class="loading">Loading GPUs...</div>
        </div>

        <div id="devices" class="tab-content">
            <h2 class="section-title">All PCI Devices</h2>
            <div id="device-list" class="loading">Loading devices...</div>
        </div>

        <div id="groups" class="tab-content">
            <h2 class="section-title">IOMMU Groups</h2>
            <div id="group-list" class="loading">Loading groups...</div>
        </div>

        <div id="profiles" class="tab-content">
            <h2 class="section-title">Passthrough Profiles</h2>
            <div id="profile-list" class="loading">Loading profiles...</div>
        </div>
    </div>

    <script>
        // Tab switching
        document.querySelectorAll('.tab').forEach(tab => {
            tab.addEventListener('click', () => {
                document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
                document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
                tab.classList.add('active');
                document.getElementById(tab.dataset.tab).classList.add('active');
            });
        });

        // Safe error display helper
        function showError(elementId, error) {
            const errorDiv = document.createElement('div');
            errorDiv.className = 'recommendation error';
            errorDiv.textContent = 'Error: ' + String(error?.message || error);
            
            const target = document.getElementById(elementId);
            if (target) {
                target.innerHTML = '';
                target.appendChild(errorDiv);
            }
        }

        // Load status
        async function loadStatus() {
            try {
                const resp = await fetch('/passthrough/api/status');
                const data = await resp.json();

                const statusHtml = `
                    <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 16px;">
                        <span class="status-badge status-${data.status}">
                            ${data.status === 'ready' ? '? Ready' : '? Not Ready'}
                        </span>
                        <span>IOMMU: ${data.summary.iommu_enabled ? 'Enabled' : 'Disabled'}</span>
                    </div>
                `;
                document.getElementById('status-section').innerHTML = statusHtml;

                // Recommendations
                if (data.recommendations && data.recommendations.length > 0) {
                    const recsHtml = data.recommendations.map(r => `
                        <div class="recommendation ${r.severity}">${r.message}</div>
                    `).join('');
                    document.getElementById('recommendations-section').innerHTML = recsHtml;
                }

                // Summary cards
                const summary = data.summary;
                document.getElementById('summary-section').innerHTML = `
                    <div class="summary-card">
                        <div class="value">${summary.total_devices}</div>
                        <div class="label">Total Devices</div>
                    </div>
                    <div class="summary-card">
                        <div class="value">${summary.gpus}</div>
                        <div class="label">GPUs</div>
                    </div>
                    <div class="summary-card">
                        <div class="value">${summary.iommu_groups}</div>
                        <div class="label">IOMMU Groups</div>
                    </div>
                    <div class="summary-card">
                        <div class="value">${summary.isolated_groups}</div>
                        <div class="label">Isolated Groups</div>
                    </div>
                `;
            } catch (e) {
                showError('status-section', e);
            }
        }

        // Load GPUs
        async function loadGPUs() {
            try {
                const resp = await fetch('/passthrough/api/gpus');
                const data = await resp.json();

                if (data.gpus.length === 0) {
                    document.getElementById('gpu-list').innerHTML = '<p>No GPUs detected.</p>';
                    return;
                }

                const html = data.gpus.map(gpu => `
                    <div class="device-card">
                        <div class="device-header">
                            <div>
                                <div class="device-name">${gpu.name}</div>
                                <div class="device-address">${gpu.address}</div>
                            </div>
                            <div>
                                ${gpu.driver === 'vfio-pci'
                                    ? '<span class="status-badge status-vfio">VFIO Bound</span>'
                                    : gpu.passthrough_ready
                                        ? '<span class="status-badge status-ready">Ready</span>'
                                        : '<span class="status-badge status-not-ready">Not Ready</span>'
                                }
                            </div>
                        </div>
                        <div class="device-meta">
                            <span>Group: ${gpu.iommu_group}</span>
                            <span>${gpu.isolated ? 'Isolated' : 'Shared'}</span>
                            <span>Driver: ${gpu.driver || 'none'}</span>
                        </div>
                        <div style="margin-top: 12px;">
                            ${gpu.driver === 'vfio-pci'
                                ? `<button class="btn btn-danger btn-sm" onclick="releaseDevice('${gpu.address}')">Release</button>`
                                : `<button class="btn btn-primary btn-sm" onclick="bindDevice('${gpu.address}')">Bind to VFIO</button>`
                            }
                        </div>
                    </div>
                `).join('');

                document.getElementById('gpu-list').innerHTML = html;
            } catch (e) {
                showError('gpu-list', e);
            }
        }

        // Load all devices
        async function loadDevices() {
            try {
                const resp = await fetch('/passthrough/api/devices');
                const data = await resp.json();

                const html = data.devices.map(dev => `
                    <div class="device-card">
                        <div class="device-header">
                            <div>
                                <div class="device-name">${dev.device_name}</div>
                                <div class="device-address">${dev.address}</div>
                            </div>
                            <span class="status-badge ${dev.isolated ? 'status-isolated' : 'status-shared'}">
                                ${dev.isolated ? 'Isolated' : 'Shared'}
                            </span>
                        </div>
                        <div class="device-meta">
                            <span>Class: ${dev.device_class}</span>
                            <span>Group: ${dev.iommu_group}</span>
                            <span>Driver: ${dev.driver || 'none'}</span>
                        </div>
                    </div>
                `).join('');

                document.getElementById('device-list').innerHTML = html || '<p>No devices found.</p>';
            } catch (e) {
                showError('device-list', e);
            }
        }

        // Load IOMMU groups
        async function loadGroups() {
            try {
                const resp = await fetch('/passthrough/api/iommu-groups');
                const data = await resp.json();

                const html = data.groups.map(group => `
                    <div class="iommu-group">
                        <div class="iommu-group-header">
                            <span>
                                <strong>Group ${group.id}</strong>
                                <span style="margin-left: 12px; opacity: 0.7;">${group.device_count} device(s)</span>
                            </span>
                            <span class="status-badge ${group.isolated ? 'status-isolated' : 'status-shared'}">
                                ${group.isolated ? 'Isolated' : 'Shared'}
                            </span>
                        </div>
                        <div class="iommu-group-devices">
                            ${group.devices.map(d => `
                                <div style="padding: 4px 0; font-size: 0.9em;">
                                    <code>${d.address}</code> - ${d.name}
                                    <span style="opacity: 0.6;">(${d.driver || 'no driver'})</span>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                `).join('');

                document.getElementById('group-list').innerHTML = html || '<p>No IOMMU groups found.</p>';
            } catch (e) {
                showError('group-list', e);
            }
        }

        // Load profiles
        async function loadProfiles() {
            try {
                const resp = await fetch('/passthrough/api/profiles');
                const data = await resp.json();

                const html = data.profiles.map(profile => `
                    <div class="device-card">
                        <div class="device-header">
                            <div>
                                <div class="device-name">${profile.name}</div>
                                <div class="device-address">${profile.description}</div>
                            </div>
                        </div>
                        <div style="margin-top: 8px;">
                            <strong>Device Classes:</strong> ${profile.device_classes.join(', ')}
                        </div>
                        <div style="margin-top: 8px;">
                            <strong>Matching Devices:</strong>
                            ${profile.matching_devices.length > 0
                                ? profile.matching_devices.map(d => `<div style="margin-left: 16px; font-size: 0.9em;">${d.address}: ${d.name}</div>`).join('')
                                : '<span style="opacity: 0.6;">None found</span>'
                            }
                        </div>
                    </div>
                `).join('');

                document.getElementById('profile-list').innerHTML = html;
            } catch (e) {
                showError('profile-list', e);
            }
        }

        // Bind device
        async function bindDevice(address) {
            if (!confirm(`Bind ${address} to VFIO-PCI? This may require root privileges.`)) return;

            try {
                const resp = await fetch('/passthrough/api/bind', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({address})
                });
                const data = await resp.json();

                if (data.status === 'success') {
                    alert('Device bound successfully!');
                    loadGPUs();
                    loadDevices();
                } else {
                    alert('Error: ' + (data.error || 'Unknown error'));
                }
            } catch (e) {
                alert('Error: ' + e.message);
            }
        }

        // Release device
        async function releaseDevice(address) {
            if (!confirm(`Release ${address} from VFIO-PCI?`)) return;

            try {
                const resp = await fetch('/passthrough/api/release', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({address})
                });
                const data = await resp.json();

                if (data.status === 'success') {
                    alert('Device released successfully!');
                    loadGPUs();
                    loadDevices();
                } else {
                    alert('Error: ' + (data.error || 'Unknown error'));
                }
            } catch (e) {
                alert('Error: ' + e.message);
            }
        }

        // Initialize
        loadStatus();
        loadGPUs();
        loadDevices();
        loadGroups();
        loadProfiles();
    </script>
</body>
</html>
