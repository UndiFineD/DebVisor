# Networking Design\n\n## Objectives\n\n- Support single-node and multi-node clusters.\n\n- Provide consistent VM networking (bridged + overlay).\n\n- Automate address assignment while allowing reservations.\n\n- Offer internal DNS/DHCP plus forward external queries.\n\n## Network Configuration Tool\n\nFor interactive configuration of wired, wireless, InfiniBand, VLANs, bridging, and bonding, see the [Network Config TUI](network-config-tui.md). The TUI generates systemd-networkd or Netplan files with a single-bridge default (`br0`), STP enabled, and optional bonding support.\n\n## Layers\n\n1. Physical NICs (ens*, enp*): discovered at first boot.\n\n1. Linux bridge `br0`: attaches primary NIC; VMs attach here.\n\n1. Pod network (Kubernetes): Calico default CIDR `192.168.0.0/16` (adjust via profile/variable).\n\n1. Optional tenant VLANs: supported via [Network Config TUI](../netcfg-tui/README.md) (e.g. `br0.100`).\n\n## DHCP Strategy\n\n- Centralized dnsmasq or ISC DHCP on designated "monitor" node.\n\n- MAC reservations for infrastructure nodes (admin/monitor/storage roles).\n\n- Dynamic range for tenant VMs: e.g. `10.10.20.100-10.10.20.254`.\n\n- Lease information exported to panel (for tenant IP visibility).\n\n## DNS Strategy\n\n- Authoritative internal zone: `debvisor.local`.\n\n- Records: `node1.debvisor.local`,`node2.debvisor.local`, etc.\n\n- Dynamic updates (TSIG) for VM hostnames upon provisioning.\n\n- Forwarders: Cloudflare (1.1.1.1) / Google (8.8.8.8) / local resolver chain.\n\n## Multi-Node Considerations\n\n- Keep consistent bridge naming across nodes (`br0`).\n\n- Ensure identical MTU for overlay + physical networks.\n\n- Optionally enable Calico BGP for external route advertisement.\n\n## Sample dnsmasq Configuration (excerpt)\n\n    interface=br0\n    domain=debvisor.local\n    dhcp-range=10.10.20.100,10.10.20.254,12h\n    dhcp-host=AA:BB:CC:DD:EE:01,node1,10.10.20.10\n    dhcp-host=AA:BB:CC:DD:EE:02,node2,10.10.20.11\n    server=1.1.1.1\n    server=8.8.8.8\n\n## Dynamic DNS Update Flow\n\n1. VM create event triggers the libvirt `qemu` hook.\n\n1. The hook calls the local helper\n\n  `/usr/local/sbin/debvisor-vm-register.sh` (when present), which\n  reads on-node TSIG key material and performs authenticated\n  updates.\n\n1. `vm123.debvisor.local` A record is inserted; reverse PTR records\n\n  are added when appropriate.\nFor most environments, this host-local helper and the hostname\nregistration service are the canonical DNS update clients. The\nlower-level `/usr/local/bin/debvisor-dns-update.sh` script can also be\nused by advanced automation, but is not the primary operator-facing\ninterface.\n\n## Future Enhancements\n\n- VRRP/keepalived for highly available DNS/DHCP pair.\n\n- nftables segmentation for tenant VLANs.\n\n- Per-tenant DNS subzones (e.g. `tenantA.debvisor.local`).\n\n## Troubleshooting\n\n- Check `ip addr show br0` for interface attachment.\n\n- Verify Calico node status: `kubectl get nodes -o wide`.\n\n- DNS resolution: `dig +short node1.debvisor.local @`.\n