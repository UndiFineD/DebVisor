# DebVisor Preseed (minimal prompts, profile selection)

# Locale & keyboard
d-i debian-installer/locale string en_US.UTF-8
d-i time/zone string UTC
d-i keyboard-configuration/xkb-keymap select us

# Host identity
d-i netcfg/choose_interface select auto
d-i netcfg/get_hostname string debvisor
d-i netcfg/get_domain string local

# Accounts (root + admin only; node/monitor handled at first boot)
d-i passwd/root-login boolean true
d-i passwd/root-password password 
d-i passwd/root-password-again password 
d-i passwd/user-fullname string Admin User
d-i passwd/username string admin
d-i passwd/user-password password 
d-i passwd/user-password-again password 
d-i passwd/allow-password-weak boolean false

# Disk (first disk only for OS; remaining handled post-install)
d-i partman-auto/method string regular
d-i partman/early_command string debconf-set partman-auto/disk "$(list-devices disk | head -n1 | sed 's|/dev/|/dev/disk/by-id/|')" || true
d-i partman-auto/disk string /dev/disk/by-id
d-i partman-auto/choose_recipe select atomic
d-i partman-auto/expert_recipe string \
    atomic :: \
        512 512 512 fat32 \
            $primary{ } $bootable{ } method{ efi } \
        . \
        1024 2048 2048 ext4 \
            $primary{ } method{ format } format{ } use_filesystem{ } filesystem{ ext4 } mountpoint{ / } \
        . \
        100% 100% 100% ext4 \
            method{ keep } \
        .

# Early profile selection (curses whiptail) and installer logging
d-i preseed/early_command string \
    mkdir -p /target/var/log/debvisor; \
    exec >>/target/var/log/debvisor/installer.log 2>&1; \
    echo "[DebVisor] Starting early_command"; \
    /usr/local/sbin/debvisor-hwcheck.sh || true; PROFILE="usb-zfs"; \
    if command -v whiptail >/dev/null 2>&1; then PROFILE=$(whiptail --title "DebVisor Profile" --menu "Select storage profile" 15 60 4 "usb-zfs" "USB-backed ZFS (default)" "ceph" "Single-node CephFS" "zfs" "Local ZFS-only" "mixed" "Ceph + local ZFS" 3>&1 1>&2 2>&3) || PROFILE="usb-zfs"; fi; \
    echo "PROFILE=$PROFILE" > /target/etc/debvisor-profile; \
    echo "[DebVisor] Selected profile: $PROFILE"; \

# Optional addons (presented later via debconf/curses)
d-i debvisor/addon-rpc boolean false
d-i debvisor/addon-webpanel boolean false
d-i debvisor/addon-vncconsole boolean false
d-i debvisor/addon-monitoring boolean false

# Late command: render /etc/debvisor-addons.conf from debconf answers
d-i preseed/late_command string \
    in-target mkdir -p /usr/local/sbin; \
    cp /cdrom/config/includes.installer/usr/local/sbin/debvisor-addon-choices.sh /target/usr/local/sbin/debvisor-addon-choices.sh; \
    chmod +x /target/usr/local/sbin/debvisor-addon-choices.sh; \
    in-target /usr/local/sbin/debvisor-addon-choices.sh || true

# NOTE:
# - Additional local users (node, monitor) and any role-specific config
#   are created/verified by debvisor-firstboot.sh or Ansible, not here.
