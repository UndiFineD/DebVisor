# DebVisor image configuration (`config/`)\n\nThis directory contains the**image build-time**configuration used by\n`build/build-debvisor.sh`and`live-build`to produce the DebVisor ISO.\nIt defines what is "baked into" the installer image versus what is\nhandled later by the first-boot provisioning script and Ansible.\nIn one sentence:\n\n-`config/`+`build/`define the immutable base image;\n\n-`debvisor-firstboot.sh`wires up a node on first boot; and\n\n- Ansible playbooks/roles manage day-2 changes across nodes.\n\n## Layout and responsibilities\n\n-`preseed.cfg`\n\n- Debian Installer preseed file controlling locale, time zone, disk\n\n    layout, and non-interactive install defaults.\n\n- Includes a menu to choose the DebVisor storage profile (for example\n\n    `ceph`,`zfs`, or`mixed`), writing the selected profile to\n    `/etc/debvisor-profile`on the installed system.\n\n- Ships**no real passwords**; placeholders are intentionally blank\n\n    and must be overridden for any production build.\n\n-`package-lists/`\n\n- Live-build package lists used during ISO creation.\n\n- Decide which Debian packages are present on the installed system\n\n    before any first-boot or Ansible automation runs (for example KVM,\n    Ceph, ZFS, Docker, kubeadm/kubelet/kubectl, Cockpit, monitoring\n    tooling).\n\n- Changes here always require a**rebuild of the ISO**.\n\n- `hooks/`\n\n- Live-build hook scripts run inside the build chroot.\n\n- Used for heavier build-time customization that cannot be expressed\n\n    as simple package lists (for example seeding Kubernetes binaries,\n    enabling Cockpit modules, or laying out directories).\n\n- Hooks like `hooks/normal/040-k8s.sh`may install Kubernetes\n\n    components unconditionally; future variants can gate this with\n    environment flags such as`DEBVISOR_ENABLE_K8S`to produce\n    Kubernetes-free images without editing the hook.\n\n-`includes.chroot/`\n\n- Files copied directly into the target filesystem of the installed\n\n    system.\n\n- Typical contents include:\n\n- `usr/local/sbin/debvisor-firstboot.sh`and related helper scripts.\n\n- Systemd unit files for first-boot, TSIG rotation, hostname\n\n      registration, and monitoring.\n\n- Base configuration files for Ceph, Docker/containerd, kubeadm,\n\n      nftables, dnsmasq, and logging.\n\n- These are**static defaults**; any configuration that must change\n\n    across environments should ultimately be owned by Ansible or be\n    explicitly overridden after install.\n\n### Deprecated:`config/auto/config`\n\n- The historical live-build entrypoint `config/auto/config`is kept as\n\n  a small stub that exits with a deprecation notice.\n\n- All supported builds must go through`build/build-debvisor.sh`, which\n\n  wires in `preseed.cfg`,`package-lists/`, hooks, mirrors, firmware\n  and self-test options.\n\n- For more detail, see `install/ISO_BUILD.md`and the root\n\n`build/README`(if present).\n\n## First-boot vs Ansible ownership\n\nOnce the image produced from`config/`is installed on a node, control\nflows through two main layers:\n1.**First-boot provisioning**\n\n-`debvisor-firstboot.sh`(and its systemd unit\n\n`debvisor-firstboot.service`) run**once**on the first boot of an\n     installed DebVisor node.\n\n- Responsibilities include:\n\n- Reading `/etc/debvisor-profile`and applying the chosen storage\n\n       profile (CephFS-first, ZFS, or mixed).\n\n- Creating core users and service accounts.\n\n- Setting up networking (bridge`br0`, basic firewall)\n\n       and wiring Cockpit + libvirt.\n\n- Bootstrapping Ceph or ZFS pools and initial mounts.\n\n- Laying down default Docker/Kubernetes configuration when\n\n       enabled.\n\n- The goal is to bring a single node from "freshly installed" to a\n\n     usable, opinionated baseline.\n1.**Ansible and day-2 automation**\n\n- Playbooks and roles in `ansible/`assume a node has successfully\n\n     completed first-boot.\n\n- They are responsible for**cluster-wide**and**ongoing**tasks\n\n     such as:\n\n- Enforcing SSH MFA across many nodes.\n\n- Rolling TSIG keys and updating DNS HA primaries/secondaries.\n\n- Deploying monitoring stacks, VNC/noVNC consoles, and RPC\n\n       services.\n\n- Think of Ansible as the source of truth for configuration once a\n\n     node is up and part of the cluster.\n\n## What requires an ISO rebuild\n\nAs a rule of thumb:\n\n- Changes under`config/`or`build/`**require**rebuilding the ISO.\n\n- Changes to first-boot scripts, systemd units, or Ansible roles can\n\n  often be rolled out to existing nodes without a reinstall (subject to\n  safe re-run behavior).\nWhen in doubt:\n\n- If you are changing packages, filesystem layout, or installer\n\n  behavior -> rebuild.\n\n- If you are changing day-2 policies (firewall rules, monitoring,\n\n  automation) -> prefer Ansible.\n\n
