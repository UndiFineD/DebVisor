# Copyright (c) 2025 DebVisor contributors
# Licensed under the Apache License, Version 2.0 (the "License");
# you may not use this file except in compliance with the License.
# You may obtain a copy of the License at
#     http://www.apache.org/licenses/LICENSE-2.0
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.

# DebVisor Enterprise Platform - Alerting Rules
# Prometheus AlertManager rules for critical services
#
# Alert Severity Levels:
#   - critical: Requires immediate attention, potential service impact
#   - warning: Should be investigated soon, may become critical
#   - info: Informational, for tracking and reporting
#
# Runbook URLs point to internal documentation

groups:
  # ===========================================================================
  # Node Health Alerts
  # ===========================================================================
  - name: node_health
    interval: 30s
    rules:
      - alert: NodeDown
        expr: up{job="node-exporter"} == 0
        for: 2m
        labels:
          severity: critical
          team: infrastructure
        annotations:
          summary: "Node {{ $labels.instance }} is down"
          description: "Node exporter on {{ $labels.instance }} has been unreachable for 2 minutes"
          runbook_url: "https://docs.debvisor.local/runbooks/node-down"

      - alert: NodeHighCPU
        expr: 100 - (avg by(instance) (irate(node_cpu_seconds_total{mode="idle"}[5m])) * 100) > 85
        for: 10m
        labels:
          severity: warning
          team: infrastructure
        annotations:
          summary: "High CPU usage on {{ $labels.instance }}"
          description: "CPU usage on {{ $labels.instance }} is above 85% for 10 minutes (current: {{ $value | printf \"%.1f\" }}%)"
          runbook_url: "https://docs.debvisor.local/runbooks/high-cpu"

      - alert: NodeHighMemory
        expr: (1 - (node_memory_MemAvailable_bytes / node_memory_MemTotal_bytes)) * 100 > 90
        for: 5m
        labels:
          severity: warning
          team: infrastructure
        annotations:
          summary: "High memory usage on {{ $labels.instance }}"
          description: "Memory usage on {{ $labels.instance }} is above 90% for 5 minutes"
          runbook_url: "https://docs.debvisor.local/runbooks/high-memory"

      - alert: NodeDiskPressure
        expr: (1 - (node_filesystem_avail_bytes{fstype!~"tmpfs|overlay"} / node_filesystem_size_bytes)) * 100 > 85
        for: 5m
        labels:
          severity: warning
          team: infrastructure
        annotations:
          summary: "Disk space low on {{ $labels.instance }}"
          description: "Disk usage on {{ $labels.instance }} {{ $labels.mountpoint }} is above 85%"
          runbook_url: "https://docs.debvisor.local/runbooks/disk-pressure"

      - alert: NodeDiskCritical
        expr: (1 - (node_filesystem_avail_bytes{fstype!~"tmpfs|overlay"} / node_filesystem_size_bytes)) * 100 > 95
        for: 2m
        labels:
          severity: critical
          team: infrastructure
        annotations:
          summary: "Critical disk space on {{ $labels.instance }}"
          description: "Disk usage on {{ $labels.instance }} {{ $labels.mountpoint }} is above 95%"
          runbook_url: "https://docs.debvisor.local/runbooks/disk-critical"

  # ===========================================================================
  # Kubernetes Cluster Alerts
  # ===========================================================================
  - name: kubernetes_cluster
    interval: 30s
    rules:
      - alert: KubeAPIServerDown
        expr: up{job="kubernetes-apiservers"} == 0
        for: 1m
        labels:
          severity: critical
          team: platform
        annotations:
          summary: "Kubernetes API Server is down"
          description: "Kubernetes API Server has been unreachable for 1 minute"
          runbook_url: "https://docs.debvisor.local/runbooks/kube-apiserver-down"

      - alert: KubeControllerManagerDown
        expr: up{job="kube-controller-manager"} == 0
        for: 2m
        labels:
          severity: critical
          team: platform
        annotations:
          summary: "Kube Controller Manager is down"
          description: "Controller Manager has been unreachable for 2 minutes"
          runbook_url: "https://docs.debvisor.local/runbooks/controller-manager-down"

      - alert: KubeSchedulerDown
        expr: up{job="kube-scheduler"} == 0
        for: 2m
        labels:
          severity: critical
          team: platform
        annotations:
          summary: "Kube Scheduler is down"
          description: "Scheduler has been unreachable for 2 minutes"
          runbook_url: "https://docs.debvisor.local/runbooks/scheduler-down"

      - alert: KubeletDown
        expr: up{job="kubelet"} == 0
        for: 2m
        labels:
          severity: critical
          team: platform
        annotations:
          summary: "Kubelet on {{ $labels.instance }} is down"
          description: "Kubelet has been unreachable for 2 minutes"
          runbook_url: "https://docs.debvisor.local/runbooks/kubelet-down"

      - alert: KubeNodeNotReady
        expr: kube_node_status_condition{condition="Ready",status="true"} == 0
        for: 5m
        labels:
          severity: warning
          team: platform
        annotations:
          summary: "Node {{ $labels.node }} is not ready"
          description: "Node {{ $labels.node }} has been NotReady for 5 minutes"
          runbook_url: "https://docs.debvisor.local/runbooks/node-not-ready"

      - alert: KubePodCrashLooping
        expr: rate(kube_pod_container_status_restarts_total[15m]) * 60 * 15 > 5
        for: 5m
        labels:
          severity: warning
          team: platform
        annotations:
          summary: "Pod {{ $labels.namespace }}/{{ $labels.pod }} is crash looping"
          description: "Pod has restarted more than 5 times in 15 minutes"
          runbook_url: "https://docs.debvisor.local/runbooks/crashloop"

      - alert: KubePodNotReady
        expr: sum by(namespace, pod) (kube_pod_status_phase{phase=~"Pending|Unknown"}) > 0
        for: 15m
        labels:
          severity: warning
          team: platform
        annotations:
          summary: "Pod {{ $labels.namespace }}/{{ $labels.pod }} is not ready"
          description: "Pod has been in Pending/Unknown state for 15 minutes"
          runbook_url: "https://docs.debvisor.local/runbooks/pod-not-ready"

  # ===========================================================================
  # Ceph Storage Alerts
  # ===========================================================================
  - name: ceph_storage
    interval: 30s
    rules:
      - alert: CephClusterWarning
        expr: ceph_health_status == 1
        for: 5m
        labels:
          severity: warning
          team: storage
        annotations:
          summary: "Ceph cluster is in HEALTH_WARN state"
          description: "Ceph cluster has been in warning state for 5 minutes"
          runbook_url: "https://docs.debvisor.local/runbooks/ceph-health-warn"

      - alert: CephClusterCritical
        expr: ceph_health_status == 2
        for: 1m
        labels:
          severity: critical
          team: storage
        annotations:
          summary: "Ceph cluster is in HEALTH_ERR state"
          description: "Ceph cluster health is critical - immediate attention required"
          runbook_url: "https://docs.debvisor.local/runbooks/ceph-health-err"

      - alert: CephOSDDown
        expr: ceph_osd_up == 0
        for: 2m
        labels:
          severity: warning
          team: storage
        annotations:
          summary: "Ceph OSD {{ $labels.osd }} is down"
          description: "OSD {{ $labels.osd }} has been down for 2 minutes"
          runbook_url: "https://docs.debvisor.local/runbooks/ceph-osd-down"

      - alert: CephOSDsDown
        expr: count(ceph_osd_up == 0) > 2
        for: 2m
        labels:
          severity: critical
          team: storage
        annotations:
          summary: "Multiple Ceph OSDs are down"
          description: "{{ $value }} OSDs are down - potential data unavailability"
          runbook_url: "https://docs.debvisor.local/runbooks/ceph-osds-down"

      - alert: CephMonQuorumLost
        expr: ceph_mon_quorum_status < 3
        for: 1m
        labels:
          severity: critical
          team: storage
        annotations:
          summary: "Ceph Monitor quorum at risk"
          description: "Only {{ $value }} monitors in quorum - cluster at risk"
          runbook_url: "https://docs.debvisor.local/runbooks/ceph-mon-quorum"

      - alert: CephStorageNearFull
        expr: ceph_cluster_total_used_bytes / ceph_cluster_total_bytes * 100 > 75
        for: 5m
        labels:
          severity: warning
          team: storage
        annotations:
          summary: "Ceph storage usage above 75%"
          description: "Ceph cluster storage is {{ $value | printf \"%.1f\" }}% full"
          runbook_url: "https://docs.debvisor.local/runbooks/ceph-storage-near-full"

      - alert: CephStorageCritical
        expr: ceph_cluster_total_used_bytes / ceph_cluster_total_bytes * 100 > 85
        for: 2m
        labels:
          severity: critical
          team: storage
        annotations:
          summary: "Ceph storage usage critical (>85%)"
          description: "Ceph cluster storage is {{ $value | printf \"%.1f\" }}% full - add capacity immediately"
          runbook_url: "https://docs.debvisor.local/runbooks/ceph-storage-critical"

      - alert: CephPGsUnclean
        expr: ceph_pg_total - ceph_pg_active_clean > 0
        for: 10m
        labels:
          severity: warning
          team: storage
        annotations:
          summary: "Ceph has unclean PGs"
          description: "{{ $value }} placement groups are not active+clean"
          runbook_url: "https://docs.debvisor.local/runbooks/ceph-pgs-unclean"

  # ===========================================================================
  # DebVisor Application Alerts
  # ===========================================================================
  - name: debvisor_application
    interval: 30s
    rules:
      - alert: DebVisorAPIDown
        expr: up{job="debvisor-api"} == 0
        for: 1m
        labels:
          severity: critical
          team: debvisor
        annotations:
          summary: "DebVisor API is down"
          description: "DebVisor API has been unreachable for 1 minute"
          runbook_url: "https://docs.debvisor.local/runbooks/debvisor-api-down"

      - alert: DebVisorHighErrorRate
        expr: |
          sum(rate(debvisor_http_requests_total{status=~"5.."}[5m])) /
          sum(rate(debvisor_http_requests_total[5m])) * 100 > 5
        for: 5m
        labels:
          severity: warning
          team: debvisor
        annotations:
          summary: "High error rate in DebVisor API"
          description: "Error rate is {{ $value | printf \"%.1f\" }}% (threshold: 5%)"
          runbook_url: "https://docs.debvisor.local/runbooks/debvisor-high-error-rate"

      - alert: DebVisorHighLatency
        expr: |
          histogram_quantile(0.95, sum(rate(debvisor_http_request_duration_seconds_bucket[5m])) by (le)) > 2
        for: 5m
        labels:
          severity: warning
          team: debvisor
        annotations:
          summary: "High latency in DebVisor API"
          description: "95th percentile latency is {{ $value | printf \"%.2f\" }}s (threshold: 2s)"
          runbook_url: "https://docs.debvisor.local/runbooks/debvisor-high-latency"

      - alert: DebVisorBackupFailed
        expr: debvisor_backup_last_success_timestamp < (time() - 86400)
        for: 5m
        labels:
          severity: warning
          team: debvisor
        annotations:
          summary: "DebVisor backup hasn't succeeded in 24 hours"
          description: "Last successful backup was {{ $value | humanizeTimestamp }}"
          runbook_url: "https://docs.debvisor.local/runbooks/debvisor-backup-failed"

      - alert: DebVisorLicenseExpiring
        expr: debvisor_license_expires_in_days < 30
        for: 1h
        labels:
          severity: warning
          team: debvisor
        annotations:
          summary: "DebVisor license expiring soon"
          description: "License expires in {{ $value }} days"
          runbook_url: "https://docs.debvisor.local/runbooks/debvisor-license"

      - alert: DebVisorLicenseExpired
        expr: debvisor_license_expires_in_days < 0
        for: 5m
        labels:
          severity: critical
          team: debvisor
        annotations:
          summary: "DebVisor license has expired"
          description: "License expired {{ $value | printf \"%.0f\" }} days ago"
          runbook_url: "https://docs.debvisor.local/runbooks/debvisor-license-expired"

  # ===========================================================================
  # VM and Hypervisor Alerts
  # ===========================================================================
  - name: hypervisor
    interval: 30s
    rules:
      - alert: LibvirtDaemonDown
        expr: up{job="libvirt-exporter"} == 0
        for: 2m
        labels:
          severity: critical
          team: virtualization
        annotations:
          summary: "Libvirt daemon is down on {{ $labels.instance }}"
          description: "Libvirt exporter unreachable - VMs may be inaccessible"
          runbook_url: "https://docs.debvisor.local/runbooks/libvirt-down"

      - alert: VMHighCPU
        expr: libvirt_domain_cpu_time_seconds_total > 90
        for: 10m
        labels:
          severity: warning
          team: virtualization
        annotations:
          summary: "VM {{ $labels.domain }} has high CPU usage"
          description: "VM CPU usage is {{ $value | printf \"%.1f\" }}% for 10 minutes"
          runbook_url: "https://docs.debvisor.local/runbooks/vm-high-cpu"

      - alert: VMUnexpectedShutdown
        expr: increase(libvirt_domain_state_shutdown_total[5m]) > 0
        for: 0m
        labels:
          severity: info
          team: virtualization
        annotations:
          summary: "VM {{ $labels.domain }} shut down"
          description: "VM has been shut down - verify if intentional"
          runbook_url: "https://docs.debvisor.local/runbooks/vm-shutdown"

  # ===========================================================================
  # Network Alerts
  # ===========================================================================
  - name: network
    interval: 30s
    rules:
      - alert: NetworkInterfaceDown
        expr: node_network_up{device!~"lo|veth.*|docker.*|br-.*"} == 0
        for: 2m
        labels:
          severity: warning
          team: network
        annotations:
          summary: "Network interface {{ $labels.device }} is down on {{ $labels.instance }}"
          description: "Interface has been down for 2 minutes"
          runbook_url: "https://docs.debvisor.local/runbooks/network-interface-down"

      - alert: NetworkHighPacketLoss
        expr: |
          rate(node_network_receive_drop_total[5m]) /
          rate(node_network_receive_packets_total[5m]) * 100 > 1
        for: 5m
        labels:
          severity: warning
          team: network
        annotations:
          summary: "High packet loss on {{ $labels.instance }} {{ $labels.device }}"
          description: "Packet loss is {{ $value | printf \"%.2f\" }}%"
          runbook_url: "https://docs.debvisor.local/runbooks/network-packet-loss"

      - alert: NetworkBandwidthSaturation
        expr: |
          rate(node_network_transmit_bytes_total[5m]) * 8 /
          node_network_speed_bytes * 100 > 80
        for: 5m
        labels:
          severity: warning
          team: network
        annotations:
          summary: "Network bandwidth saturation on {{ $labels.instance }} {{ $labels.device }}"
          description: "Interface utilization is {{ $value | printf \"%.1f\" }}%"
          runbook_url: "https://docs.debvisor.local/runbooks/network-saturation"

  # ===========================================================================
  # Certificate Alerts
  # ===========================================================================
  - name: certificates
    interval: 1h
    rules:
      - alert: CertificateExpiringSoon
        expr: probe_ssl_earliest_cert_expiry - time() < 86400 * 30
        for: 1h
        labels:
          severity: warning
          team: security
        annotations:
          summary: "Certificate for {{ $labels.instance }} expires in less than 30 days"
          description: "Certificate expires in {{ $value | humanizeDuration }}"
          runbook_url: "https://docs.debvisor.local/runbooks/cert-expiring"

      - alert: CertificateExpired
        expr: probe_ssl_earliest_cert_expiry - time() < 0
        for: 5m
        labels:
          severity: critical
          team: security
        annotations:
          summary: "Certificate for {{ $labels.instance }} has expired"
          description: "Certificate expired {{ $value | humanizeDuration }} ago"
          runbook_url: "https://docs.debvisor.local/runbooks/cert-expired"
