name: Notify on Failure
on:
  workflow_call:
    inputs:
      workflow_name:
        required: true
        type: string
      status:
        required: true
        type: string
      details:
        required: false
        type: string
      issue_label:
        required: false
        type: string
        default: ci-failure
    secrets:
      token:
        required: false
defaults:
  run:
    shell: bash
jobs:
  notify:
    runs-on: self-hosted
    if: inputs.status == 'failure'
    permissions:
      issues: write
      pull-requests: write
    steps:
    - name: Wait 30 minutes before notifying
      run: sleep 1800
    - name: Create or update failure issue
      uses: actions/github-script@ed597411d8f924073f98dfc5c65a23a2325f34cd
      with:
        script: "const title = `[Workflow Failure] ${{ inputs.workflow_name }}`;\n\
          const body = `## Workflow Failure Alert\n\n**Workflow**: ${{ inputs.workflow_name\
          \ }}\n**Status**: ${{ inputs.status }}\n**Run**: [View Run](${context.payload.repository.html_url}/actions/runs/${context.runId})\n\
          **Triggered by**: ${context.actor}\n**Ref**: ${context.ref}\n\n${{ inputs.details\
          \ || '' }}\n\n---\n*Auto-generated by workflow failure notification*`;\n\
          const label = '${{ inputs.issue_label }}' || 'ci-failure';\nconst issues\
          \ = await github.rest.issues.listForRepo({ owner: context.repo.owner, repo:\
          \ context.repo.repo, state: 'open', labels: label });\nconst existing =\
          \ issues.data.find(i => i.title === title);\nif (existing) {\n  await github.rest.issues.createComment({\
          \ owner: context.repo.owner, repo: context.repo.repo, issue_number: existing.number,\
          \ body: `New failure occurred:\n${body}` });\n} else {\n  await github.rest.issues.create({\
          \ owner: context.repo.owner, repo: context.repo.repo, title: title, body:\
          \ body, labels: [label, 'automated'] });\n}\n"