name: Secret Scanning
on:
  push:
    branches:
    - main
    - develop
    - feat/**
    - chore/**
  pull_request:
    branches:
    - main
    - develop
  schedule:
  - cron: 0 */6 * * *
defaults:
  run:
    shell: bash
permissions:
  contents: read
  security-events: write
  issues: write
  pull-requests: write
jobs:
  trufflehog:
    name: TruffleHog Scan
    runs-on: self-hosted
    outputs:
      found_count: ${{ steps.verdict.outputs.found_count }}
      tool_conclusion: ${{ steps.capture-status.outputs.step_conclusion }}
    steps:
    - name: Checkout repository
      uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8
      with:
        fetch-depth: 0
    - name: Run TruffleHog
      id: trufflehog
      continue-on-error: true
      uses: trufflesecurity/trufflehog@83235ddfbb0e35959a0a51e32628a819bccd5124
      with:
        path: .
        extra_args: --only-verified
    - name: Capture TruffleHog status
      if: always()
      id: capture-status
      run: 'echo "step_outcome=${{ steps.trufflehog.outcome }}" >> $GITHUB_OUTPUT
        || true

        echo "step_conclusion=${{ steps.trufflehog.conclusion }}" >> $GITHUB_OUTPUT
        || true

        echo "Recorded TruffleHog outcome=''${{ steps.trufflehog.outcome }}'' conclusion=''${{
        steps.trufflehog.conclusion }}''"

        '
    - name: Check SARIF exists
      if: always()
      id: check-sarif
      run: "if [ -f trufflehog.sarif ]; then\n  echo \"exists=true\" >> $GITHUB_OUTPUT\n\
        else\n  echo \"exists=false\" >> $GITHUB_OUTPUT\nfi\n"
    - name: Upload SARIF
      if: always() && steps.check-sarif.outputs.exists == 'true'
      uses: github/codeql-action/upload-sarif@v4
      with:
        sarif_file: trufflehog.sarif
    - name: Derive secret count
      if: always()
      id: verdict
      run: "if [ -f trufflehog.sarif ]; then\n  # Count ruleId occurrences as an approximation\
        \ of findings.\n  count=$(grep -c '\"ruleId\":' trufflehog.sarif || true)\n\
        else\n  count=0\nfi\necho \"found_count=$count\" >> $GITHUB_OUTPUT\necho \"\
        Detected secrets (approx): $count\"\n# Never fail here; summary job decides.\n"
  summary:
    name: Secret Scan Summary
    runs-on: self-hosted
    needs:
    - trufflehog
    if: always()
    permissions:
      issues: write
    steps:
    - name: Summary
      run: "job_result=\"${{ needs.trufflehog.result }}\"\ntool_conclusion=\"${{ needs.trufflehog.outputs.tool_conclusion\
        \ }}\"\ncount=\"${{ needs.trufflehog.outputs.found_count }}\"\necho \"TruffleHog\
        \ job-level result: $job_result\"\necho \"Captured tool_conclusion: $tool_conclusion\"\
        \necho \"Approx secret count: $count\"\n\n# Normalize count to integer\nif\
        \ ! echo \"$count\" | grep -Eq '^[0-9]+$'; then\n  echo \"Non-numeric count\
        \ ('$count') -> treating as 0\"\n  count=0\nfi\n\n# If upstream job failed\
        \ but count is 0, treat as soft warning (action error, not findings)\nif [\
        \ \"$job_result\" = \"failure\" ] && [ \"$count\" -eq 0 ]; then\n  echo \"\
        ::warning::TruffleHog action encountered errors but no secrets detected; treating\
        \ as soft pass\"\n  exit 0\nfi\n\n# Hard fail only if findings detected\n\
        if [ \"$count\" -gt 0 ]; then\n  echo \"::error::Failing workflow due to $count\
        \ detected secrets\"\n  echo \"secret_count=$count\" >> $GITHUB_OUTPUT\n \
        \ exit 1\nfi\n\necho \"::notice::No secrets detected; workflow succeeds.\"\
        \nexit 0\n"
  notify:
    needs:
    - summary
    - trufflehog
    if: needs.summary.result == 'failure'
    uses: ./.github/workflows/notifications.yml
    with:
      workflow_name: Secret Scanning
      status: failure
      issue_label: secrets-detected
      details: 'Detected secrets (approx): ${{ needs.trufflehog.outputs.found_count
        }}

        Run: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id
        }}

        Branch: ${{ github.ref }}

        '
    secrets:
      token: ${{ secrets.GITHUB_TOKEN }}
'on':
  push:
    branches:
    - main
  pull_request:
    branches:
    - main
