name: Runner Smoke Test
on:
  workflow_dispatch: null
  push:
    branches:
    - main
    paths:
    - .github/workflows/runner-smoke-test.yml
    - scripts/setup-runner-tools.sh
defaults:
  run:
    shell: bash
permissions:
  contents: read
jobs:
  smoke-test:
    runs-on: self-hosted
    steps:
    - name: Platform guard
      id: platform
      run: "if [ \"$RUNNER_OS\" = \"Linux\" ]; then\n  echo \"run_linux=true\" >>\
        \ \"$GITHUB_OUTPUT\"\nelse\n  echo \"run_linux=false\" >> \"$GITHUB_OUTPUT\"\
        \n  echo \"::notice title=Skipped::Runner bash smoke test requires Linux.\"\
        \nfi\n"
    - name: Checkout
      if: steps.platform.outputs.run_linux == 'true'
      uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8
    - name: Environment Info
      if: steps.platform.outputs.run_linux == 'true'
      run: "echo \"## Runner Environment\" >> $GITHUB_STEP_SUMMARY\necho \"- **OS**:\
        \ $RUNNER_OS\" >> $GITHUB_STEP_SUMMARY\necho \"- **Architecture**: $RUNNER_ARCH\"\
        \ >> $GITHUB_STEP_SUMMARY\necho \"- **Working Directory**: $(pwd)\" >> $GITHUB_STEP_SUMMARY\n\
        echo \"- **Shell**: $SHELL\" >> $GITHUB_STEP_SUMMARY\necho \"- **Bash Version**:\
        \ $BASH_VERSION\" >> $GITHUB_STEP_SUMMARY\necho \"- **Bash Path**: $(which\
        \ bash)\" >> $GITHUB_STEP_SUMMARY\necho \"\" >> $GITHUB_STEP_SUMMARY\n\necho\
        \ \"Runner OS: $RUNNER_OS\"\necho \"Runner Arch: $RUNNER_ARCH\"\necho \"Working\
        \ dir: $(pwd)\"\necho \"Shell: $SHELL\"\necho \"Bash version: $BASH_VERSION\"\
        \necho \"Bash path: $(which bash)\"\n\n# Verify bash is in PATH and functional\n\
        if command -v bash &>/dev/null; then\n  echo \"\u2705 bash found in PATH\"\
        \nelse\n  echo \"\u274C bash NOT in PATH\" >&2\n  exit 1\nfi\n\n# Check Git\
        \ Bash on Windows runner\nif [ \"$RUNNER_OS\" = \"Windows\" ]; then\n  if\
        \ [ -f \"/c/Program Files/Git/usr/bin/bash.exe\" ]; then\n    echo \"\u2705\
        \ Git Bash binary exists\"\n  else\n    echo \"\u26A0\uFE0F Git Bash not found\
        \ in default location\"\n  fi\nfi\n"
    - name: Test Bash Features
      if: steps.platform.outputs.run_linux == 'true'
      run: 'echo "Testing bash heredoc..."

        cat <<EOF

        Heredoc test successful

        Multiple lines work

        EOF


        echo "Testing process substitution..."

        echo "Files in current dir:" <(ls -la || dir)


        echo "Testing arrays..."

        arr=("one" "two" "three")

        echo "Array: ${arr[@]}"

        '
    - name: Check Core Tools
      if: steps.platform.outputs.run_linux == 'true'
      run: "echo \"## Core Tools\" >> $GITHUB_STEP_SUMMARY\n\n# curl\nif command -v\
        \ curl &>/dev/null; then\n  curl_ver=$(curl --version | head -n1)\n  echo\
        \ \"\u2705 curl: $curl_ver\" | tee -a $GITHUB_STEP_SUMMARY\nelse\n  echo \"\
        \u274C curl: NOT FOUND\" | tee -a $GITHUB_STEP_SUMMARY\nfi\n\n# git\nif command\
        \ -v git &>/dev/null; then\n  git_ver=$(git --version)\n  echo \"\u2705 git:\
        \ $git_ver\" | tee -a $GITHUB_STEP_SUMMARY\nelse\n  echo \"\u274C git: NOT\
        \ FOUND\" | tee -a $GITHUB_STEP_SUMMARY\nfi\n\n# sha256sum / sha256\nif command\
        \ -v sha256sum &>/dev/null; then\n  echo \"\u2705 sha256sum: available\" |\
        \ tee -a $GITHUB_STEP_SUMMARY\nelif command -v sha256 &>/dev/null; then\n\
        \  echo \"\u2705 sha256: available (macOS)\" | tee -a $GITHUB_STEP_SUMMARY\n\
        else\n  echo \"\u274C sha256sum: NOT FOUND\" | tee -a $GITHUB_STEP_SUMMARY\n\
        fi\n"
    - name: Setup Runner Tools
      if: steps.platform.outputs.run_linux == 'true'
      run: 'chmod +x scripts/setup-runner-tools.sh

        ./scripts/setup-runner-tools.sh

        '
    - name: Verify Installed Tools
      if: steps.platform.outputs.run_linux == 'true'
      run: "echo \"\" >> $GITHUB_STEP_SUMMARY\necho \"## Installed Tools\" >> $GITHUB_STEP_SUMMARY\n\
        \n# jq\nif command -v jq &>/dev/null; then\n  jq_ver=$(jq --version)\n  echo\
        \ \"\u2705 jq: $jq_ver\" | tee -a $GITHUB_STEP_SUMMARY\n  echo '{\"test\"\
        : \"value\"}' | jq .test\nelse\n  echo \"\u274C jq: NOT FOUND\" | tee -a $GITHUB_STEP_SUMMARY\n\
        \  exit 1\nfi\n\n# cosign\nif command -v cosign &>/dev/null; then\n  cosign_ver=$(cosign\
        \ version 2>&1 | head -n1 || echo \"version unknown\")\n  echo \"\u2705 cosign:\
        \ $cosign_ver\" | tee -a $GITHUB_STEP_SUMMARY\nelse\n  echo \"\u274C cosign:\
        \ NOT FOUND\" | tee -a $GITHUB_STEP_SUMMARY\n  exit 1\nfi\n\n# gpg\nif command\
        \ -v gpg &>/dev/null; then\n  gpg_ver=$(gpg --version | head -n1)\n  echo\
        \ \"\u2705 gpg: $gpg_ver\" | tee -a $GITHUB_STEP_SUMMARY\nelse\n  echo \"\u26A0\
        \uFE0F gpg: NOT FOUND (may be needed for signature verification)\" | tee -a\
        \ $GITHUB_STEP_SUMMARY\nfi\n"
    - name: Test GitHub API Access
      if: steps.platform.outputs.run_linux == 'true'
      env:
        GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      run: "echo \"\" >> $GITHUB_STEP_SUMMARY\necho \"## GitHub API Test\" >> $GITHUB_STEP_SUMMARY\n\
        \napi_response=$(curl -s -H \"Authorization: Bearer $GH_TOKEN\" \\\n  -H \"\
        Accept: application/vnd.github+json\" \\\n  \"https://api.github.com/repos/${GITHUB_REPOSITORY}\"\
        )\n\nrepo_name=$(echo \"$api_response\" | jq -r '.name')\nrepo_private=$(echo\
        \ \"$api_response\" | jq -r '.private')\n\nif [ \"$repo_name\" != \"null\"\
        \ ]; then\n  echo \"\u2705 GitHub API access: OK\" | tee -a $GITHUB_STEP_SUMMARY\n\
        \  echo \"- Repository: $repo_name\" | tee -a $GITHUB_STEP_SUMMARY\n  echo\
        \ \"- Private: $repo_private\" | tee -a $GITHUB_STEP_SUMMARY\nelse\n  echo\
        \ \"\u274C GitHub API access: FAILED\" | tee -a $GITHUB_STEP_SUMMARY\n  exit\
        \ 1\nfi\n"
    - name: Test OIDC Token (if configured)
      if: steps.platform.outputs.run_linux == 'true'
      continue-on-error: true
      run: "echo \"\" >> $GITHUB_STEP_SUMMARY\necho \"## OIDC Token Test\" >> $GITHUB_STEP_SUMMARY\n\
        \nif [ -n \"$ACTIONS_ID_TOKEN_REQUEST_URL\" ] && [ -n \"$ACTIONS_ID_TOKEN_REQUEST_TOKEN\"\
        \ ]; then\n  token_response=$(curl -s \"$ACTIONS_ID_TOKEN_REQUEST_URL&audience=sigstore\"\
        \ \\\n    -H \"Authorization: Bearer $ACTIONS_ID_TOKEN_REQUEST_TOKEN\" \\\n\
        \    -H \"Accept: application/json\")\n\n  if echo \"$token_response\" | jq\
        \ -e '.value' &>/dev/null; then\n    echo \"\u2705 OIDC token: Available\"\
        \ | tee -a $GITHUB_STEP_SUMMARY\n  else\n    echo \"\u26A0\uFE0F OIDC token:\
        \ Request failed\" | tee -a $GITHUB_STEP_SUMMARY\n    echo \"Response: $token_response\"\
        \n  fi\nelse\n  echo \"\u26A0\uFE0F OIDC: Not configured (environment variables\
        \ missing)\" | tee -a $GITHUB_STEP_SUMMARY\nfi\n"
    - name: Summary
      if: steps.platform.outputs.run_linux == 'true'
      run: "echo \"\" >> $GITHUB_STEP_SUMMARY\necho \"---\" >> $GITHUB_STEP_SUMMARY\n\
        echo \"**Smoke test completed**\" >> $GITHUB_STEP_SUMMARY\necho \"Check results\
        \ above for any \u274C failures or \u26A0\uFE0F warnings.\" >> $GITHUB_STEP_SUMMARY\n"
'on':
  push:
    branches:
    - main
  pull_request:
    branches:
    - main
