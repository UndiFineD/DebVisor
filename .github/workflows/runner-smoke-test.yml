name: Runner Smoke Test

on:
  workflow_dispatch:
  push:
    branches: [main]
    paths:
      - '.github/workflows/runner-smoke-test.yml'
      - 'scripts/setup-runner-tools.sh'

defaults:
  run:
    shell: bash

permissions:
  contents: read

jobs:
  smoke-test:
    runs-on: self-hosted
    steps:
      - name: Platform guard
        id: platform
        run: |
          if [ "$RUNNER_OS" = "Linux" ]; then
            echo "run_linux=true" >> "$GITHUB_OUTPUT"
          else
            echo "run_linux=false" >> "$GITHUB_OUTPUT"
            echo "::notice title=Skipped::Runner bash smoke test requires Linux."
          fi
      - name: Checkout
        if: steps.platform.outputs.run_linux == 'true'
        uses: actions/checkout@v6

      - name: Environment Info
        if: steps.platform.outputs.run_linux == 'true'
        run: |
          echo "## Runner Environment" >> $GITHUB_STEP_SUMMARY
          echo "- **OS**: $RUNNER_OS" >> $GITHUB_STEP_SUMMARY
          echo "- **Architecture**: $RUNNER_ARCH" >> $GITHUB_STEP_SUMMARY
          echo "- **Working Directory**: $(pwd)" >> $GITHUB_STEP_SUMMARY
          echo "- **Shell**: $SHELL" >> $GITHUB_STEP_SUMMARY
          echo "- **Bash Version**: $BASH_VERSION" >> $GITHUB_STEP_SUMMARY
          echo "- **Bash Path**: $(which bash)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          echo "Runner OS: $RUNNER_OS"
          echo "Runner Arch: $RUNNER_ARCH"
          echo "Working dir: $(pwd)"
          echo "Shell: $SHELL"
          echo "Bash version: $BASH_VERSION"
          echo "Bash path: $(which bash)"

          # Verify bash is in PATH and functional
          if command -v bash &>/dev/null; then
            echo "✅ bash found in PATH"
          else
            echo "❌ bash NOT in PATH" >&2
            exit 1
          fi

          # Check Git Bash on Windows runner
          if [ "$RUNNER_OS" = "Windows" ]; then
            if [ -f "/c/Program Files/Git/usr/bin/bash.exe" ]; then
              echo "✅ Git Bash binary exists"
            else
              echo "⚠️ Git Bash not found in default location"
            fi
          fi

      - name: Test Bash Features
        if: steps.platform.outputs.run_linux == 'true'
        run: |
          echo "Testing bash heredoc..."
          cat <<EOF
          Heredoc test successful
          Multiple lines work
          EOF

          echo "Testing process substitution..."
          echo "Files in current dir:" <(ls -la || dir)

          echo "Testing arrays..."
          arr=("one" "two" "three")
          echo "Array: ${arr[@]}"

      - name: Check Core Tools
        if: steps.platform.outputs.run_linux == 'true'
        run: |
          echo "## Core Tools" >> $GITHUB_STEP_SUMMARY

          # curl
          if command -v curl &>/dev/null; then
            curl_ver=$(curl --version | head -n1)
            echo "✅ curl: $curl_ver" | tee -a $GITHUB_STEP_SUMMARY
          else
            echo "❌ curl: NOT FOUND" | tee -a $GITHUB_STEP_SUMMARY
          fi

          # git
          if command -v git &>/dev/null; then
            git_ver=$(git --version)
            echo "✅ git: $git_ver" | tee -a $GITHUB_STEP_SUMMARY
          else
            echo "❌ git: NOT FOUND" | tee -a $GITHUB_STEP_SUMMARY
          fi

          # sha256sum / sha256
          if command -v sha256sum &>/dev/null; then
            echo "✅ sha256sum: available" | tee -a $GITHUB_STEP_SUMMARY
          elif command -v sha256 &>/dev/null; then
            echo "✅ sha256: available (macOS)" | tee -a $GITHUB_STEP_SUMMARY
          else
            echo "❌ sha256sum: NOT FOUND" | tee -a $GITHUB_STEP_SUMMARY
          fi

      - name: Setup Runner Tools
        if: steps.platform.outputs.run_linux == 'true'
        run: |
          chmod +x scripts/setup-runner-tools.sh
          ./scripts/setup-runner-tools.sh

      - name: Verify Installed Tools
        if: steps.platform.outputs.run_linux == 'true'
        run: |
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## Installed Tools" >> $GITHUB_STEP_SUMMARY

          # jq
          if command -v jq &>/dev/null; then
            jq_ver=$(jq --version)
            echo "✅ jq: $jq_ver" | tee -a $GITHUB_STEP_SUMMARY
            echo '{"test": "value"}' | jq .test
          else
            echo "❌ jq: NOT FOUND" | tee -a $GITHUB_STEP_SUMMARY
            exit 1
          fi

          # cosign
          if command -v cosign &>/dev/null; then
            cosign_ver=$(cosign version 2>&1 | head -n1 || echo "version unknown")
            echo "✅ cosign: $cosign_ver" | tee -a $GITHUB_STEP_SUMMARY
          else
            echo "❌ cosign: NOT FOUND" | tee -a $GITHUB_STEP_SUMMARY
            exit 1
          fi

          # gpg
          if command -v gpg &>/dev/null; then
            gpg_ver=$(gpg --version | head -n1)
            echo "✅ gpg: $gpg_ver" | tee -a $GITHUB_STEP_SUMMARY
          else
            echo "⚠️ gpg: NOT FOUND (may be needed for signature verification)" | tee -a $GITHUB_STEP_SUMMARY
          fi

      - name: Test GitHub API Access
        if: steps.platform.outputs.run_linux == 'true'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## GitHub API Test" >> $GITHUB_STEP_SUMMARY

          api_response=$(curl -s -H "Authorization: Bearer $GH_TOKEN" \
            -H "Accept: application/vnd.github+json" \
            "https://api.github.com/repos/${GITHUB_REPOSITORY}")

          repo_name=$(echo "$api_response" | jq -r '.name')
          repo_private=$(echo "$api_response" | jq -r '.private')

          if [ "$repo_name" != "null" ]; then
            echo "✅ GitHub API access: OK" | tee -a $GITHUB_STEP_SUMMARY
            echo "- Repository: $repo_name" | tee -a $GITHUB_STEP_SUMMARY
            echo "- Private: $repo_private" | tee -a $GITHUB_STEP_SUMMARY
          else
            echo "❌ GitHub API access: FAILED" | tee -a $GITHUB_STEP_SUMMARY
            exit 1
          fi

      - name: Test OIDC Token (if configured)
        if: steps.platform.outputs.run_linux == 'true'
        continue-on-error: true
        run: |
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## OIDC Token Test" >> $GITHUB_STEP_SUMMARY

          if [ -n "$ACTIONS_ID_TOKEN_REQUEST_URL" ] && [ -n "$ACTIONS_ID_TOKEN_REQUEST_TOKEN" ]; then
            token_response=$(curl -s "$ACTIONS_ID_TOKEN_REQUEST_URL&audience=sigstore" \
              -H "Authorization: Bearer $ACTIONS_ID_TOKEN_REQUEST_TOKEN" \
              -H "Accept: application/json")

            if echo "$token_response" | jq -e '.value' &>/dev/null; then
              echo "✅ OIDC token: Available" | tee -a $GITHUB_STEP_SUMMARY
            else
              echo "⚠️ OIDC token: Request failed" | tee -a $GITHUB_STEP_SUMMARY
              echo "Response: $token_response"
            fi
          else
            echo "⚠️ OIDC: Not configured (environment variables missing)" | tee -a $GITHUB_STEP_SUMMARY
          fi

      - name: Summary
        if: steps.platform.outputs.run_linux == 'true'
        run: |
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "---" >> $GITHUB_STEP_SUMMARY
          echo "**Smoke test completed**" >> $GITHUB_STEP_SUMMARY
          echo "Check results above for any ❌ failures or ⚠️ warnings." >> $GITHUB_STEP_SUMMARY
