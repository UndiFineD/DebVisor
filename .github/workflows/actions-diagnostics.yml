name: CI Diagnostics
on:
  schedule:
  - cron: 0 * * * *
  workflow_dispatch: null
defaults:
  run:
    shell: bash
permissions:
  contents: read
  actions: read
  issues: write
concurrency:
  group: ci-diagnostics
  cancel-in-progress: true
jobs:
  scan-failures:
    runs-on: self-hosted
    steps:
    - name: Gather recent workflow runs and update summary issue
      continue-on-error: true
      uses: actions/github-script@ed597411d8f924073f98dfc5c65a23a2325f34cd
      with:
        script: "const owner = context.repo.owner;\nconst repo = context.repo.repo;\n\
          const limit = parseInt(core.getInput('limit') || '50', 10);\nconst failureSet\
          \ = new Set(['failure','cancelled','timed_out']);\n\n// Fetch recent runs\n\
          const runsResp = await github.request('GET /repos/{owner}/{repo}/actions/runs',\
          \ { owner, repo, per_page: limit });\nconst runs = runsResp.data.workflow_runs\
          \ || [];\nconst problematic = runs.filter(r => {\n  const concl = (r.conclusion\
          \ || '').toLowerCase();\n  return failureSet.has(concl);\n});\n\n// Build\
          \ markdown body\nconst lines = [];\nlines.push(`# CI Failure Summary (last\
          \ ${runs.length} runs)`);\nlines.push(`_Updated: ${new Date().toISOString()}_`);\n\
          if (problematic.length === 0) {\n  lines.push('\\n? No failed/cancelled/timed_out\
          \ runs detected in the last batch.');\n} else {\n  lines.push(`\\nFound\
          \ **${problematic.length}** problematic runs:`);\n  for (const r of problematic)\
          \ {\n    lines.push(`- Run **#${r.run_number}** (${r.name}) - conclusion:\
          \ **${r.conclusion}** - [View Run](${r.html_url})`);\n  }\n  // Detail first\
          \ failure jobs\n  const first = problematic[0];\n  const jobsResp = await\
          \ github.request('GET /repos/{owner}/{repo}/actions/runs/{run_id}/jobs',\
          \ { owner, repo, run_id: first.id });\n  const failingJobs = jobsResp.data.jobs.filter(j\
          \ => j.conclusion !== 'success');\n  lines.push(`\\n### Details for first\
          \ failing run (#${first.run_number})`);\n  for (const j of failingJobs)\
          \ {\n    lines.push(`* Job: **${j.name}** - conclusion: **${j.conclusion}**`);\n\
          \    for (const s of j.steps) {\n      if (s.conclusion && s.conclusion\
          \ !== 'success') {\n        lines.push(`  - Step: ${s.name} (conclusion:\
          \ ${s.conclusion})`);\n      }\n    }\n  }\n}\n\nlines.push('\\n---');\n\
          lines.push('Generated by hourly CI Diagnostics workflow.');\n\nconst body\
          \ = lines.join('\\n');\nconst issueTitle = 'CI Failure Summary';\n\n// Find\
          \ existing open issue\ntry {\n  const issuesResp = await github.request('GET\
          \ /repos/{owner}/{repo}/issues', { owner, repo, state: 'open', per_page:\
          \ 100 });\n  const existing = issuesResp.data.find(i => i.title === issueTitle);\n\
          \  if (existing) {\n    await github.request('PATCH /repos/{owner}/{repo}/issues/{issue_number}',\
          \ { owner, repo, issue_number: existing.number, body });\n    core.info(`Updated\
          \ existing issue #${existing.number}`);\n  } else {\n    const created =\
          \ await github.request('POST /repos/{owner}/{repo}/issues', { owner, repo,\
          \ title: issueTitle, body, labels: ['ci-failure','automated'] });\n    core.info(`Created\
          \ new issue #${created.data.number}`);\n  }\n} catch (e) {\n  core.warning(`Issue\
          \ update/create failed: ${e.message}`);\n}\n\n// Also output a summary to\
          \ GITHUB_STEP_SUMMARY\ncore.summary.addHeading('CI Failure Summary')\n \
          \ .addRaw(body)\n  .write();\n"
    - name: Upload raw diagnostics artifact
      if: always()
      run: 'mkdir -p ci-diagnostics

        echo "Diagnostics created at $(date -u)." > ci-diagnostics/diagnostics.txt

        echo "See ''CI Failure Summary'' issue for details." >> ci-diagnostics/diagnostics.txt

        '
    - name: Upload artifact
      if: always()
      uses: actions/upload-artifact@330a01c490aca151604b8cf639adc76d48f6c5d4
      with:
        name: ci-diagnostics-${{ github.run_id }}
        path: ci-diagnostics/
        retention-days: 14