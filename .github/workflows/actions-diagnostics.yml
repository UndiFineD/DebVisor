name: CI Diagnostics

on:
  schedule:
    - cron: '0 * * * *'  # Hourly at minute 0
  workflow_dispatch:


defaults:
  run:
    shell: pwsh

permissions:
  contents: read
  actions: read
  issues: write

concurrency:
  group: ci-diagnostics
  cancel-in-progress: true

jobs:
  scan-failures:
    runs-on: self-hosted
    steps:
      - name: Gather recent workflow runs and update summary issue
        continue-on-error: true
        uses: actions/github-script@v7
        with:
          script: |
            const owner = context.repo.owner;
            const repo = context.repo.repo;
            const limit = parseInt(core.getInput('limit') || '50', 10);
            const failureSet = new Set(['failure','cancelled','timed_out']);

            // Fetch recent runs
            const runsResp = await github.request('GET /repos/{owner}/{repo}/actions/runs', { owner, repo, per_page: limit });
            const runs = runsResp.data.workflow_runs || [];
            const problematic = runs.filter(r => {
              const concl = (r.conclusion || '').toLowerCase();
              return failureSet.has(concl);
            });

            // Build markdown body
            const lines = [];
            lines.push(`# CI Failure Summary (last ${runs.length} runs)`);
            lines.push(`_Updated: ${new Date().toISOString()}_`);
            if (problematic.length === 0) {
              lines.push('\n? No failed/cancelled/timed_out runs detected in the last batch.');
            } else {
              lines.push(`\nFound **${problematic.length}** problematic runs:`);
              for (const r of problematic) {
                lines.push(`- Run **#${r.run_number}** (${r.name}) - conclusion: **${r.conclusion}** - [View Run](${r.html_url})`);
              }
              // Detail first failure jobs
              const first = problematic[0];
              const jobsResp = await github.request('GET /repos/{owner}/{repo}/actions/runs/{run_id}/jobs', { owner, repo, run_id: first.id });
              const failingJobs = jobsResp.data.jobs.filter(j => j.conclusion !== 'success');
              lines.push(`\n### Details for first failing run (#${first.run_number})`);
              for (const j of failingJobs) {
                lines.push(`* Job: **${j.name}** - conclusion: **${j.conclusion}**`);
                for (const s of j.steps) {
                  if (s.conclusion && s.conclusion !== 'success') {
                    lines.push(`  - Step: ${s.name} (conclusion: ${s.conclusion})`);
                  }
                }
              }
            }

            lines.push('\n---');
            lines.push('Generated by hourly CI Diagnostics workflow.');

            const body = lines.join('\n');
            const issueTitle = 'CI Failure Summary';

            // Find existing open issue
            try {
              const issuesResp = await github.request('GET /repos/{owner}/{repo}/issues', { owner, repo, state: 'open', per_page: 100 });
              const existing = issuesResp.data.find(i => i.title === issueTitle);
              if (existing) {
                await github.request('PATCH /repos/{owner}/{repo}/issues/{issue_number}', { owner, repo, issue_number: existing.number, body });
                core.info(`Updated existing issue #${existing.number}`);
              } else {
                const created = await github.request('POST /repos/{owner}/{repo}/issues', { owner, repo, title: issueTitle, body, labels: ['ci-failure','automated'] });
                core.info(`Created new issue #${created.data.number}`);
              }
            } catch (e) {
              core.warning(`Issue update/create failed: ${e.message}`);
            }
            
            // Also output a summary to GITHUB_STEP_SUMMARY
            core.summary.addHeading('CI Failure Summary')
              .addRaw(body)
              .write();
      - name: Upload raw diagnostics artifact
        if: always()
        run: |
          mkdir -p ci-diagnostics
          echo "Diagnostics created at $(date -u)." > ci-diagnostics/diagnostics.txt
          echo "See 'CI Failure Summary' issue for details." >> ci-diagnostics/diagnostics.txt
        
      - name: Upload artifact
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: ci-diagnostics-${{ github.run_id }}
          path: ci-diagnostics/
          retention-days: 14
