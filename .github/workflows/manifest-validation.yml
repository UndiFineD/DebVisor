name: Manifest Validation
on:
  push:
    branches:
    - main
    - develop
    paths:
    - '**.yaml'
    - '**.yml'
    - deploy/**
    - k8s/**
    - kubernetes/**
    - charts/**
    - .github/workflows/**
  pull_request:
    branches:
    - main
    - develop
    paths:
    - '**.yaml'
    - '**.yml'
    - deploy/**
    - k8s/**
    - kubernetes/**
    - charts/**
env:
  KUBECTL_VERSION: v1.29.0
  KUBECONFORM_VERSION: v0.6.4
  KUBEVAL_VERSION: v0.16.1
  KUBE_LINTER_VERSION: 0.6.8
  PLUTO_VERSION: 5.19.4
defaults:
  run:
    shell: bash
jobs:
  yaml-lint:
    name: YAML Lint
    runs-on: ubuntu-latest
    steps:
    - name: Checkout repository
      uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8
    - name: Install yamllint
      run: pip install yamllint
    - name: Create yamllint config
      run: "cat > .yamllint.yml << 'EOF'\nextends: default\nrules:\n  line-length:\n\
        \    max: 200\n    level: warning\n  document-start: disable\n  truthy:\n\
        \    check-keys: false\n  comments:\n    min-spaces-from-content: 1\n  braces:\n\
        \    min-spaces-inside: 0\n    max-spaces-inside: 1\n  brackets:\n    min-spaces-inside:\
        \ 0\n    max-spaces-inside: 1\n  indentation:\n    spaces: 2\n    indent-sequences:\
        \ consistent\nignore: |\n  .git/\n  node_modules/\n  vendor/\n  *.enc.yaml\n\
        EOF\n"
    - name: Run yamllint
      run: "yamllint -c .yamllint.yml . \\\n  --format github \\\n  || echo \"::warning::YAML\
        \ lint found issues\"\n"
  kubeconform:
    name: Kubeconform Validation
    runs-on: ubuntu-latest
    needs: yaml-lint
    steps:
    - name: Checkout repository
      uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8
    - name: Install kubeconform
      run: "curl -sL https://github.com/yannh/kubeconform/releases/download/${{ env.KUBECONFORM_VERSION\
        \ }}/kubeconform-linux-amd64.tar.gz \\\n  | sudo tar xz -C /usr/local/bin\n"
    - name: Download CRD schemas
      run: "mkdir -p /tmp/schemas\n\n# Download common CRD schemas\n# Prometheus Operator\n\
        curl -sL https://raw.githubusercontent.com/prometheus-operator/prometheus-operator/main/jsonschema/servicemonitor.json\
        \ \\\n  -o /tmp/schemas/servicemonitor.json || true\n\n# Cert-manager\ncurl\
        \ -sL https://raw.githubusercontent.com/cert-manager/cert-manager/master/deploy/crds/crd-certificates.yaml\
        \ \\\n  -o /tmp/schemas/certificate.yaml || true\n"
    - name: Find Kubernetes manifests
      id: find-manifests
      run: "MANIFEST_DIRS=\"\"\nfor dir in deploy k8s kubernetes charts; do\n  if\
        \ [ -d \"$dir\" ]; then\n    MANIFEST_DIRS=\"$MANIFEST_DIRS $dir\"\n  fi\n\
        done\necho \"dirs=$MANIFEST_DIRS\" >> $GITHUB_OUTPUT\n"
    - name: Validate Kubernetes manifests
      run: "echo \"=== Validating Kubernetes manifests ===\"\n\n# Find all YAML files\
        \ that look like K8s manifests\nfind . -type f \\( -name '*.yaml' -o -name\
        \ '*.yml' \\) \\\n  ! -path './.git/*' \\\n  ! -path './node_modules/*' \\\
        \n  ! -name '.yamllint*' \\\n  ! -name '*secret*' \\\n  -exec grep -l 'apiVersion:'\
        \ {} \\; 2>/dev/null | head -100 > /tmp/k8s-files.txt || true\n\nif [ -s /tmp/k8s-files.txt\
        \ ]; then\n  echo \"Found $(wc -l < /tmp/k8s-files.txt) potential K8s manifests\"\
        \n\n  cat /tmp/k8s-files.txt | xargs kubeconform \\\n    -strict \\\n    -ignore-missing-schemas\
        \ \\\n    -kubernetes-version 1.29.0 \\\n    -summary \\\n    -output json\
        \ \\\n    > /tmp/kubeconform-results.json 2>&1 || true\n\n  # Parse results\n\
        \  jq -r '.[] | select(.status != \"valid\") | \"\\(.filename): \\(.status)\
        \ - \\(.msg)\"' \\\n    /tmp/kubeconform-results.json 2>/dev/null || true\n\
        \n  # Check for errors\n  ERRORS=$(jq '[.[] | select(.status == \"invalid\"\
        )] | length' /tmp/kubeconform-results.json 2>/dev/null || echo \"0\")\n  if\
        \ [ \"$ERRORS\" != \"0\" ]; then\n    echo \"::error::Found $ERRORS invalid\
        \ manifests\"\n    exit 1\n  fi\nelse\n  echo \"No Kubernetes manifests found\"\
        \nfi\n"
  kube-linter:
    name: Security Lint (kube-linter)
    runs-on: ubuntu-latest
    needs: yaml-lint
    steps:
    - name: Checkout repository
      uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8
    - name: Install kube-linter
      run: "curl -sL https://github.com/stackrox/kube-linter/releases/download/v${{\
        \ env.KUBE_LINTER_VERSION }}/kube-linter-linux \\\n  -o kube-linter\nsudo\
        \ mv kube-linter /usr/local/bin/\nsudo chmod +x /usr/local/bin/kube-linter\n"
    - name: Create kube-linter config
      run: "cat > .kube-linter.yaml << 'EOF'\nchecks:\n  exclude:\n    # Allow running\
        \ as root in system namespaces\n    - \"run-as-non-root\"\n    # Allow privileged\
        \ containers for specific workloads\n    - \"privileged-container\"\n  include:\n\
        \    - \"latest-tag\"\n    - \"no-read-only-root-fs\"\n    - \"dangling-service\"\
        \n    - \"unset-cpu-requirements\"\n    - \"unset-memory-requirements\"\n\n\
        customChecks:\n  - name: \"require-labels\"\n    description: \"Ensure required\
        \ labels are present\"\n    remediation: \"Add app.kubernetes.io/name and\
        \ app.kubernetes.io/version labels\"\n    scope:\n      objectKinds:\n   \
        \     - DeploymentLike\n    template: \"required-label\"\n    params:\n  \
        \    key: \"app.kubernetes.io/name\"\nEOF\n"
    - name: Run kube-linter
      run: "echo \"=== Running kube-linter security checks ===\"\n\n# Find directories\
        \ with K8s manifests\nfor dir in deploy k8s kubernetes charts; do\n  if [\
        \ -d \"$dir\" ]; then\n    echo \"Linting $dir/\"\n    kube-linter lint \"\
        $dir/\" \\\n      --config .kube-linter.yaml \\\n      --format sarif \\\n\
        \      > kube-linter-results.sarif 2>&1 || true\n  fi\ndone\n\n# Also check\
        \ root for any manifests\nfind . -maxdepth 1 -name '*.yaml' -exec grep -l\
        \ 'kind:' {} \\; 2>/dev/null | head -20 > /tmp/root-manifests.txt || true\n\
        \nif [ -s /tmp/root-manifests.txt ]; then\n  echo \"Linting root manifests\"\
        \n  cat /tmp/root-manifests.txt | xargs kube-linter lint \\\n    --config\
        \ .kube-linter.yaml \\\n    2>&1 || true\nfi\n"
    - name: Upload SARIF results
      if: always()
      uses: github/codeql-action/upload-sarif@cf1bb45a277cb3c205638b2cd5c984db1c46a412
      with:
        sarif_file: kube-linter-results.sarif
      continue-on-error: true
  deprecated-apis:
    name: Deprecated API Check
    runs-on: ubuntu-latest
    needs: yaml-lint
    steps:
    - name: Checkout repository
      uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8
    - name: Install Pluto
      run: "curl -sL https://github.com/FairwindsOps/pluto/releases/download/v${{\
        \ env.PLUTO_VERSION }}/pluto_${{ env.PLUTO_VERSION }}_linux_amd64.tar.gz \\\
        \n  | sudo tar xz -C /usr/local/bin pluto\n"
    - name: Check for deprecated APIs
      run: "echo \"=== Checking for deprecated Kubernetes APIs ===\"\n\n# Target K8s\
        \ version\nTARGET_VERSION=\"1.29\"\n\n# Find all YAML files\nfind . -type\
        \ f \\( -name '*.yaml' -o -name '*.yml' \\) \\\n  ! -path './.git/*' \\\n\
        \  ! -path './node_modules/*' \\\n  -exec grep -l 'apiVersion:' {} \\; 2>/dev/null\
        \ > /tmp/all-k8s.txt || true\n\nif [ -s /tmp/all-k8s.txt ]; then\n  echo \"\
        Checking $(wc -l < /tmp/all-k8s.txt) files for deprecated APIs\"\n\n  pluto\
        \ detect-files -d . \\\n    --target-versions k8s=v$TARGET_VERSION \\\n  \
        \  --output markdown \\\n    || true\n\n  # Check for critical deprecations\n\
        \  DEPRECATIONS=$(pluto detect-files -d . \\\n    --target-versions k8s=v$TARGET_VERSION\
        \ \\\n    --output json 2>/dev/null | jq 'length' || echo \"0\")\n\n  if [\
        \ \"$DEPRECATIONS\" != \"0\" ] && [ \"$DEPRECATIONS\" != \"\" ]; then\n  \
        \  echo \"::warning::Found $DEPRECATIONS deprecated APIs\"\n  fi\nfi\n"
  helm-lint:
    name: Helm Chart Lint
    runs-on: ubuntu-latest
    needs: yaml-lint
    steps:
    - name: Checkout repository
      uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8
      with:
        fetch-depth: 0
    - name: Install Helm
      uses: azure/setup-helm@1a275c3b69536ee54be43f2070a358922e12c8d4
      with:
        version: 3.13.0
    - name: Lint Helm charts
      run: "echo \"=== Linting Helm charts ===\"\n\n# Find all Chart.yaml files\n\
        CHARTS=$(find . -name 'Chart.yaml' -type f)\nif [ -z \"$CHARTS\" ]; then\n\
        \  echo \"No Helm charts found; skipping lint\"\n  exit 0\nfi\necho \"$CHARTS\"\
        \ | while read chart; do\n  CHART_DIR=$(dirname \"$chart\")\n  echo \"Linting\
        \ chart: $CHART_DIR\"\n\n  helm lint \"$CHART_DIR\" --strict || true\n\n \
        \ # Validate templates\n  helm template test-release \"$CHART_DIR\" \\\n \
        \   --debug \\\n    > /tmp/rendered.yaml 2>&1 || echo \"Template rendering\
        \ failed\"\ndone\n"
    - name: Check chart dependencies
      run: "find . -name 'Chart.yaml' -type f | while read chart; do\n  CHART_DIR=$(dirname\
        \ \"$chart\")\n\n  if [ -f \"$CHART_DIR/Chart.lock\" ]; then\n    echo \"\
        Checking dependencies for $CHART_DIR\"\n    helm dependency build \"$CHART_DIR\"\
        \ || true\n  fi\ndone\n"
  netpol-check:
    name: NetworkPolicy Check
    runs-on: ubuntu-latest
    needs: yaml-lint
    steps:
    - name: Checkout repository
      uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8
    - name: Install networkpolicy-visualizer
      run: pip install networkpolicy-viewer || true
    - name: Validate NetworkPolicies
      run: "echo \"=== Checking NetworkPolicy definitions ===\"\n\n# Find NetworkPolicy\
        \ manifests\nfind . -type f \\( -name '*.yaml' -o -name '*.yml' \\) \\\n \
        \ -exec grep -l 'kind: NetworkPolicy' {} \\; 2>/dev/null > /tmp/netpols.txt\
        \ || true\n\nif [ -s /tmp/netpols.txt ]; then\n  echo \"Found $(wc -l < /tmp/netpols.txt)\
        \ NetworkPolicy files\"\n\n  while read file; do\n    echo \"Validating: $file\"\
        \n\n    # Check for common issues\n    if grep -q 'podSelector: {}' \"$file\"\
        ; then\n      echo \"::warning file=$file::Empty podSelector selects all pods\"\
        \n    fi\n\n    if grep -q 'namespaceSelector: {}' \"$file\"; then\n     \
        \ echo \"::warning file=$file::Empty namespaceSelector selects all namespaces\"\
        \n    fi\n\n    # Ensure egress or ingress is defined\n    if ! grep -qE '(egress:|ingress:)'\
        \ \"$file\"; then\n      echo \"::warning file=$file::NetworkPolicy has no\
        \ egress or ingress rules\"\n    fi\n  done < /tmp/netpols.txt\nelse\n  echo\
        \ \"No NetworkPolicy manifests found\"\nfi\n"
  resource-check:
    name: Resource Requirements Check
    runs-on: ubuntu-latest
    needs: yaml-lint
    steps:
    - name: Checkout repository
      uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8
    - name: Check resource definitions
      run: "echo \"=== Checking resource requirements ===\"\n\n# Find deployments,\
        \ statefulsets, daemonsets\nfind . -type f \\( -name '*.yaml' -o -name '*.yml'\
        \ \\) \\\n  ! -path './.git/*' \\\n  -exec grep -l -E 'kind: (Deployment|StatefulSet|DaemonSet|Job|CronJob)'\
        \ {} \\; 2>/dev/null > /tmp/workloads.txt || true\n\nif [ -s /tmp/workloads.txt\
        \ ]; then\n  while read file; do\n    echo \"Checking: $file\"\n\n    # Check\
        \ for resource limits\n    if ! grep -q 'limits:' \"$file\"; then\n      echo\
        \ \"::warning file=$file::No resource limits defined\"\n    fi\n\n    # Check\
        \ for resource requests\n    if ! grep -q 'requests:' \"$file\"; then\n  \
        \    echo \"::warning file=$file::No resource requests defined\"\n    fi\n\
        \n    # Check for liveness/readiness probes\n    if ! grep -q 'livenessProbe:'\
        \ \"$file\"; then\n      echo \"::notice file=$file::No livenessProbe defined\"\
        \n    fi\n\n    if ! grep -q 'readinessProbe:' \"$file\"; then\n      echo\
        \ \"::notice file=$file::No readinessProbe defined\"\n    fi\n  done < /tmp/workloads.txt\n\
        fi\n"
  summary:
    name: Validation Summary
    runs-on: ubuntu-latest
    needs:
    - yaml-lint
    - kubeconform
    - kube-linter
    - deprecated-apis
    - netpol-check
    - resource-check
    if: always()
    steps:
    - name: Generate summary
      run: 'echo "## Manifest Validation Results" >> $GITHUB_STEP_SUMMARY

        echo "" >> $GITHUB_STEP_SUMMARY

        echo "| Check | Status |" >> $GITHUB_STEP_SUMMARY

        echo "|-------|--------|" >> $GITHUB_STEP_SUMMARY

        echo "| YAML Lint | ${{ needs.yaml-lint.result }} |" >> $GITHUB_STEP_SUMMARY

        echo "| Kubeconform | ${{ needs.kubeconform.result }} |" >> $GITHUB_STEP_SUMMARY

        echo "| Kube-linter | ${{ needs.kube-linter.result }} |" >> $GITHUB_STEP_SUMMARY

        echo "| Deprecated APIs | ${{ needs.deprecated-apis.result }} |" >> $GITHUB_STEP_SUMMARY

        echo "| NetworkPolicy | ${{ needs.netpol-check.result }} |" >> $GITHUB_STEP_SUMMARY

        echo "| Resources | ${{ needs.resource-check.result }} |" >> $GITHUB_STEP_SUMMARY

        echo "" >> $GITHUB_STEP_SUMMARY

        echo "---" >> $GITHUB_STEP_SUMMARY

        echo "*Validation completed at $(date -u +''%Y-%m-%d %H:%M:%S UTC'')*" >>
        $GITHUB_STEP_SUMMARY

        '
'on':
  push:
    branches:
    - main
  pull_request:
    branches:
    - main
