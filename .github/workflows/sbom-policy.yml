name: SBOM Policy Enforcement
on:
  workflow_call:
    inputs:
      sbom_path:
        required: true
        type: string
      policy_path:
        required: false
        type: string
        default: .github/policies
    outputs:
      policy_passed:
        description: Whether policy checks passed
        value: ${{ jobs.policy-check.outputs.passed }}
defaults:
  run:
    shell: bash
jobs:
  policy-check:
    runs-on: self-hosted
    outputs:
      passed: ${{ steps.conftest.outcome == 'success' }}
    steps:
    - name: Checkout
      uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8
    - name: Install Conftest
      run: 'wget https://github.com/open-policy-agent/conftest/releases/download/v0.49.1/conftest_0.49.1_Linux_x86_64.tar.gz

        tar xzf conftest_0.49.1_Linux_x86_64.tar.gz

        sudo mv conftest /usr/local/bin/

        conftest --version

        '
    - name: Download SBOM artifact
      uses: actions/download-artifact@018cc2cf5baa6db3ef3c5f8a56943fffe632ef53
      with:
        name: ${{ inputs.sbom_path }}
    - name: Run policy checks
      id: conftest
      continue-on-error: true
      run: "set -e\nSBOM_FILE=$(ls sbom-*.xml 2>/dev/null | head -n1 || echo '')\n\
        if [ -z \"$SBOM_FILE\" ]; then\n  echo \"No SBOM file found in artifact\"\
        \ >&2\n  exit 1\nfi\necho \"Running Conftest policy checks on $SBOM_FILE\"\
        \nconftest test \"$SBOM_FILE\" --policy \"${{ inputs.policy_path }}\" --output\
        \ json | tee policy_results.json\n# Check if violations exist\nviolations=$(jq\
        \ -r '.[] | select(.failures != null) | .failures | length' policy_results.json\
        \ | awk '{s+=$1} END {print s}')\nif [ \"$violations\" -gt 0 ]; then\n  echo\
        \ \"Policy violations detected: $violations\" >&2\n  exit 1\nfi\n"
    - name: Upload policy results
      if: always()
      uses: actions/upload-artifact@330a01c490aca151604b8cf639adc76d48f6c5d4
      with:
        name: sbom-policy-results
        path: policy_results.json
        retention-days: 30
    - name: Summarize policy check
      if: always()
      run: "if [ \"${{ steps.conftest.outcome }}\" = \"success\" ]; then\n  echo \"\
        ? SBOM policy checks passed\" >> $GITHUB_STEP_SUMMARY\nelse\n  echo \"? SBOM\
        \ policy checks failed\" >> $GITHUB_STEP_SUMMARY\n  if [ -f policy_results.json\
        \ ]; then\n    echo \"Violations:\" >> $GITHUB_STEP_SUMMARY\n    jq -r '.[]\
        \ | select(.failures != null) | .failures[]' policy_results.json >> $GITHUB_STEP_SUMMARY\n\
        \  fi\nfi\n"