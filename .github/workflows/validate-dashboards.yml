name: Validate legacy Grafana dashboards (deprecated)

on:
  push:
    paths:
      - 'grafana/dashboards/**'
  pull_request:
    paths:
      - 'grafana/dashboards/**'


defaults:
  run:
    shell: bash

jobs:
  validate:
    runs-on: self-hosted
    concurrency:
      group: validate-legacy-dashboards-${{ github.ref }}
      cancel-in-progress: true
    permissions:
      contents: read
    timeout-minutes: 10
    steps:
      - uses: actions/checkout@v4

      - name: Validate JSON schema
        run: |
          if ls grafana/dashboards/*.json 1> /dev/null 2>&1; then
            for dashboard in grafana/dashboards/*.json; do
              echo "Validating $dashboard..."
              jq empty "$dashboard" || { echo "Invalid JSON in $dashboard"; exit 1; }
            done
          else
            echo "No dashboards under grafana/dashboards; repo has moved to monitoring/grafana/dashboards/."
          fi
      - name: Upload dashboard files on failure
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: legacy-dashboard-files
          path: |
            grafana/dashboards/*.json

      - name: Check dashboard IDs
        run: |
          if ls grafana/dashboards/*.json 1> /dev/null 2>&1; then
            for dashboard in grafana/dashboards/*.json; do
              id=$(jq -r '.dashboard.id' "$dashboard")
              if [ "$id" != "null" ]; then
                echo "Error: Dashboard $dashboard has hardcoded ID. Should be null."
                exit 1
              fi
            done
          else
            echo "No legacy dashboards to check."
          fi

      - name: Note canonical dashboards path
        run: |
          echo "Canonical dashboards now live under monitoring/grafana/dashboards/."
