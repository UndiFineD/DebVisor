name: Build Synthetic Metrics Generator
on:
  push:
    paths:
    - monitoring/fixtures/generator/**
    - monitoring/fixtures/edge-lab-deployment.yaml
  pull_request:
    paths:
    - monitoring/fixtures/generator/**
    - monitoring/fixtures/edge-lab-deployment.yaml
  workflow_dispatch: null
defaults:
  run:
    shell: bash
jobs:
  docker-build:
    runs-on: self-hosted
    permissions:
      contents: read
    timeout-minutes: 45
    steps:
    - name: Platform guard
      id: platform
      run: "if [ \"$RUNNER_OS\" = \"Linux\" ]; then\n  echo \"run_linux=true\" >>\
        \ \"$GITHUB_OUTPUT\"\nelse\n  echo \"run_linux=false\" >> \"$GITHUB_OUTPUT\"\
        \n  echo \"::notice title=Skipped::Synthetic metrics generator build requires\
        \ Linux (Docker buildx multi-arch).\"\nfi\n"
    - name: Checkout
      if: steps.platform.outputs.run_linux == 'true'
      uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8
    - name: Set up QEMU (multi-arch)
      if: steps.platform.outputs.run_linux == 'true'
      uses: docker/setup-qemu-action@c7c53464625b32c7a7e944ae62b3e17d2b600130
    - name: Set up Docker Buildx
      if: steps.platform.outputs.run_linux == 'true'
      uses: docker/setup-buildx-action@e468171a9de216ec08956ac3ada2f0791b6bd435
      with:
        driver-opts: image=moby/buildkit:latest
    - name: Build (no push)
      if: steps.platform.outputs.run_linux == 'true'
      uses: docker/build-push-action@263435318d21b8e681c14492fe198d362a7d2c83
      with:
        context: ./monitoring/fixtures/generator
        push: false
        tags: debvisor/synthetic-metrics:local
        platforms: linux/amd64,linux/arm64
        cache-from: type=gha
        cache-to: type=gha,mode=max