name: Merge Guard (Validator Status)
on:
  pull_request:
    types:
    - opened
    - synchronize
    - reopened
defaults:
  run:
    shell: bash
jobs:
  check-validator-status:
    runs-on: self-hosted
    steps:
    - name: Check validator workflow status
      uses: actions/github-script@ed597411d8f924073f98dfc5c65a23a2325f34cd
      with:
        script: "const { data: checkRuns } = await github.rest.checks.listForRef({\n\
          \  owner: context.repo.owner,\n  repo: context.repo.repo,\n  ref: context.payload.pull_request.head.sha,\n\
          });\n\nconst validatorJobs = checkRuns.check_runs.filter(run =>\n  run.name\
          \ === 'validate-blocklists-windows' || run.name === 'validate-blocklists-linux'\n\
          );\n\nconst anyFailed = validatorJobs.some(job => job.conclusion === 'failure');\n\
          const allCompleted = validatorJobs.every(job => job.status === 'completed');\n\
          \nif (anyFailed) {\n  await github.rest.issues.createComment({\n    owner:\
          \ context.repo.owner,\n    repo: context.repo.repo,\n    issue_number: context.payload.pull_request.number,\n\
          \    body: '[warn]? **Blocklist validation failed.** Please fix CIDR errors\
          \ before merging.\\n\\nCheck the [workflow runs](https://github.com/' +\
          \ context.repo.owner + '/' + context.repo.repo + '/actions) for details.',\n\
          \  });\n  core.setFailed('Blocklist validation failed. Merge blocked.');\n\
          } else if (allCompleted && validatorJobs.length > 0) {\n  core.info('All\
          \ validator checks passed.');\n} else {\n  core.info('Validator checks are\
          \ still running or not applicable.');\n}\n"
'on':
  push:
    branches:
    - main
  pull_request:
    branches:
    - main
