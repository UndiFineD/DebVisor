name: Merge Guard (Validator Status)

on:
  pull_request:
    types: [opened, synchronize, reopened]


defaults:
  run:
    shell: pwsh

jobs:
  check-validator-status:
    runs-on: self-hosted
    steps:
      - name: Check validator workflow status
        uses: actions/github-script@v7
        with:
          script: |
            const { data: checkRuns } = await github.rest.checks.listForRef({
              owner: context.repo.owner,
              repo: context.repo.repo,
              ref: context.payload.pull_request.head.sha,
            });

            const validatorJobs = checkRuns.check_runs.filter(run => 
              run.name === 'validate-blocklists-windows' || run.name === 'validate-blocklists-linux'
            );

            const anyFailed = validatorJobs.some(job => job.conclusion === 'failure');
            const allCompleted = validatorJobs.every(job => job.status === 'completed');

            if (anyFailed) {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.payload.pull_request.number,
                body: '[warn]? **Blocklist validation failed.** Please fix CIDR errors before merging.\n\nCheck the [workflow runs](https://github.com/' + context.repo.owner + '/' + context.repo.repo + '/actions) for details.',
              });
              core.setFailed('Blocklist validation failed. Merge blocked.');
            } else if (allCompleted && validatorJobs.length > 0) {
              core.info('All validator checks passed.');
            } else {
              core.info('Validator checks are still running or not applicable.');
            }
