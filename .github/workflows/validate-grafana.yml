name: Validate Grafana Dashboards
on:
  pull_request:
    paths:
    - monitoring/grafana/dashboards/*.json
  push:
    branches:
    - main
    paths:
    - monitoring/grafana/dashboards/*.json
defaults:
  run:
    shell: bash
jobs:
  validate:
    runs-on: self-hosted
    concurrency:
      group: validate-grafana-${{ github.ref }}
      cancel-in-progress: true
    permissions:
      contents: read
    timeout-minutes: 20
    steps:
    - uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8
    - uses: actions/setup-node@395ad3262231945c25e8478fd5baf05154b1d79f
      with:
        node-version: '20'
        cache: npm
    - name: Cache npm
      uses: actions/cache@0057852bfaa89a56745cba8c7296529d2fc39830
      with:
        path: ~/.npm
        key: grafana-validator-${{ runner.os }}-node20
    - name: Install validator
      run: npm ci && npm install -g @grafana/dashboard-validator
    - name: Validate
      run: ": > /tmp/grafana-validator.log\ntotal=0; fails=0\nfor f in monitoring/grafana/dashboards/*.json;\
        \ do\n  echo \"Validating $f\" | tee -a /tmp/grafana-validator.log\n  if grafana-dashboard-validator\
        \ \"$f\" >> /tmp/grafana-validator.log 2>&1; then\n    total=$((total+1))\n\
        \  else\n    total=$((total+1))\n    fails=$((fails+1))\n    echo \"::error\
        \ file=${f},line=1::Grafana validator reported an issue\"\n  fi\ndone\necho\
        \ \"### Grafana Dashboard Validation\" >> \"$GITHUB_STEP_SUMMARY\"\necho \"\
        - Files checked: ${total}\" >> \"$GITHUB_STEP_SUMMARY\"\necho \"- Failures:\
        \ ${fails}\" >> \"$GITHUB_STEP_SUMMARY\"\necho \"\\nLast 20 log lines:\" >>\
        \ \"$GITHUB_STEP_SUMMARY\"\ntail -n 20 /tmp/grafana-validator.log >> \"$GITHUB_STEP_SUMMARY\"\
        \n"
    - name: Upload Grafana validator log
      if: always()
      uses: actions/upload-artifact@330a01c490aca151604b8cf639adc76d48f6c5d4
      with:
        name: grafana-validator-log
        path: /tmp/grafana-validator.log
    - name: Upload validator logs
      if: failure()
      uses: actions/upload-artifact@330a01c490aca151604b8cf639adc76d48f6c5d4
      with:
        name: grafana-validator-logs
        path: '**/*.log'
'on':
  push:
    branches:
    - main
  pull_request:
    branches:
    - main
