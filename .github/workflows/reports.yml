name: Generate Security and Notifications Reports
on:
  push:
    branches:
    - main
  workflow_dispatch: null
  schedule:
  - cron: 0 6 * * *
permissions:
  contents: read
  pull-requests: write
  security-events: read
jobs:
  generate-reports:
    runs-on: ubuntu-latest
    steps:
    - name: Checkout
      uses: actions/checkout@v4
    - name: Setup Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.12'
    - name: Install dependencies
      run: 'python -m pip install --upgrade pip

        pip install pymarkdownlnt

        '
    - name: Generate Security Report
      env:
        GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      run: 'sudo apt-get update && sudo apt-get install -y gh

        gh auth setup-git

        python scripts/generate_security_report_v2.py

        '
    - name: Generate Notifications Report
      env:
        GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      run: 'python scripts/generate_notifications_report.py

        '
    - name: Upload Reports
      uses: actions/upload-artifact@v4
      with:
        name: reports
        path: 'security-scan.md

          security-scan-summary.json

          notifications-report.md

          '
        retention-days: 14
    - name: Post summary comment on PR
      if: github.event_name == 'pull_request'
      env:
        GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      run: "cat > pr_comment.py <<'PYSCRIPT'\nimport json, os\ntotal=open_cnt=0\n\
        sev={'critical':0,'high':0,'medium':0,'low':0}\ntry:\n  with open('security-scan-summary.json','r',encoding='utf-8')\
        \ as f:\n    d=json.load(f)\n    total=d.get('total_alerts',0)\n    open_cnt=d.get('open_alerts',0)\n\
        \    s=d.get('by_severity',{})\n    for k in sev:\n      sev[k]=int(s.get(k,0))\n\
        except Exception:\n  pass\nunread=0\ntry:\n  with open('notifications-report.md','r',encoding='utf-8')\
        \ as f:\n    for line in f:\n      if line.strip().startswith('**Unread Notifications:**'):\n\
        \        try:\n          unread=int(''.join([c for c in line if c.isdigit()]))\n\
        \        except Exception:\n          pass\n        break\nexcept Exception:\n\
        \  pass\nserver=os.environ.get('GITHUB_SERVER_URL','https://github.com')\n\
        repo=os.environ.get('GITHUB_REPOSITORY','')\nrun_id=os.environ.get('GITHUB_RUN_ID','')\n\
        artifacts_url=f\"{server}/{repo}/actions/runs/{run_id}\"\nprint(f\"### Reports\
        \ Summary\\n- Security Alerts: {total} (open: {open_cnt})\\n- Severity \u2014\
        \ critical: {sev['critical']}, high: {sev['high']}, medium: {sev['medium']},\
        \ low: {sev['low']}\\n- Unread Notifications: {unread}\\n\\nArtifacts: [View\
        \ run artifacts]({artifacts_url})\")\nPYSCRIPT\npython pr_comment.py > /tmp/pr_body.md\n\
        gh pr comment ${{ github.event.pull_request.number }} --body-file /tmp/pr_body.md\n"
    - name: Add job summary
      run: "python - <<'PY'\nimport json, os\ntotal=open_cnt=0\nsev={'critical':0,'high':0,'medium':0,'low':0}\n\
        try:\n  with open('security-scan-summary.json','r',encoding='utf-8') as f:\n\
        \    d=json.load(f)\n    total=d.get('total_alerts',0)\n    open_cnt=d.get('open_alerts',0)\n\
        \    s=d.get('by_severity',{})\n    for k in sev:\n      sev[k]=int(s.get(k,0))\n\
        except Exception:\n  pass\ncontent=f\"\"\"### Reports Summary\n- Security\
        \ Alerts: {total} (open: {open_cnt})\n- Severity \u2014 critical: {sev['critical']},\
        \ high: {sev['high']}, medium: {sev['medium']}, low: {sev['low']}\n\nArtifacts:\
        \ security-scan.md, security-scan-summary.json, notifications-report.md\n\"\
        \"\"\nwith open(os.environ.get('GITHUB_STEP_SUMMARY','/tmp/summary.md'),'a',encoding='utf-8')\
        \ as fh:\n  fh.write(content)\nPY\n"
    - name: Enforce policy thresholds
      run: "python - <<'PY'\nimport json, sys\n# Default thresholds (can be parameterized\
        \ later)\nMAX_CRITICAL=0\nMAX_HIGH=0\ntry:\n  with open('security-scan-summary.json','r',encoding='utf-8')\
        \ as f:\n    d=json.load(f)\n    sev=d.get('by_severity',{})\n    crit=int(sev.get('critical',0))\n\
        \    high=int(sev.get('high',0))\nexcept Exception as e:\n  print(f\"Warning:\
        \ cannot read summary JSON: {e}\")\n  crit=high=0\nif crit>MAX_CRITICAL or\
        \ high>MAX_HIGH:\n  print(f\"Policy violation: critical={crit} (max {MAX_CRITICAL}),\
        \ high={high} (max {MAX_HIGH})\")\n  sys.exit(1)\nelse:\n  print(f\"Policy\
        \ OK: critical={crit} <= {MAX_CRITICAL}, high={high} <= {MAX_HIGH}\")\nPY\n"
'on':
  push:
    branches:
    - main
  pull_request:
    branches:
    - main
