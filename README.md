# DebVisor\n\nDebVisor is a Debian?based mini hyper?converged hypervisor distro focused on:\n\n- Virtualization (KVM/QEMU + libvirt + Cockpit)\n\n- Storage (CephFS?first, optional ZFS, Mixed mode)\n\n- Containers (Docker + Compose) and Kubernetes (kubeadm + containerd)\n\n- Low?friction installer (ncurses) with minimal choices\n\n- Automated first?boot provisioning (Ceph/ZFS/K8s/Docker/libvirt/bridge networking)\n\n## Project Layout\n\n    README.md                              - Overview\n    DebVisor_initial.md                    - Raw brainstorming (legacy source)\n    context.md                             - Session history & progress tracking\n    improvements.md                        - Enhancement roadmap & completed work\n    IMPROVEMENTS_SUMMARY.md                - Detailed summary of completed improvements\n    PROGRESS_DASHBOARD.md                  - Feature completion & code metrics\n    RUNNER_FIX_SUMMARY.md                  - CI/CD runner configuration & fixes\n    docs/architecture.md                   - High level architecture & stack\n    docs/core-components.md               - Packages & roles\n    docs/profiles.md                      - Storage / deployment profiles\n    docs/operations.md                    - Operational defaults & safeguards\n    docs/network-config-tui.md            - Network Config TUI (usage & features)\n    docs/install/ISO_BUILD.md             - ISO build & installer integration\n    etc/README.md                         - System configuration & maintenance tasks\n      etc/debvisor/                       - Blocklist validation & examples\n      etc/default/                        - Service environment variables\n      etc/systemd/system/                 - Systemd services & timers (Ceph, ZFS)\n    opt/README.md                         - Build automation & operational infrastructure\n      opt/ansible/                        - Configuration management & orchestration\n      opt/build/                          - ISO building scripts\n      opt/config/                         - Live-build configuration\n      opt/docker/addons/                  - Container & Kubernetes addons\n      opt/docs/                           - Comprehensive documentation\n      opt/grafana/                        - Monitoring dashboards\n      opt/monitoring/                     - Prometheus & observability\n      opt/services/rpc/                   - gRPC RPC service\n    usr/README.md                         - Operational tools & system services\n      usr/local/bin/                      - Operational scripts & CLIs\n      usr/lib/systemd/system/             - Systemd service units\n      usr/libexec/                        - Helper scripts for services\n      usr/share/debvisor/                 - Static data & configuration\n    device/ (future hardware specific overrides)\n    config/preseed.cfg                    - Debian Installer preseed (curses + profile)\n    config/package-lists/debvisor.list.chroot - Live?build package manifest\n    config/hooks/normal/*.sh              - Hook scripts to ensure components\n    config/includes.chroot/usr/local/sbin/debvisor-firstboot.sh - First boot provisioning\n    config/includes.chroot/etc/systemd/system/debvisor-firstboot.service - Systemd unit\n    build/build-debvisor.sh               - One?shot ISO build script\n    Makefile                              - Convenience wrapper\n    tests/                                - Unit & integration tests\n    .github/workflows/                    - CI/CD pipelines\n\n## Enterprise Features\n\nDebVisor includes a suite of enterprise-grade features for large-scale deployments:\n\n- **Multi-Cluster Management:** Unified control plane for managing multiple DebVisor clusters with failover and resource federation.\n\n- **Advanced Network Configuration:** Full TUI (`netcfg-tui`) for configuring complex network topologies (Bonds, VLANs, Bridges) with rollback support.\n\n- **Plugin Architecture:** Extensible system for adding custom storage, network, or monitoring providers.\n\n- **End-to-End Testing:** Comprehensive E2E framework for validating deployments and upgrades.\n\n- **Advanced Documentation:** Architecture Decision Records (ADRs) and operational playbooks.\n\n## Quick Start (Build ISO)\n\n    sudo apt update\n    sudo apt install -y live-build debootstrap xorriso squashfs-tools git\n    ./build/build-debvisor.sh\n\n## Result: live-image-amd64.hybrid.iso\n\nThe `build/build-debvisor.sh` script automatically runs\n`build/sync-addons-playbook.sh` before creating the ISO. This keeps\nthe embedded `bootstrap-addons.yml`in`config/includes.chroot` in\nsync with the source Ansible playbook so that addon enablement during\nfirst boot always matches the repository.\n\n## Profiles\n\n- ceph (default): All non?OS disks become Ceph OSDs; CephFS mounted at /srv/cephfs; RBD pool for VM disks\n\n- zfs: Non?OS disks aggregated into ZFS pool `tank`; datasets for vm/docker/k8s\n\n- mixed: CephFS for shared (RWX) + ZFS for local performance datasets\n\n## First Boot\n\nSystemd unit sources `/etc/debvisor-profile` (written by installer). Script provisions:\n\n- Bridge `br0`, KVM modules, libvirt default pool\n\n- Ceph (MON/MGR/OSD/MDS, rbd & CephFS pools) if ceph/mixed\n\n- ZFS pool + datasets if zfs/mixed\n\n- Docker daemon defaults\n\n- Kubernetes single-node (Calico CNI, control-plane taint removal)\n\n- Firewall: SSH(22), Cockpit(9090), K8s API(6443)\n\n## Maintenance & Operations\n\nDebVisor includes automated maintenance services for system health and longevity:\n\n### Ceph Health Checking\n\n- **Service:** `ceph-health.service` (oneshot) + `ceph-health.timer` (hourly)\n\n- **Function:** Periodically checks Ceph cluster health status\n\n- **Logs:** Systemd journal (`journalctl -u ceph-health.service`)\n\n- **Management:** See [etc/README.md](etc/README.md) for configuration and troubleshooting\n\n### ZFS Pool Scrubbing\n\n- **Service:** `zfs-scrub-weekly.service` (oneshot) + `zfs-scrub-weekly.timer` (weekly, Sunday 2 AM)\n\n- **Function:** Performs data integrity checks, detects silent corruption\n\n- **Configuration:** `/etc/default/debvisor-zfs-scrub` (includes detailed tuning guide)\n\n- **Timeout:** Configurable per pool size (default 2 hours, suitable for 1-10 TB pools)\n\n- **Logs:** Systemd journal (`journalctl -u zfs-scrub-weekly.service`)\n\n- --\n\n## Supply Chain Security\n\nDebVisor implements comprehensive software supply chain security following **SLSA Build Level 3** and industry best practices:\n\n### Security Features\n\n- **[KEY] Cryptographic Signing**: GPG-signed release artifacts and container images\n\n- **[SBOM] Dual SBOM Formats**: CycloneDX + SPDX for maximum compatibility\n\n- **[POLICY] Policy Enforcement**: OPA/Conftest validates SBOM quality (10+ components, versions, licenses)\n\n- **[SIGN] Cosign Attestations**: Keyless signing with Rekor transparency log\n\n- **[SLSA] SLSA Provenance**: Verifiable build provenance with source/tag matching\n\n- **[VEX] VEX Documents**: Vulnerability Exploitability eXchange for security context\n\n- **[LOOP] Continuous Verification**: Nightly re-verification of release integrity\n\n- **[ANCHOR] Predicate Digests**: Cryptographic anchors for attestation validation\n\n### Quick Verification\n\n```bash\n# Download release\ngh release download v1.0.0\n# Verify GPG signature\ngpg --verify debvisor-1.0.0.tar.gz.asc debvisor-1.0.0.tar.gz\n# Check SHA256 checksums\nsha256sum -c debvisor-1.0.0.tar.gz.sha256\n# Verify container provenance\nslsa-verifier verify-image ghcr.io/undefind/debvisor:1.0.0 \\n\n- -source-uri github.com/UndiFineD/DebVisor\n# Verify SBOM attestations\ncosign verify-attestation --type cyclonedx ghcr.io/undefind/debvisor:1.0.0\n```text\ngh release download v1.0.0\n\n## Verify GPG signature\n\ngpg --verify debvisor-1.0.0.tar.gz.asc debvisor-1.0.0.tar.gz\n\n## Check SHA256 checksums\n\nsha256sum -c debvisor-1.0.0.tar.gz.sha256\n\n## Verify container provenance\n\nslsa-verifier verify-image ghcr.io/undefind/debvisor:1.0.0 \\n\n- -source-uri github.com/UndiFineD/DebVisor\n\n## Verify SBOM attestations\n\ncosign verify-attestation --type cyclonedx ghcr.io/undefind/debvisor:1.0.0\n```text\n## Download release\n\ngh release download v1.0.0\n\n## Verify GPG signature (2)\n\ngpg --verify debvisor-1.0.0.tar.gz.asc debvisor-1.0.0.tar.gz\n\n## Check SHA256 checksums (2)\n\nsha256sum -c debvisor-1.0.0.tar.gz.sha256\n\n## Verify container provenance (2)\n\nslsa-verifier verify-image ghcr.io/undefind/debvisor:1.0.0 \\n\n- -source-uri github.com/UndiFineD/DebVisor\n\n## Verify SBOM attestations (2)\n\ncosign verify-attestation --type cyclonedx ghcr.io/undefind/debvisor:1.0.0\n```text\n\ngh release download v1.0.0\n\n## Verify GPG signature (3)\n\ngpg --verify debvisor-1.0.0.tar.gz.asc debvisor-1.0.0.tar.gz\n\n## Check SHA256 checksums (3)\n\nsha256sum -c debvisor-1.0.0.tar.gz.sha256\n\n## Verify container provenance (3)\n\nslsa-verifier verify-image ghcr.io/undefind/debvisor:1.0.0 \\n\n- -source-uri github.com/UndiFineD/DebVisor\n\n## Verify SBOM attestations (3)\n\ncosign verify-attestation --type cyclonedx ghcr.io/undefind/debvisor:1.0.0\n```text\n## Download release (2)\ngh release download v1.0.0\n## Verify GPG signature (4)\ngpg --verify debvisor-1.0.0.tar.gz.asc debvisor-1.0.0.tar.gz\n## Check SHA256 checksums (4)\nsha256sum -c debvisor-1.0.0.tar.gz.sha256\n## Verify container provenance (4)\nslsa-verifier verify-image ghcr.io/undefind/debvisor:1.0.0 \\n\n- -source-uri github.com/UndiFineD/DebVisor\n## Verify SBOM attestations (4)\ncosign verify-attestation --type cyclonedx ghcr.io/undefind/debvisor:1.0.0\n```text\n\ngh release download v1.0.0\n\n## Verify GPG signature (5)\n\ngpg --verify debvisor-1.0.0.tar.gz.asc debvisor-1.0.0.tar.gz\n\n## Check SHA256 checksums (5)\n\nsha256sum -c debvisor-1.0.0.tar.gz.sha256\n\n## Verify container provenance (5)\n\nslsa-verifier verify-image ghcr.io/undefind/debvisor:1.0.0 \\n\n- -source-uri github.com/UndiFineD/DebVisor\n\n## Verify SBOM attestations (5)\n\ncosign verify-attestation --type cyclonedx ghcr.io/undefind/debvisor:1.0.0\n```text\ngh release download v1.0.0\n\n## Verify GPG signature (6)\n\ngpg --verify debvisor-1.0.0.tar.gz.asc debvisor-1.0.0.tar.gz\n\n## Check SHA256 checksums (6)\n\nsha256sum -c debvisor-1.0.0.tar.gz.sha256\n\n## Verify container provenance (6)\n\nslsa-verifier verify-image ghcr.io/undefind/debvisor:1.0.0 \\n\n- -source-uri github.com/UndiFineD/DebVisor\n\n## Verify SBOM attestations (6)\n\ncosign verify-attestation --type cyclonedx ghcr.io/undefind/debvisor:1.0.0\n```text\n\n## Verify GPG signature (7)\n\ngpg --verify debvisor-1.0.0.tar.gz.asc debvisor-1.0.0.tar.gz\n\n## Check SHA256 checksums (7)\n\nsha256sum -c debvisor-1.0.0.tar.gz.sha256\n\n## Verify container provenance (7)\n\nslsa-verifier verify-image ghcr.io/undefind/debvisor:1.0.0 \\n\n- -source-uri github.com/UndiFineD/DebVisor\n\n## Verify SBOM attestations (7)\n\ncosign verify-attestation --type cyclonedx ghcr.io/undefind/debvisor:1.0.0\n```text\n\n- *Full Documentation**: [docs/SUPPLY_CHAIN_SECURITY.md](docs/SUPPLY_CHAIN_SECURITY.md)\n\n- --\n## Network Configuration\n- **Management:** See [etc/README.md](etc/README.md) for customization and monitoring\n### Blocklist Management\n- **Validation:** `etc/debvisor/validate-blocklists.sh` (CIDR syntax, overlap detection)\n\n- **Integrity:** `etc/debvisor/verify-blocklist-integrity.sh` (checksums, format verification)\n\n- **Examples:** `blocklist-example.txt`, `blocklist-whitelist-example.txt`\n\n- **Testing:** GitHub Actions validates all blocklists on commit\n\n- **Details:** See [etc/debvisor/](etc/debvisor/) for configuration formats and usage\n### Production Deployment Checklist\n- [ ] Enable maintenance timers: `systemctl enable ceph-health.timer zfs-scrub-weekly.timer`\n\n- [ ] Configure ZFS timeout for your pool size in `/etc/default/debvisor-zfs-scrub`\n\n- [ ] Customize timer schedules if not aligned with your maintenance window\n\n- [ ] Set up log aggregation or alerts for service failures\n\n- [ ] For multi-node clusters, stagger scrub schedules to prevent simultaneous I/O\n\n- [ ] Test manual execution: `systemctl start zfs-scrub-weekly.service`\n\n- [ ] Monitor service logs during first automated run\n### Modes\n- `/etc/debvisor-mode` controls behavior:\n\n- `lab`(default): ensures`root`,`node`,`monitor` users exist (non-root locked), convenience defaults.\n\n- `prod`: only ensures`root` user; create additional accounts via your own workflow.\n### Addons\n- Global config: `/etc/debvisor-addons.conf` with flags:\n\n- `ADDON_RPC_SERVICE`,`ADDON_WEB_PANEL`,`ADDON_VNC_CONSOLE`,`ADDON_MONITORING_STACK`(`yes`/`no`).\n\n- Profile defaults: `/etc/debvisor-addons.d/.conf` provide sensible per-profile defaults if no global file exists.\n\n- On first boot, an Ansible playbook (`bootstrap-addons.yml`) runs locally (when present) to apply addon roles:\n\n- `rpc-service`,`web-panel`,`vnc-console`,`monitoring-stack` (shipped as safe stubs you can extend).\n### Dry Run\n- You can test the first boot logic non-destructively with:\n\n- `debvisor-firstboot.sh --dry-run`\n\n- In dry-run mode, provisioning steps only log intended actions; no disks/users/services are modified.\n## Improvements & Operational Excellence\nDebVisor includes comprehensive improvements across all system components to ensure production-readiness:\n### Phase 1: Documentation & Configuration (? Complete)\n- Enhanced systemd unit files with timeout protection, retry logic, and security sandboxing\n\n- Comprehensive README files for `etc/`,`opt/`, and`usr/` directories\n\n- Production deployment checklists and troubleshooting guides\n\n- ZFS pool sizing formulas and multi-pool configuration support\n\n- See [SESSION_COMPLETION_REPORT.md](SESSION_COMPLETION_REPORT.md) for details\n### Phase 2: Operational Scripts & CI/CD (? Complete)\n- **Shared bash library** (`usr/local/bin/debvisor-lib.sh`) with 50+ reusable functions\n\n- Consistent logging, error handling, retry logic\n\n- Infrastructure validation (Ceph, Kubernetes, ZFS)\n\n- Safe operation patterns (dry-run, confirm, execute)\n\n- **Enhanced scripts** with `--dry-run`, `--check`, `--verbose` modes\n\n- `debvisor-join.sh`: Join nodes to cluster with comprehensive validation\n\n- `debvisor-upgrade.sh`: Orchestrated cluster upgrades with checkpoints\n\n- Full audit logging and error recovery\n\n- **CI/CD validation workflow** (`.github/workflows/validate-syntax.yml`)`)\n\n- systemd unit validation with `systemd-analyze`\n\n- Shell script linting with `shellcheck`\n\n- Ansible playbook syntax checking\n\n- Cross-component consistency validation\n\n- **Component validator** (`opt/validate-components.sh`)\n\n- Validates Ansible inventory, package lists, Docker addons\n\n- Checks file permissions and executable status\n\n- Optional auto-fix for common issues\nSee [PHASE_2_SUMMARY.md](PHASE_2_SUMMARY.md) for implementation details and usage examples.\n### Phase 3: RPC Service & Web Panel (Planned)\n- gRPC service implementation with authentication, authorization, TLS\n\n- Web management panel with security hardening\n\n- Integration tests and advanced monitoring\n\n- --\n## Contributing\n1. Propose doc changes in `docs/`\n\n1. Use the shared library (`debvisor-lib.sh`) in new scripts for consistency\n\n1. All scripts should support `--dry-run`,`--check`,`--verbose`,`--log-file` flags\n\n1. Include comprehensive error handling and audit logging\n\n1. Keep scripts idempotent and non-destructive beyond initial provisioning\n\n1. Avoid embedding passwords/keys; rely on installer prompts & environment variables\n\n1. Run validation before submitting: `opt/validate-components.sh`\n## Roadmap (High-Level)\n- Cluster expansion scripts (join additional nodes for Ceph + K8s)\n\n- Ceph CSI & ZFS LocalPV Helm charts under `docker\addons\`\n\n- Metrics stack (Prometheus/Grafana) profile\n\n- Upgrade orchestration (Ansible playbooks)\n## Rate Limiting\n- Web Panel (Flask):\n\n- Set a global default via `RATELIMIT_DEFAULT` in the Flask config (e.g., `"100 per minute"`).\n\n- Use `@limiter.limit("<N> per <period>")` per route for granular control (see `opt/web/panel/routes/auth.py`).\n\n- Login/Register routes include per-IP and per-user limits with lightweight backoff.\n\n- RPC Server (gRPC):\n\n- Configure `/etc/debvisor/rpc/config.json` -> `rate_limit` block:\n\n- `window_seconds`: sliding window duration (seconds)\n\n- `max_calls`: max calls per principal per method within the window\n\n- `method_limits`: per-method overrides, e.g.:\n        {\n          "rate_limit": {\n            "window_seconds": 60,\n            "max_calls": 120,\n            "method_limits": {\n              "/debvisor.StorageService/CreateSnapshot": { "window_seconds": 60, "max_calls": 30 },\n              "/debvisor.StorageService/DeleteSnapshot": { "window_seconds": 60, "max_calls": 20 }\n            }\n          }\n        }\n\n- `method_limits_prefix`: prefix-based defaults for groups of methods, e.g.:\n        {\n          "rate_limit": {\n            "method_limits_prefix": {\n              "/debvisor.StorageService/": { "window_seconds": 60, "max_calls": 30 },\n              "/debvisor.MigrationService/": { "window_seconds": 60, "max_calls": 40 }\n            }\n          }\n        }\n\n- `method_limits_patterns`: regex-based matching for automatic stricter limits on mutating RPCs, e.g.:\n        {\n          "rate_limit": {\n            "method_limits_patterns": [\n              { "pattern": "/debvisor\\.[A-Za-z]+Service/(Create|Delete|Update|Migrate|Plan)$", "window_seconds": 60, "max_calls": 20 }\n            ]\n          }\n        }\n\n- Implemented by `RateLimitingInterceptor` in `opt/services/rpc/server.py`.\n## License\nApache License Version 2.0, January 2004 `license.md`\n## Monitoring\n- Health dashboards: see `docs/monitoring-health-detail.md` for Prometheus/Grafana setup using `/health/detail`.\n\n- Metrics: expose Prometheus metrics at `/metrics`.\n\n- *Full Documentation**: [docs/SUPPLY_CHAIN_SECURITY.md](docs/SUPPLY_CHAIN_SECURITY.md)\n\n- --\n## Network Configuration (2)\n- **Management:** See [etc/README.md](etc/README.md) for customization and monitoring\n### Blocklist Management (2)\n- **Validation:** `etc/debvisor/validate-blocklists.sh` (CIDR syntax, overlap detection)\n\n- **Integrity:** `etc/debvisor/verify-blocklist-integrity.sh` (checksums, format verification)\n\n- **Examples:** `blocklist-example.txt`, `blocklist-whitelist-example.txt`\n\n- **Testing:** GitHub Actions validates all blocklists on commit\n\n- **Details:** See [etc/debvisor/](etc/debvisor/) for configuration formats and usage\n### Production Deployment Checklist (2)\n- [ ] Enable maintenance timers: `systemctl enable ceph-health.timer zfs-scrub-weekly.timer`\n\n- [ ] Configure ZFS timeout for your pool size in `/etc/default/debvisor-zfs-scrub`\n\n- [ ] Customize timer schedules if not aligned with your maintenance window\n\n- [ ] Set up log aggregation or alerts for service failures\n\n- [ ] For multi-node clusters, stagger scrub schedules to prevent simultaneous I/O\n\n- [ ] Test manual execution: `systemctl start zfs-scrub-weekly.service`\n\n- [ ] Monitor service logs during first automated run\n### Modes (2)\n- `/etc/debvisor-mode` controls behavior:\n\n- `lab`(default): ensures`root`,`node`,`monitor` users exist (non-root locked), convenience defaults.\n\n- `prod`: only ensures`root` user; create additional accounts via your own workflow.\n### Addons (2)\n- Global config: `/etc/debvisor-addons.conf` with flags:\n\n- `ADDON_RPC_SERVICE`,`ADDON_WEB_PANEL`,`ADDON_VNC_CONSOLE`,`ADDON_MONITORING_STACK`(`yes`/`no`).\n\n- Profile defaults: `/etc/debvisor-addons.d/.conf` provide sensible per-profile defaults if no global file exists.\n\n- On first boot, an Ansible playbook (`bootstrap-addons.yml`) runs locally (when present) to apply addon roles:\n\n- `rpc-service`,`web-panel`,`vnc-console`,`monitoring-stack` (shipped as safe stubs you can extend).\n### Dry Run (2)\n- You can test the first boot logic non-destructively with:\n\n- `debvisor-firstboot.sh --dry-run`\n\n- In dry-run mode, provisioning steps only log intended actions; no disks/users/services are modified.\n## Improvements & Operational Excellence (2)\nDebVisor includes comprehensive improvements across all system components to ensure production-readiness:\n### Phase 1: Documentation & Configuration (? Complete) (2)\n- Enhanced systemd unit files with timeout protection, retry logic, and security sandboxing\n\n- Comprehensive README files for `etc/`,`opt/`, and`usr/` directories\n\n- Production deployment checklists and troubleshooting guides\n\n- ZFS pool sizing formulas and multi-pool configuration support\n\n- See [SESSION_COMPLETION_REPORT.md](SESSION_COMPLETION_REPORT.md) for details\n### Phase 2: Operational Scripts & CI/CD (? Complete) (2)\n- **Shared bash library** (`usr/local/bin/debvisor-lib.sh`) with 50+ reusable functions\n\n- Consistent logging, error handling, retry logic\n\n- Infrastructure validation (Ceph, Kubernetes, ZFS)\n\n- Safe operation patterns (dry-run, confirm, execute)\n\n- **Enhanced scripts** with `--dry-run`, `--check`, `--verbose` modes\n\n- `debvisor-join.sh`: Join nodes to cluster with comprehensive validation\n\n- `debvisor-upgrade.sh`: Orchestrated cluster upgrades with checkpoints\n\n- Full audit logging and error recovery\n\n- **CI/CD validation workflow** (`.github/workflows/validate-syntax.yml`)`)\n\n- systemd unit validation with `systemd-analyze`\n\n- Shell script linting with `shellcheck`\n\n- Ansible playbook syntax checking\n\n- Cross-component consistency validation\n\n- **Component validator** (`opt/validate-components.sh`)\n\n- Validates Ansible inventory, package lists, Docker addons\n\n- Checks file permissions and executable status\n\n- Optional auto-fix for common issues\nSee [PHASE_2_SUMMARY.md](PHASE_2_SUMMARY.md) for implementation details and usage examples.\n### Phase 3: RPC Service & Web Panel (Planned) (2)\n- gRPC service implementation with authentication, authorization, TLS\n\n- Web management panel with security hardening\n\n- Integration tests and advanced monitoring\n\n- --\n## Contributing (2)\n1. Propose doc changes in `docs/`\n\n1. Use the shared library (`debvisor-lib.sh`) in new scripts for consistency\n\n1. All scripts should support `--dry-run`,`--check`,`--verbose`,`--log-file` flags\n\n1. Include comprehensive error handling and audit logging\n\n1. Keep scripts idempotent and non-destructive beyond initial provisioning\n\n1. Avoid embedding passwords/keys; rely on installer prompts & environment variables\n\n1. Run validation before submitting: `opt/validate-components.sh`\n## Roadmap (High-Level) (2)\n- Cluster expansion scripts (join additional nodes for Ceph + K8s)\n\n- Ceph CSI & ZFS LocalPV Helm charts under `docker\addons\`\n\n- Metrics stack (Prometheus/Grafana) profile\n\n- Upgrade orchestration (Ansible playbooks)\n## Rate Limiting (2)\n- Web Panel (Flask):\n\n- Set a global default via `RATELIMIT_DEFAULT` in the Flask config (e.g., `"100 per minute"`).\n\n- Use `@limiter.limit("<N> per <period>")` per route for granular control (see `opt/web/panel/routes/auth.py`).\n\n- Login/Register routes include per-IP and per-user limits with lightweight backoff.\n\n- RPC Server (gRPC):\n\n- Configure `/etc/debvisor/rpc/config.json` -> `rate_limit` block:\n\n- `window_seconds`: sliding window duration (seconds)\n\n- `max_calls`: max calls per principal per method within the window\n\n- `method_limits`: per-method overrides, e.g.:\n        {\n          "rate_limit": {\n            "window_seconds": 60,\n            "max_calls": 120,\n            "method_limits": {\n              "/debvisor.StorageService/CreateSnapshot": { "window_seconds": 60, "max_calls": 30 },\n              "/debvisor.StorageService/DeleteSnapshot": { "window_seconds": 60, "max_calls": 20 }\n            }\n          }\n        }\n\n- `method_limits_prefix`: prefix-based defaults for groups of methods, e.g.:\n        {\n          "rate_limit": {\n            "method_limits_prefix": {\n              "/debvisor.StorageService/": { "window_seconds": 60, "max_calls": 30 },\n              "/debvisor.MigrationService/": { "window_seconds": 60, "max_calls": 40 }\n            }\n          }\n        }\n\n- `method_limits_patterns`: regex-based matching for automatic stricter limits on mutating RPCs, e.g.:\n        {\n          "rate_limit": {\n            "method_limits_patterns": [\n              { "pattern": "/debvisor\\.[A-Za-z]+Service/(Create|Delete|Update|Migrate|Plan)$", "window_seconds": 60, "max_calls": 20 }\n            ]\n          }\n        }\n\n- Implemented by `RateLimitingInterceptor` in `opt/services/rpc/server.py`.\n## License (2)\nApache License Version 2.0, January 2004 `license.md`\n## Monitoring (2)\n- Health dashboards: see `docs/monitoring-health-detail.md` for Prometheus/Grafana setup using `/health/detail`.\n\n- Metrics: expose Prometheus metrics at `/metrics`.\n\n- *Full Documentation**: [docs/SUPPLY_CHAIN_SECURITY.md](docs/SUPPLY_CHAIN_SECURITY.md)\n\n- --\n## Network Configuration (3)\n- **Management:** See [etc/README.md](etc/README.md) for customization and monitoring\n### Blocklist Management (3)\n- **Validation:** `etc/debvisor/validate-blocklists.sh` (CIDR syntax, overlap detection)\n\n- **Integrity:** `etc/debvisor/verify-blocklist-integrity.sh` (checksums, format verification)\n\n- **Examples:** `blocklist-example.txt`, `blocklist-whitelist-example.txt`\n\n- **Testing:** GitHub Actions validates all blocklists on commit\n\n- **Details:** See [etc/debvisor/](etc/debvisor/) for configuration formats and usage\n### Production Deployment Checklist (3)\n- [ ] Enable maintenance timers: `systemctl enable ceph-health.timer zfs-scrub-weekly.timer`\n\n- [ ] Configure ZFS timeout for your pool size in `/etc/default/debvisor-zfs-scrub`\n\n- [ ] Customize timer schedules if not aligned with your maintenance window\n\n- [ ] Set up log aggregation or alerts for service failures\n\n- [ ] For multi-node clusters, stagger scrub schedules to prevent simultaneous I/O\n\n- [ ] Test manual execution: `systemctl start zfs-scrub-weekly.service`\n\n- [ ] Monitor service logs during first automated run\n### Modes (3)\n- `/etc/debvisor-mode` controls behavior:\n\n- `lab`(default): ensures`root`,`node`,`monitor` users exist (non-root locked), convenience defaults.\n\n- `prod`: only ensures`root` user; create additional accounts via your own workflow.\n### Addons (3)\n- Global config: `/etc/debvisor-addons.conf` with flags:\n\n- `ADDON_RPC_SERVICE`,`ADDON_WEB_PANEL`,`ADDON_VNC_CONSOLE`,`ADDON_MONITORING_STACK`(`yes`/`no`).\n\n- Profile defaults: `/etc/debvisor-addons.d/.conf` provide sensible per-profile defaults if no global file exists.\n\n- On first boot, an Ansible playbook (`bootstrap-addons.yml`) runs locally (when present) to apply addon roles:\n\n- `rpc-service`,`web-panel`,`vnc-console`,`monitoring-stack` (shipped as safe stubs you can extend).\n### Dry Run (3)\n- You can test the first boot logic non-destructively with:\n\n- `debvisor-firstboot.sh --dry-run`\n\n- In dry-run mode, provisioning steps only log intended actions; no disks/users/services are modified.\n## Improvements & Operational Excellence (3)\nDebVisor includes comprehensive improvements across all system components to ensure production-readiness:\n### Phase 1: Documentation & Configuration (? Complete) (3)\n- Enhanced systemd unit files with timeout protection, retry logic, and security sandboxing\n\n- Comprehensive README files for `etc/`,`opt/`, and`usr/` directories\n\n- Production deployment checklists and troubleshooting guides\n\n- ZFS pool sizing formulas and multi-pool configuration support\n\n- See [SESSION_COMPLETION_REPORT.md](SESSION_COMPLETION_REPORT.md) for details\n### Phase 2: Operational Scripts & CI/CD (? Complete) (3)\n- **Shared bash library** (`usr/local/bin/debvisor-lib.sh`) with 50+ reusable functions\n\n- Consistent logging, error handling, retry logic\n\n- Infrastructure validation (Ceph, Kubernetes, ZFS)\n\n- Safe operation patterns (dry-run, confirm, execute)\n\n- **Enhanced scripts** with `--dry-run`, `--check`, `--verbose` modes\n\n- `debvisor-join.sh`: Join nodes to cluster with comprehensive validation\n\n- `debvisor-upgrade.sh`: Orchestrated cluster upgrades with checkpoints\n\n- Full audit logging and error recovery\n\n- **CI/CD validation workflow** (`.github/workflows/validate-syntax.yml`)`)\n\n- systemd unit validation with `systemd-analyze`\n\n- Shell script linting with `shellcheck`\n\n- Ansible playbook syntax checking\n\n- Cross-component consistency validation\n\n- **Component validator** (`opt/validate-components.sh`)\n\n- Validates Ansible inventory, package lists, Docker addons\n\n- Checks file permissions and executable status\n\n- Optional auto-fix for common issues\nSee [PHASE_2_SUMMARY.md](PHASE_2_SUMMARY.md) for implementation details and usage examples.\n### Phase 3: RPC Service & Web Panel (Planned) (3)\n- gRPC service implementation with authentication, authorization, TLS\n\n- Web management panel with security hardening\n\n- Integration tests and advanced monitoring\n\n- --\n## Contributing (3)\n1. Propose doc changes in `docs/`\n\n1. Use the shared library (`debvisor-lib.sh`) in new scripts for consistency\n\n1. All scripts should support `--dry-run`,`--check`,`--verbose`,`--log-file` flags\n\n1. Include comprehensive error handling and audit logging\n\n1. Keep scripts idempotent and non-destructive beyond initial provisioning\n\n1. Avoid embedding passwords/keys; rely on installer prompts & environment variables\n\n1. Run validation before submitting: `opt/validate-components.sh`\n## Roadmap (High-Level) (3)\n- Cluster expansion scripts (join additional nodes for Ceph + K8s)\n\n- Ceph CSI & ZFS LocalPV Helm charts under `docker\addons\`\n\n- Metrics stack (Prometheus/Grafana) profile\n\n- Upgrade orchestration (Ansible playbooks)\n## Rate Limiting (3)\n- Web Panel (Flask):\n\n- Set a global default via `RATELIMIT_DEFAULT` in the Flask config (e.g., `"100 per minute"`).\n\n- Use `@limiter.limit("<N> per <period>")` per route for granular control (see `opt/web/panel/routes/auth.py`).\n\n- Login/Register routes include per-IP and per-user limits with lightweight backoff.\n\n- RPC Server (gRPC):\n\n- Configure `/etc/debvisor/rpc/config.json` -> `rate_limit` block:\n\n- `window_seconds`: sliding window duration (seconds)\n\n- `max_calls`: max calls per principal per method within the window\n\n- `method_limits`: per-method overrides, e.g.:\n        {\n          "rate_limit": {\n            "window_seconds": 60,\n            "max_calls": 120,\n            "method_limits": {\n              "/debvisor.StorageService/CreateSnapshot": { "window_seconds": 60, "max_calls": 30 },\n              "/debvisor.StorageService/DeleteSnapshot": { "window_seconds": 60, "max_calls": 20 }\n            }\n          }\n        }\n\n- `method_limits_prefix`: prefix-based defaults for groups of methods, e.g.:\n        {\n          "rate_limit": {\n            "method_limits_prefix": {\n              "/debvisor.StorageService/": { "window_seconds": 60, "max_calls": 30 },\n              "/debvisor.MigrationService/": { "window_seconds": 60, "max_calls": 40 }\n            }\n          }\n        }\n\n- `method_limits_patterns`: regex-based matching for automatic stricter limits on mutating RPCs, e.g.:\n        {\n          "rate_limit": {\n            "method_limits_patterns": [\n              { "pattern": "/debvisor\\.[A-Za-z]+Service/(Create|Delete|Update|Migrate|Plan)$", "window_seconds": 60, "max_calls": 20 }\n            ]\n          }\n        }\n\n- Implemented by `RateLimitingInterceptor` in `opt/services/rpc/server.py`.\n## License (3)\nApache License Version 2.0, January 2004 `license.md`\n## Monitoring (3)\n- Health dashboards: see `docs/monitoring-health-detail.md` for Prometheus/Grafana setup using `/health/detail`.\n\n- Metrics: expose Prometheus metrics at `/metrics`.\n\n- *Full Documentation**: [docs/SUPPLY_CHAIN_SECURITY.md](docs/SUPPLY_CHAIN_SECURITY.md)\n\n- --\n## Network Configuration (4)\n- **Management:** See [etc/README.md](etc/README.md) for customization and monitoring\n### Blocklist Management (4)\n- **Validation:** `etc/debvisor/validate-blocklists.sh` (CIDR syntax, overlap detection)\n\n- **Integrity:** `etc/debvisor/verify-blocklist-integrity.sh` (checksums, format verification)\n\n- **Examples:** `blocklist-example.txt`, `blocklist-whitelist-example.txt`\n\n- **Testing:** GitHub Actions validates all blocklists on commit\n\n- **Details:** See [etc/debvisor/](etc/debvisor/) for configuration formats and usage\n### Production Deployment Checklist (4)\n- [ ] Enable maintenance timers: `systemctl enable ceph-health.timer zfs-scrub-weekly.timer`\n\n- [ ] Configure ZFS timeout for your pool size in `/etc/default/debvisor-zfs-scrub`\n\n- [ ] Customize timer schedules if not aligned with your maintenance window\n\n- [ ] Set up log aggregation or alerts for service failures\n\n- [ ] For multi-node clusters, stagger scrub schedules to prevent simultaneous I/O\n\n- [ ] Test manual execution: `systemctl start zfs-scrub-weekly.service`\n\n- [ ] Monitor service logs during first automated run\n### Modes (4)\n- `/etc/debvisor-mode` controls behavior:\n\n- `lab`(default): ensures`root`,`node`,`monitor` users exist (non-root locked), convenience defaults.\n\n- `prod`: only ensures`root` user; create additional accounts via your own workflow.\n### Addons (4)\n- Global config: `/etc/debvisor-addons.conf` with flags:\n\n- `ADDON_RPC_SERVICE`,`ADDON_WEB_PANEL`,`ADDON_VNC_CONSOLE`,`ADDON_MONITORING_STACK`(`yes`/`no`).\n\n- Profile defaults: `/etc/debvisor-addons.d/.conf` provide sensible per-profile defaults if no global file exists.\n\n- On first boot, an Ansible playbook (`bootstrap-addons.yml`) runs locally (when present) to apply addon roles:\n\n- `rpc-service`,`web-panel`,`vnc-console`,`monitoring-stack` (shipped as safe stubs you can extend).\n### Dry Run (4)\n- You can test the first boot logic non-destructively with:\n\n- `debvisor-firstboot.sh --dry-run`\n\n- In dry-run mode, provisioning steps only log intended actions; no disks/users/services are modified.\n## Improvements & Operational Excellence (4)\nDebVisor includes comprehensive improvements across all system components to ensure production-readiness:\n### Phase 1: Documentation & Configuration (? Complete) (4)\n- Enhanced systemd unit files with timeout protection, retry logic, and security sandboxing\n\n- Comprehensive README files for `etc/`,`opt/`, and`usr/` directories\n\n- Production deployment checklists and troubleshooting guides\n\n- ZFS pool sizing formulas and multi-pool configuration support\n\n- See [SESSION_COMPLETION_REPORT.md](SESSION_COMPLETION_REPORT.md) for details\n### Phase 2: Operational Scripts & CI/CD (? Complete) (4)\n- **Shared bash library** (`usr/local/bin/debvisor-lib.sh`) with 50+ reusable functions\n\n- Consistent logging, error handling, retry logic\n\n- Infrastructure validation (Ceph, Kubernetes, ZFS)\n\n- Safe operation patterns (dry-run, confirm, execute)\n\n- **Enhanced scripts** with `--dry-run`, `--check`, `--verbose` modes\n\n- `debvisor-join.sh`: Join nodes to cluster with comprehensive validation\n\n- `debvisor-upgrade.sh`: Orchestrated cluster upgrades with checkpoints\n\n- Full audit logging and error recovery\n\n- **CI/CD validation workflow** (`.github/workflows/validate-syntax.yml`)`)\n\n- systemd unit validation with `systemd-analyze`\n\n- Shell script linting with `shellcheck`\n\n- Ansible playbook syntax checking\n\n- Cross-component consistency validation\n\n- **Component validator** (`opt/validate-components.sh`)\n\n- Validates Ansible inventory, package lists, Docker addons\n\n- Checks file permissions and executable status\n\n- Optional auto-fix for common issues\nSee [PHASE_2_SUMMARY.md](PHASE_2_SUMMARY.md) for implementation details and usage examples.\n### Phase 3: RPC Service & Web Panel (Planned) (4)\n- gRPC service implementation with authentication, authorization, TLS\n\n- Web management panel with security hardening\n\n- Integration tests and advanced monitoring\n\n- --\n## Contributing (4)\n1. Propose doc changes in `docs/`\n\n1. Use the shared library (`debvisor-lib.sh`) in new scripts for consistency\n\n1. All scripts should support `--dry-run`,`--check`,`--verbose`,`--log-file` flags\n\n1. Include comprehensive error handling and audit logging\n\n1. Keep scripts idempotent and non-destructive beyond initial provisioning\n\n1. Avoid embedding passwords/keys; rely on installer prompts & environment variables\n\n1. Run validation before submitting: `opt/validate-components.sh`\n## Roadmap (High-Level) (4)\n- Cluster expansion scripts (join additional nodes for Ceph + K8s)\n\n- Ceph CSI & ZFS LocalPV Helm charts under `docker\addons\`\n\n- Metrics stack (Prometheus/Grafana) profile\n\n- Upgrade orchestration (Ansible playbooks)\n## Rate Limiting (4)\n- Web Panel (Flask):\n\n- Set a global default via `RATELIMIT_DEFAULT` in the Flask config (e.g., `"100 per minute"`).\n\n- Use `@limiter.limit("<N> per <period>")` per route for granular control (see `opt/web/panel/routes/auth.py`).\n\n- Login/Register routes include per-IP and per-user limits with lightweight backoff.\n\n- RPC Server (gRPC):\n\n- Configure `/etc/debvisor/rpc/config.json` -> `rate_limit` block:\n\n- `window_seconds`: sliding window duration (seconds)\n\n- `max_calls`: max calls per principal per method within the window\n\n- `method_limits`: per-method overrides, e.g.:\n        {\n          "rate_limit": {\n            "window_seconds": 60,\n            "max_calls": 120,\n            "method_limits": {\n              "/debvisor.StorageService/CreateSnapshot": { "window_seconds": 60, "max_calls": 30 },\n              "/debvisor.StorageService/DeleteSnapshot": { "window_seconds": 60, "max_calls": 20 }\n            }\n          }\n        }\n\n- `method_limits_prefix`: prefix-based defaults for groups of methods, e.g.:\n        {\n          "rate_limit": {\n            "method_limits_prefix": {\n              "/debvisor.StorageService/": { "window_seconds": 60, "max_calls": 30 },\n              "/debvisor.MigrationService/": { "window_seconds": 60, "max_calls": 40 }\n            }\n          }\n        }\n\n- `method_limits_patterns`: regex-based matching for automatic stricter limits on mutating RPCs, e.g.:\n        {\n          "rate_limit": {\n            "method_limits_patterns": [\n              { "pattern": "/debvisor\\.[A-Za-z]+Service/(Create|Delete|Update|Migrate|Plan)$", "window_seconds": 60, "max_calls": 20 }\n            ]\n          }\n        }\n\n- Implemented by `RateLimitingInterceptor` in `opt/services/rpc/server.py`.\n## License (4)\nApache License Version 2.0, January 2004 `license.md`\n## Monitoring (4)\n- Health dashboards: see `docs/monitoring-health-detail.md` for Prometheus/Grafana setup using `/health/detail`.\n\n- Metrics: expose Prometheus metrics at `/metrics`.\n\n- *Full Documentation**: [docs/SUPPLY_CHAIN_SECURITY.md](docs/SUPPLY_CHAIN_SECURITY.md)\n\n- --\n## Network Configuration (5)\n- **Management:** See [etc/README.md](etc/README.md) for customization and monitoring\n### Blocklist Management (5)\n- **Validation:** `etc/debvisor/validate-blocklists.sh` (CIDR syntax, overlap detection)\n\n- **Integrity:** `etc/debvisor/verify-blocklist-integrity.sh` (checksums, format verification)\n\n- **Examples:** `blocklist-example.txt`, `blocklist-whitelist-example.txt`\n\n- **Testing:** GitHub Actions validates all blocklists on commit\n\n- **Details:** See [etc/debvisor/](etc/debvisor/) for configuration formats and usage\n### Production Deployment Checklist (5)\n- [ ] Enable maintenance timers: `systemctl enable ceph-health.timer zfs-scrub-weekly.timer`\n\n- [ ] Configure ZFS timeout for your pool size in `/etc/default/debvisor-zfs-scrub`\n\n- [ ] Customize timer schedules if not aligned with your maintenance window\n\n- [ ] Set up log aggregation or alerts for service failures\n\n- [ ] For multi-node clusters, stagger scrub schedules to prevent simultaneous I/O\n\n- [ ] Test manual execution: `systemctl start zfs-scrub-weekly.service`\n\n- [ ] Monitor service logs during first automated run\n### Modes (5)\n- `/etc/debvisor-mode` controls behavior:\n\n- `lab`(default): ensures`root`,`node`,`monitor` users exist (non-root locked), convenience defaults.\n\n- `prod`: only ensures`root` user; create additional accounts via your own workflow.\n### Addons (5)\n- Global config: `/etc/debvisor-addons.conf` with flags:\n\n- `ADDON_RPC_SERVICE`,`ADDON_WEB_PANEL`,`ADDON_VNC_CONSOLE`,`ADDON_MONITORING_STACK`(`yes`/`no`).\n\n- Profile defaults: `/etc/debvisor-addons.d/.conf` provide sensible per-profile defaults if no global file exists.\n\n- On first boot, an Ansible playbook (`bootstrap-addons.yml`) runs locally (when present) to apply addon roles:\n\n- `rpc-service`,`web-panel`,`vnc-console`,`monitoring-stack` (shipped as safe stubs you can extend).\n### Dry Run (5)\n- You can test the first boot logic non-destructively with:\n\n- `debvisor-firstboot.sh --dry-run`\n\n- In dry-run mode, provisioning steps only log intended actions; no disks/users/services are modified.\n## Improvements & Operational Excellence (5)\nDebVisor includes comprehensive improvements across all system components to ensure production-readiness:\n### Phase 1: Documentation & Configuration (? Complete) (5)\n- Enhanced systemd unit files with timeout protection, retry logic, and security sandboxing\n\n- Comprehensive README files for `etc/`,`opt/`, and`usr/` directories\n\n- Production deployment checklists and troubleshooting guides\n\n- ZFS pool sizing formulas and multi-pool configuration support\n\n- See [SESSION_COMPLETION_REPORT.md](SESSION_COMPLETION_REPORT.md) for details\n### Phase 2: Operational Scripts & CI/CD (? Complete) (5)\n- **Shared bash library** (`usr/local/bin/debvisor-lib.sh`) with 50+ reusable functions\n\n- Consistent logging, error handling, retry logic\n\n- Infrastructure validation (Ceph, Kubernetes, ZFS)\n\n- Safe operation patterns (dry-run, confirm, execute)\n\n- **Enhanced scripts** with `--dry-run`, `--check`, `--verbose` modes\n\n- `debvisor-join.sh`: Join nodes to cluster with comprehensive validation\n\n- `debvisor-upgrade.sh`: Orchestrated cluster upgrades with checkpoints\n\n- Full audit logging and error recovery\n\n- **CI/CD validation workflow** (`.github/workflows/validate-syntax.yml`)`)\n\n- systemd unit validation with `systemd-analyze`\n\n- Shell script linting with `shellcheck`\n\n- Ansible playbook syntax checking\n\n- Cross-component consistency validation\n\n- **Component validator** (`opt/validate-components.sh`)\n\n- Validates Ansible inventory, package lists, Docker addons\n\n- Checks file permissions and executable status\n\n- Optional auto-fix for common issues\nSee [PHASE_2_SUMMARY.md](PHASE_2_SUMMARY.md) for implementation details and usage examples.\n### Phase 3: RPC Service & Web Panel (Planned) (5)\n- gRPC service implementation with authentication, authorization, TLS\n\n- Web management panel with security hardening\n\n- Integration tests and advanced monitoring\n\n- --\n## Contributing (5)\n1. Propose doc changes in `docs/`\n\n1. Use the shared library (`debvisor-lib.sh`) in new scripts for consistency\n\n1. All scripts should support `--dry-run`,`--check`,`--verbose`,`--log-file` flags\n\n1. Include comprehensive error handling and audit logging\n\n1. Keep scripts idempotent and non-destructive beyond initial provisioning\n\n1. Avoid embedding passwords/keys; rely on installer prompts & environment variables\n\n1. Run validation before submitting: `opt/validate-components.sh`\n## Roadmap (High-Level) (5)\n- Cluster expansion scripts (join additional nodes for Ceph + K8s)\n\n- Ceph CSI & ZFS LocalPV Helm charts under `docker\addons\`\n\n- Metrics stack (Prometheus/Grafana) profile\n\n- Upgrade orchestration (Ansible playbooks)\n## Rate Limiting (5)\n- Web Panel (Flask):\n\n- Set a global default via `RATELIMIT_DEFAULT` in the Flask config (e.g., `"100 per minute"`).\n\n- Use `@limiter.limit("<N> per <period>")` per route for granular control (see `opt/web/panel/routes/auth.py`).\n\n- Login/Register routes include per-IP and per-user limits with lightweight backoff.\n\n- RPC Server (gRPC):\n\n- Configure `/etc/debvisor/rpc/config.json` -> `rate_limit` block:\n\n- `window_seconds`: sliding window duration (seconds)\n\n- `max_calls`: max calls per principal per method within the window\n\n- `method_limits`: per-method overrides, e.g.:\n        {\n          "rate_limit": {\n            "window_seconds": 60,\n            "max_calls": 120,\n            "method_limits": {\n              "/debvisor.StorageService/CreateSnapshot": { "window_seconds": 60, "max_calls": 30 },\n              "/debvisor.StorageService/DeleteSnapshot": { "window_seconds": 60, "max_calls": 20 }\n            }\n          }\n        }\n\n- `method_limits_prefix`: prefix-based defaults for groups of methods, e.g.:\n        {\n          "rate_limit": {\n            "method_limits_prefix": {\n              "/debvisor.StorageService/": { "window_seconds": 60, "max_calls": 30 },\n              "/debvisor.MigrationService/": { "window_seconds": 60, "max_calls": 40 }\n            }\n          }\n        }\n\n- `method_limits_patterns`: regex-based matching for automatic stricter limits on mutating RPCs, e.g.:\n        {\n          "rate_limit": {\n            "method_limits_patterns": [\n              { "pattern": "/debvisor\\.[A-Za-z]+Service/(Create|Delete|Update|Migrate|Plan)$", "window_seconds": 60, "max_calls": 20 }\n            ]\n          }\n        }\n\n- Implemented by `RateLimitingInterceptor` in `opt/services/rpc/server.py`.\n## License (5)\nApache License Version 2.0, January 2004 `license.md`\n## Monitoring (5)\n- Health dashboards: see `docs/monitoring-health-detail.md` for Prometheus/Grafana setup using `/health/detail`.\n\n- Metrics: expose Prometheus metrics at `/metrics`.\n\n- *Full Documentation**: [docs/SUPPLY_CHAIN_SECURITY.md](docs/SUPPLY_CHAIN_SECURITY.md)\n\n- --\n## Network Configuration (6)\n- **Management:** See [etc/README.md](etc/README.md) for customization and monitoring\n### Blocklist Management (6)\n- **Validation:** `etc/debvisor/validate-blocklists.sh` (CIDR syntax, overlap detection)\n\n- **Integrity:** `etc/debvisor/verify-blocklist-integrity.sh` (checksums, format verification)\n\n- **Examples:** `blocklist-example.txt`, `blocklist-whitelist-example.txt`\n\n- **Testing:** GitHub Actions validates all blocklists on commit\n\n- **Details:** See [etc/debvisor/](etc/debvisor/) for configuration formats and usage\n### Production Deployment Checklist (6)\n- [ ] Enable maintenance timers: `systemctl enable ceph-health.timer zfs-scrub-weekly.timer`\n\n- [ ] Configure ZFS timeout for your pool size in `/etc/default/debvisor-zfs-scrub`\n\n- [ ] Customize timer schedules if not aligned with your maintenance window\n\n- [ ] Set up log aggregation or alerts for service failures\n\n- [ ] For multi-node clusters, stagger scrub schedules to prevent simultaneous I/O\n\n- [ ] Test manual execution: `systemctl start zfs-scrub-weekly.service`\n\n- [ ] Monitor service logs during first automated run\n### Modes (6)\n- `/etc/debvisor-mode` controls behavior:\n\n- `lab`(default): ensures`root`,`node`,`monitor` users exist (non-root locked), convenience defaults.\n\n- `prod`: only ensures`root` user; create additional accounts via your own workflow.\n### Addons (6)\n- Global config: `/etc/debvisor-addons.conf` with flags:\n\n- `ADDON_RPC_SERVICE`,`ADDON_WEB_PANEL`,`ADDON_VNC_CONSOLE`,`ADDON_MONITORING_STACK`(`yes`/`no`).\n\n- Profile defaults: `/etc/debvisor-addons.d/.conf` provide sensible per-profile defaults if no global file exists.\n\n- On first boot, an Ansible playbook (`bootstrap-addons.yml`) runs locally (when present) to apply addon roles:\n\n- `rpc-service`,`web-panel`,`vnc-console`,`monitoring-stack` (shipped as safe stubs you can extend).\n### Dry Run (6)\n- You can test the first boot logic non-destructively with:\n\n- `debvisor-firstboot.sh --dry-run`\n\n- In dry-run mode, provisioning steps only log intended actions; no disks/users/services are modified.\n## Improvements & Operational Excellence (6)\nDebVisor includes comprehensive improvements across all system components to ensure production-readiness:\n### Phase 1: Documentation & Configuration (? Complete) (6)\n- Enhanced systemd unit files with timeout protection, retry logic, and security sandboxing\n\n- Comprehensive README files for `etc/`,`opt/`, and`usr/` directories\n\n- Production deployment checklists and troubleshooting guides\n\n- ZFS pool sizing formulas and multi-pool configuration support\n\n- See [SESSION_COMPLETION_REPORT.md](SESSION_COMPLETION_REPORT.md) for details\n### Phase 2: Operational Scripts & CI/CD (? Complete) (6)\n- **Shared bash library** (`usr/local/bin/debvisor-lib.sh`) with 50+ reusable functions\n\n- Consistent logging, error handling, retry logic\n\n- Infrastructure validation (Ceph, Kubernetes, ZFS)\n\n- Safe operation patterns (dry-run, confirm, execute)\n\n- **Enhanced scripts** with `--dry-run`, `--check`, `--verbose` modes\n\n- `debvisor-join.sh`: Join nodes to cluster with comprehensive validation\n\n- `debvisor-upgrade.sh`: Orchestrated cluster upgrades with checkpoints\n\n- Full audit logging and error recovery\n\n- **CI/CD validation workflow** (`.github/workflows/validate-syntax.yml`)`)\n\n- systemd unit validation with `systemd-analyze`\n\n- Shell script linting with `shellcheck`\n\n- Ansible playbook syntax checking\n\n- Cross-component consistency validation\n\n- **Component validator** (`opt/validate-components.sh`)\n\n- Validates Ansible inventory, package lists, Docker addons\n\n- Checks file permissions and executable status\n\n- Optional auto-fix for common issues\nSee [PHASE_2_SUMMARY.md](PHASE_2_SUMMARY.md) for implementation details and usage examples.\n### Phase 3: RPC Service & Web Panel (Planned) (6)\n- gRPC service implementation with authentication, authorization, TLS\n\n- Web management panel with security hardening\n\n- Integration tests and advanced monitoring\n\n- --\n## Contributing (6)\n1. Propose doc changes in `docs/`\n\n1. Use the shared library (`debvisor-lib.sh`) in new scripts for consistency\n\n1. All scripts should support `--dry-run`,`--check`,`--verbose`,`--log-file` flags\n\n1. Include comprehensive error handling and audit logging\n\n1. Keep scripts idempotent and non-destructive beyond initial provisioning\n\n1. Avoid embedding passwords/keys; rely on installer prompts & environment variables\n\n1. Run validation before submitting: `opt/validate-components.sh`\n## Roadmap (High-Level) (6)\n- Cluster expansion scripts (join additional nodes for Ceph + K8s)\n\n- Ceph CSI & ZFS LocalPV Helm charts under `docker\addons\`\n\n- Metrics stack (Prometheus/Grafana) profile\n\n- Upgrade orchestration (Ansible playbooks)\n## Rate Limiting (6)\n- Web Panel (Flask):\n\n- Set a global default via `RATELIMIT_DEFAULT` in the Flask config (e.g., `"100 per minute"`).\n\n- Use `@limiter.limit("<N> per <period>")` per route for granular control (see `opt/web/panel/routes/auth.py`).\n\n- Login/Register routes include per-IP and per-user limits with lightweight backoff.\n\n- RPC Server (gRPC):\n\n- Configure `/etc/debvisor/rpc/config.json` -> `rate_limit` block:\n\n- `window_seconds`: sliding window duration (seconds)\n\n- `max_calls`: max calls per principal per method within the window\n\n- `method_limits`: per-method overrides, e.g.:\n        {\n          "rate_limit": {\n            "window_seconds": 60,\n            "max_calls": 120,\n            "method_limits": {\n              "/debvisor.StorageService/CreateSnapshot": { "window_seconds": 60, "max_calls": 30 },\n              "/debvisor.StorageService/DeleteSnapshot": { "window_seconds": 60, "max_calls": 20 }\n            }\n          }\n        }\n\n- `method_limits_prefix`: prefix-based defaults for groups of methods, e.g.:\n        {\n          "rate_limit": {\n            "method_limits_prefix": {\n              "/debvisor.StorageService/": { "window_seconds": 60, "max_calls": 30 },\n              "/debvisor.MigrationService/": { "window_seconds": 60, "max_calls": 40 }\n            }\n          }\n        }\n\n- `method_limits_patterns`: regex-based matching for automatic stricter limits on mutating RPCs, e.g.:\n        {\n          "rate_limit": {\n            "method_limits_patterns": [\n              { "pattern": "/debvisor\\.[A-Za-z]+Service/(Create|Delete|Update|Migrate|Plan)$", "window_seconds": 60, "max_calls": 20 }\n            ]\n          }\n        }\n\n- Implemented by `RateLimitingInterceptor` in `opt/services/rpc/server.py`.\n## License (6)\nApache License Version 2.0, January 2004 `license.md`\n## Monitoring (6)\n- Health dashboards: see `docs/monitoring-health-detail.md` for Prometheus/Grafana setup using `/health/detail`.\n\n- Metrics: expose Prometheus metrics at `/metrics`.\n\n- *Full Documentation**: [docs/SUPPLY_CHAIN_SECURITY.md](docs/SUPPLY_CHAIN_SECURITY.md)\n\n- --\n## Network Configuration (7)\n- **Management:** See [etc/README.md](etc/README.md) for customization and monitoring\n### Blocklist Management (7)\n- **Validation:** `etc/debvisor/validate-blocklists.sh` (CIDR syntax, overlap detection)\n\n- **Integrity:** `etc/debvisor/verify-blocklist-integrity.sh` (checksums, format verification)\n\n- **Examples:** `blocklist-example.txt`, `blocklist-whitelist-example.txt`\n\n- **Testing:** GitHub Actions validates all blocklists on commit\n\n- **Details:** See [etc/debvisor/](etc/debvisor/) for configuration formats and usage\n### Production Deployment Checklist (7)\n- [ ] Enable maintenance timers: `systemctl enable ceph-health.timer zfs-scrub-weekly.timer`\n\n- [ ] Configure ZFS timeout for your pool size in `/etc/default/debvisor-zfs-scrub`\n\n- [ ] Customize timer schedules if not aligned with your maintenance window\n\n- [ ] Set up log aggregation or alerts for service failures\n\n- [ ] For multi-node clusters, stagger scrub schedules to prevent simultaneous I/O\n\n- [ ] Test manual execution: `systemctl start zfs-scrub-weekly.service`\n\n- [ ] Monitor service logs during first automated run\n### Modes (7)\n- `/etc/debvisor-mode` controls behavior:\n\n- `lab`(default): ensures`root`,`node`,`monitor` users exist (non-root locked), convenience defaults.\n\n- `prod`: only ensures`root` user; create additional accounts via your own workflow.\n### Addons (7)\n- Global config: `/etc/debvisor-addons.conf` with flags:\n\n- `ADDON_RPC_SERVICE`,`ADDON_WEB_PANEL`,`ADDON_VNC_CONSOLE`,`ADDON_MONITORING_STACK`(`yes`/`no`).\n\n- Profile defaults: `/etc/debvisor-addons.d/.conf` provide sensible per-profile defaults if no global file exists.\n\n- On first boot, an Ansible playbook (`bootstrap-addons.yml`) runs locally (when present) to apply addon roles:\n\n- `rpc-service`,`web-panel`,`vnc-console`,`monitoring-stack` (shipped as safe stubs you can extend).\n### Dry Run (7)\n- You can test the first boot logic non-destructively with:\n\n- `debvisor-firstboot.sh --dry-run`\n\n- In dry-run mode, provisioning steps only log intended actions; no disks/users/services are modified.\n## Improvements & Operational Excellence (7)\nDebVisor includes comprehensive improvements across all system components to ensure production-readiness:\n### Phase 1: Documentation & Configuration (? Complete) (7)\n- Enhanced systemd unit files with timeout protection, retry logic, and security sandboxing\n\n- Comprehensive README files for `etc/`,`opt/`, and`usr/` directories\n\n- Production deployment checklists and troubleshooting guides\n\n- ZFS pool sizing formulas and multi-pool configuration support\n\n- See [SESSION_COMPLETION_REPORT.md](SESSION_COMPLETION_REPORT.md) for details\n### Phase 2: Operational Scripts & CI/CD (? Complete) (7)\n- **Shared bash library** (`usr/local/bin/debvisor-lib.sh`) with 50+ reusable functions\n\n- Consistent logging, error handling, retry logic\n\n- Infrastructure validation (Ceph, Kubernetes, ZFS)\n\n- Safe operation patterns (dry-run, confirm, execute)\n\n- **Enhanced scripts** with `--dry-run`, `--check`, `--verbose` modes\n\n- `debvisor-join.sh`: Join nodes to cluster with comprehensive validation\n\n- `debvisor-upgrade.sh`: Orchestrated cluster upgrades with checkpoints\n\n- Full audit logging and error recovery\n\n- **CI/CD validation workflow** (`.github/workflows/validate-syntax.yml`)`)\n\n- systemd unit validation with `systemd-analyze`\n\n- Shell script linting with `shellcheck`\n\n- Ansible playbook syntax checking\n\n- Cross-component consistency validation\n\n- **Component validator** (`opt/validate-components.sh`)\n\n- Validates Ansible inventory, package lists, Docker addons\n\n- Checks file permissions and executable status\n\n- Optional auto-fix for common issues\nSee [PHASE_2_SUMMARY.md](PHASE_2_SUMMARY.md) for implementation details and usage examples.\n### Phase 3: RPC Service & Web Panel (Planned) (7)\n- gRPC service implementation with authentication, authorization, TLS\n\n- Web management panel with security hardening\n\n- Integration tests and advanced monitoring\n\n- --\n## Contributing (7)\n1. Propose doc changes in `docs/`\n\n1. Use the shared library (`debvisor-lib.sh`) in new scripts for consistency\n\n1. All scripts should support `--dry-run`,`--check`,`--verbose`,`--log-file` flags\n\n1. Include comprehensive error handling and audit logging\n\n1. Keep scripts idempotent and non-destructive beyond initial provisioning\n\n1. Avoid embedding passwords/keys; rely on installer prompts & environment variables\n\n1. Run validation before submitting: `opt/validate-components.sh`\n## Roadmap (High-Level) (7)\n- Cluster expansion scripts (join additional nodes for Ceph + K8s)\n\n- Ceph CSI & ZFS LocalPV Helm charts under `docker\addons\`\n\n- Metrics stack (Prometheus/Grafana) profile\n\n- Upgrade orchestration (Ansible playbooks)\n## Rate Limiting (7)\n- Web Panel (Flask):\n\n- Set a global default via `RATELIMIT_DEFAULT` in the Flask config (e.g., `"100 per minute"`).\n\n- Use `@limiter.limit("<N> per <period>")` per route for granular control (see `opt/web/panel/routes/auth.py`).\n\n- Login/Register routes include per-IP and per-user limits with lightweight backoff.\n\n- RPC Server (gRPC):\n\n- Configure `/etc/debvisor/rpc/config.json` -> `rate_limit` block:\n\n- `window_seconds`: sliding window duration (seconds)\n\n- `max_calls`: max calls per principal per method within the window\n\n- `method_limits`: per-method overrides, e.g.:\n        {\n          "rate_limit": {\n            "window_seconds": 60,\n            "max_calls": 120,\n            "method_limits": {\n              "/debvisor.StorageService/CreateSnapshot": { "window_seconds": 60, "max_calls": 30 },\n              "/debvisor.StorageService/DeleteSnapshot": { "window_seconds": 60, "max_calls": 20 }\n            }\n          }\n        }\n\n- `method_limits_prefix`: prefix-based defaults for groups of methods, e.g.:\n        {\n          "rate_limit": {\n            "method_limits_prefix": {\n              "/debvisor.StorageService/": { "window_seconds": 60, "max_calls": 30 },\n              "/debvisor.MigrationService/": { "window_seconds": 60, "max_calls": 40 }\n            }\n          }\n        }\n\n- `method_limits_patterns`: regex-based matching for automatic stricter limits on mutating RPCs, e.g.:\n        {\n          "rate_limit": {\n            "method_limits_patterns": [\n              { "pattern": "/debvisor\\.[A-Za-z]+Service/(Create|Delete|Update|Migrate|Plan)$", "window_seconds": 60, "max_calls": 20 }\n            ]\n          }\n        }\n\n- Implemented by `RateLimitingInterceptor` in `opt/services/rpc/server.py`.\n## License (7)\nApache License Version 2.0, January 2004 `license.md`\n## Monitoring (7)\n- Health dashboards: see `docs/monitoring-health-detail.md` for Prometheus/Grafana setup using `/health/detail`.\n\n- Metrics: expose Prometheus metrics at `/metrics`.\n\n- *Full Documentation**: [docs/SUPPLY_CHAIN_SECURITY.md](docs/SUPPLY_CHAIN_SECURITY.md)\n\n- --\n## Network Configuration (8)\n- **Management:** See [etc/README.md](etc/README.md) for customization and monitoring\n### Blocklist Management (8)\n- **Validation:** `etc/debvisor/validate-blocklists.sh` (CIDR syntax, overlap detection)\n\n- **Integrity:** `etc/debvisor/verify-blocklist-integrity.sh` (checksums, format verification)\n\n- **Examples:** `blocklist-example.txt`, `blocklist-whitelist-example.txt`\n\n- **Testing:** GitHub Actions validates all blocklists on commit\n\n- **Details:** See [etc/debvisor/](etc/debvisor/) for configuration formats and usage\n### Production Deployment Checklist (8)\n- [ ] Enable maintenance timers: `systemctl enable ceph-health.timer zfs-scrub-weekly.timer`\n\n- [ ] Configure ZFS timeout for your pool size in `/etc/default/debvisor-zfs-scrub`\n\n- [ ] Customize timer schedules if not aligned with your maintenance window\n\n- [ ] Set up log aggregation or alerts for service failures\n\n- [ ] For multi-node clusters, stagger scrub schedules to prevent simultaneous I/O\n\n- [ ] Test manual execution: `systemctl start zfs-scrub-weekly.service`\n\n- [ ] Monitor service logs during first automated run\n### Modes (8)\n- `/etc/debvisor-mode` controls behavior:\n\n- `lab`(default): ensures`root`,`node`,`monitor` users exist (non-root locked), convenience defaults.\n\n- `prod`: only ensures`root` user; create additional accounts via your own workflow.\n### Addons (8)\n- Global config: `/etc/debvisor-addons.conf` with flags:\n\n- `ADDON_RPC_SERVICE`,`ADDON_WEB_PANEL`,`ADDON_VNC_CONSOLE`,`ADDON_MONITORING_STACK`(`yes`/`no`).\n\n- Profile defaults: `/etc/debvisor-addons.d/.conf` provide sensible per-profile defaults if no global file exists.\n\n- On first boot, an Ansible playbook (`bootstrap-addons.yml`) runs locally (when present) to apply addon roles:\n\n- `rpc-service`,`web-panel`,`vnc-console`,`monitoring-stack` (shipped as safe stubs you can extend).\n### Dry Run (8)\n- You can test the first boot logic non-destructively with:\n\n- `debvisor-firstboot.sh --dry-run`\n\n- In dry-run mode, provisioning steps only log intended actions; no disks/users/services are modified.\n## Improvements & Operational Excellence (8)\nDebVisor includes comprehensive improvements across all system components to ensure production-readiness:\n### Phase 1: Documentation & Configuration (? Complete) (8)\n- Enhanced systemd unit files with timeout protection, retry logic, and security sandboxing\n\n- Comprehensive README files for `etc/`,`opt/`, and`usr/` directories\n\n- Production deployment checklists and troubleshooting guides\n\n- ZFS pool sizing formulas and multi-pool configuration support\n\n- See [SESSION_COMPLETION_REPORT.md](SESSION_COMPLETION_REPORT.md) for details\n### Phase 2: Operational Scripts & CI/CD (? Complete) (8)\n- **Shared bash library** (`usr/local/bin/debvisor-lib.sh`) with 50+ reusable functions\n\n- Consistent logging, error handling, retry logic\n\n- Infrastructure validation (Ceph, Kubernetes, ZFS)\n\n- Safe operation patterns (dry-run, confirm, execute)\n\n- **Enhanced scripts** with `--dry-run`, `--check`, `--verbose` modes\n\n- `debvisor-join.sh`: Join nodes to cluster with comprehensive validation\n\n- `debvisor-upgrade.sh`: Orchestrated cluster upgrades with checkpoints\n\n- Full audit logging and error recovery\n\n- **CI/CD validation workflow** (`.github/workflows/validate-syntax.yml`)`)\n\n- systemd unit validation with `systemd-analyze`\n\n- Shell script linting with `shellcheck`\n\n- Ansible playbook syntax checking\n\n- Cross-component consistency validation\n\n- **Component validator** (`opt/validate-components.sh`)\n\n- Validates Ansible inventory, package lists, Docker addons\n\n- Checks file permissions and executable status\n\n- Optional auto-fix for common issues\nSee [PHASE_2_SUMMARY.md](PHASE_2_SUMMARY.md) for implementation details and usage examples.\n### Phase 3: RPC Service & Web Panel (Planned) (8)\n- gRPC service implementation with authentication, authorization, TLS\n\n- Web management panel with security hardening\n\n- Integration tests and advanced monitoring\n\n- --\n## Contributing (8)\n1. Propose doc changes in `docs/`\n\n1. Use the shared library (`debvisor-lib.sh`) in new scripts for consistency\n\n1. All scripts should support `--dry-run`,`--check`,`--verbose`,`--log-file` flags\n\n1. Include comprehensive error handling and audit logging\n\n1. Keep scripts idempotent and non-destructive beyond initial provisioning\n\n1. Avoid embedding passwords/keys; rely on installer prompts & environment variables\n\n1. Run validation before submitting: `opt/validate-components.sh`\n## Roadmap (High-Level) (8)\n- Cluster expansion scripts (join additional nodes for Ceph + K8s)\n\n- Ceph CSI & ZFS LocalPV Helm charts under `docker\addons\`\n\n- Metrics stack (Prometheus/Grafana) profile\n\n- Upgrade orchestration (Ansible playbooks)\n## Rate Limiting (8)\n- Web Panel (Flask):\n\n- Set a global default via `RATELIMIT_DEFAULT` in the Flask config (e.g., `"100 per minute"`).\n\n- Use `@limiter.limit("<N> per <period>")` per route for granular control (see `opt/web/panel/routes/auth.py`).\n\n- Login/Register routes include per-IP and per-user limits with lightweight backoff.\n\n- RPC Server (gRPC):\n\n- Configure `/etc/debvisor/rpc/config.json` -> `rate_limit` block:\n\n- `window_seconds`: sliding window duration (seconds)\n\n- `max_calls`: max calls per principal per method within the window\n\n- `method_limits`: per-method overrides, e.g.:\n        {\n          "rate_limit": {\n            "window_seconds": 60,\n            "max_calls": 120,\n            "method_limits": {\n              "/debvisor.StorageService/CreateSnapshot": { "window_seconds": 60, "max_calls": 30 },\n              "/debvisor.StorageService/DeleteSnapshot": { "window_seconds": 60, "max_calls": 20 }\n            }\n          }\n        }\n\n- `method_limits_prefix`: prefix-based defaults for groups of methods, e.g.:\n        {\n          "rate_limit": {\n            "method_limits_prefix": {\n              "/debvisor.StorageService/": { "window_seconds": 60, "max_calls": 30 },\n              "/debvisor.MigrationService/": { "window_seconds": 60, "max_calls": 40 }\n            }\n          }\n        }\n\n- `method_limits_patterns`: regex-based matching for automatic stricter limits on mutating RPCs, e.g.:\n        {\n          "rate_limit": {\n            "method_limits_patterns": [\n              { "pattern": "/debvisor\\.[A-Za-z]+Service/(Create|Delete|Update|Migrate|Plan)$", "window_seconds": 60, "max_calls": 20 }\n            ]\n          }\n        }\n\n- Implemented by `RateLimitingInterceptor` in `opt/services/rpc/server.py`.\n## License (8)\nApache License Version 2.0, January 2004 `license.md`\n## Monitoring (8)\n- Health dashboards: see `docs/monitoring-health-detail.md` for Prometheus/Grafana setup using `/health/detail`.\n\n- Metrics: expose Prometheus metrics at `/metrics`.\n
